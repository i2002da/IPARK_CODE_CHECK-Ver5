<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë‚´ì—­ ì½”ë“œ ì²´í¬ ì‹œìŠ¤í…œ</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=JetBrains+Mono:wght@400;700&display=swap');

  :root {
    --bg: #0d0f14;
    --surface: #141820;
    --surface2: #1c2230;
    --border: #252d3d;
    --accent: #3b82f6;
    --accent2: #22d3ee;
    --warn: #f59e0b;
    --danger: #ef4444;
    --success: #10b981;
    --purple: #a855f7;
    --text: #e2e8f0;
    --text-dim: #64748b;
    --text-muted: #94a3b8;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Noto Sans KR', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(59,130,246,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(59,130,246,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  .container { max-width: 1700px; margin: 0 auto; padding: 24px; position: relative; z-index: 1; }

  header {
    display: flex; align-items: center; gap: 14px;
    margin-bottom: 28px; padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
  }
  .logo {
    width: 42px; height: 42px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 20px; flex-shrink: 0;
  }
  h1 { font-size: 20px; font-weight: 700; letter-spacing: -0.5px; }
  h1 span { color: var(--accent); }
  .subtitle { font-size: 11px; color: var(--text-dim); margin-top: 2px; font-family: 'JetBrains Mono', monospace; }

  /* Upload grid */
  .upload-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin-bottom: 20px;
  }

  .upload-card {
    background: var(--surface);
    border: 1.5px dashed var(--border);
    border-radius: 10px;
    padding: 16px 14px;
    cursor: pointer;
    position: relative;
    transition: border-color 0.2s, background 0.2s;
  }
  .upload-card:hover, .upload-card.drag-over {
    border-color: var(--accent);
    background: rgba(59,130,246,0.05);
  }
  .upload-card.loaded { border-style: solid; }
  .upload-card.c-blue   { border-color: var(--accent); }
  .upload-card.c-green  { border-color: var(--success); }
  .upload-card.c-warn   { border-color: var(--warn); }
  .upload-card.c-purple { border-color: var(--purple); }

  .upload-card input[type="file"] {
    position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%;
  }

  .uc-head { display: flex; align-items: center; gap: 7px; margin-bottom: 5px; }
  .uc-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
  .d-blue   { background: var(--accent); }
  .d-green  { background: var(--success); }
  .d-warn   { background: var(--warn); }
  .d-purple { background: var(--purple); }
  .uc-label { font-size: 12px; font-weight: 700; }

  .uc-badge {
    margin-left: auto;
    padding: 2px 7px; border-radius: 10px;
    font-size: 10px; font-weight: 600;
  }
  .req  { background: rgba(239,68,68,0.15); color: var(--danger); }
  .opt  { background: rgba(100,116,139,0.12); color: var(--text-dim); }

  .uc-desc { font-size: 11px; color: var(--text-dim); margin-bottom: 8px; }
  .uc-fn {
    font-size: 11px; color: var(--text-dim);
    font-family: 'JetBrains Mono', monospace;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .uc-fn.ok { color: var(--success); }

  /* Action bar */
  .action-bar {
    display: flex; align-items: center; gap: 10px;
    margin-bottom: 20px; flex-wrap: wrap;
  }
  .vsep { width: 1px; height: 28px; background: var(--border); }

  .btn {
    padding: 9px 18px; border-radius: 8px;
    font-size: 13px; font-weight: 600;
    font-family: 'Noto Sans KR', sans-serif;
    border: none; cursor: pointer;
    transition: all 0.15s;
    display: flex; align-items: center; gap: 6px;
    white-space: nowrap;
  }
  .btn:disabled { opacity: 0.35; cursor: not-allowed; transform: none !important; }

  .btn-blue   { background: var(--accent);  color: white; }
  .btn-blue:not(:disabled):hover   { background: #2563eb; transform: translateY(-1px); }
  .btn-purple { background: var(--purple);  color: white; }
  .btn-purple:not(:disabled):hover { background: #9333ea; transform: translateY(-1px); }
  .btn-outline {
    background: transparent; color: var(--text-muted);
    border: 1px solid var(--border);
  }
  .btn-outline:not(:disabled):hover { border-color: var(--accent); color: var(--accent); }

  /* Mode tabs */
  .mode-tabs {
    display: flex; gap: 0;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 10px; padding: 4px;
    width: fit-content; margin-bottom: 16px;
  }
  .mode-tab {
    padding: 7px 18px; border-radius: 7px;
    font-size: 12px; font-weight: 600;
    font-family: 'Noto Sans KR', sans-serif;
    border: none; cursor: pointer;
    background: transparent; color: var(--text-dim);
    transition: all 0.15s;
  }
  .tab-blue   { background: var(--accent); color: white; }
  .tab-purple { background: var(--purple); color: white; }

  /* Stats */
  .stats-bar { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; }
  .stat-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 8px; padding: 10px 14px; min-width: 110px;
  }
  .stat-label { font-size: 10px; color: var(--text-dim); margin-bottom: 4px; letter-spacing: 0.5px; text-transform: uppercase; }
  .stat-val { font-size: 22px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
  .v-blue   { color: var(--accent); }
  .v-green  { color: var(--success); }
  .v-yellow { color: var(--warn); }
  .v-red    { color: var(--danger); }
  .v-cyan   { color: var(--accent2); }
  .v-purple { color: var(--purple); }

  /* Filter bar */
  .filter-bar {
    display: flex; gap: 8px; margin-bottom: 12px;
    flex-wrap: wrap; align-items: center;
  }
  .fbtn {
    padding: 5px 12px; border-radius: 20px;
    font-size: 11px; font-weight: 600;
    font-family: 'Noto Sans KR', sans-serif;
    border: 1px solid var(--border);
    background: transparent; color: var(--text-muted);
    cursor: pointer; transition: all 0.15s;
  }
  .fbtn:hover { border-color: var(--accent); color: var(--accent); }
  .fa-all    { background: var(--accent);   border-color: var(--accent);   color: white; }
  .fa-ok     { background: var(--success);  border-color: var(--success);  color: white; }
  .fa-diff   { background: var(--warn);     border-color: var(--warn);     color: white; }
  .fa-miss   { background: var(--danger);   border-color: var(--danger);   color: white; }
  .fa-nocode { background: var(--text-dim); border-color: var(--text-dim); color: white; }
  .fa-only1  { background: var(--accent);   border-color: var(--accent);   color: white; }
  .fa-only2  { background: var(--purple);   border-color: var(--purple);   color: white; }
  .fa-both   { background: var(--success);  border-color: var(--success);  color: white; }

  .search-input {
    padding: 5px 12px; background: var(--surface);
    border: 1px solid var(--border); border-radius: 8px;
    color: var(--text); font-size: 12px;
    font-family: 'Noto Sans KR', sans-serif;
    width: 200px; outline: none; margin-left: auto;
  }
  .search-input:focus { border-color: var(--accent); }

  /* Hint box */
  .hint-box {
    background: rgba(168,85,247,0.06); border: 1px solid rgba(168,85,247,0.2);
    border-radius: 8px; padding: 10px 14px;
    font-size: 11px; color: var(--text-muted);
    margin-bottom: 12px; line-height: 1.8;
  }
  .hint-box b { color: var(--purple); }

  /* Table */
  .table-wrapper {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 10px; overflow: hidden;
  }
  .table-scroll { max-height: 60vh; overflow-y: auto; }
  .table-scroll::-webkit-scrollbar { width: 5px; }
  .table-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  table { width: 100%; border-collapse: collapse; font-size: 12px; }
  thead tr { background: var(--surface2); }
  th {
    padding: 9px 12px; text-align: left;
    font-size: 10px; font-weight: 700; color: var(--text-dim);
    letter-spacing: 0.6px; text-transform: uppercase; white-space: nowrap;
    position: sticky; top: 0; background: var(--surface2); z-index: 10;
    border-bottom: 1px solid var(--border);
  }
  tbody tr { border-bottom: 1px solid rgba(37,45,61,0.5); transition: background 0.1s; }
  tbody tr:hover { background: rgba(59,130,246,0.04); }
  tbody tr:last-child { border-bottom: none; }
  td { padding: 8px 12px; vertical-align: middle; }

  .tc   { font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--accent2); white-space: nowrap; }
  .tn   { font-weight: 500; }
  .ts   { color: var(--text-muted); font-size: 11px; }
  .tu   { color: var(--text-dim); font-size: 11px; text-align: center; }
  .tr   { color: var(--text-dim); font-size: 10px; font-family: 'JetBrains Mono', monospace; text-align: center; }
  .hl   { color: var(--warn); }

  tr.sec-row td {
    background: rgba(59,130,246,0.07);
    color: var(--accent); font-weight: 700; font-size: 11px;
    border-bottom: 1px solid rgba(59,130,246,0.15);
  }

  .badge {
    display: inline-flex; align-items: center; gap: 3px;
    padding: 2px 8px; border-radius: 4px;
    font-size: 10px; font-weight: 700; white-space: nowrap;
  }
  .bk  { background: rgba(16,185,129,0.15);  color: var(--success); }
  .bd  { background: rgba(245,158,11,0.15);   color: var(--warn); }
  .bm  { background: rgba(239,68,68,0.15);    color: var(--danger); }
  .bn  { background: rgba(100,116,139,0.1);   color: var(--text-muted); }
  .b1  { background: rgba(59,130,246,0.15);   color: var(--accent); }
  .b2  { background: rgba(168,85,247,0.15);   color: var(--purple); }
  .bb  { background: rgba(16,185,129,0.15);   color: var(--success); }

  .loading {
    display: flex; align-items: center; justify-content: center;
    padding: 60px; gap: 12px; color: var(--text-dim); font-size: 14px;
  }
  .spin {
    width: 18px; height: 18px;
    border: 2px solid var(--border); border-top-color: var(--accent);
    border-radius: 50%; animation: spin 0.7s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .empty {
    padding: 70px; text-align: center; color: var(--text-dim);
  }
  .empty .ico { font-size: 42px; margin-bottom: 12px; }
  .empty p { font-size: 13px; line-height: 1.9; }

  /* â”€â”€ Login Overlay â”€â”€ */
  #loginOverlay {
    position: fixed; inset: 0; z-index: 9999;
    background: var(--bg);
    display: flex; align-items: center; justify-content: center;
  }
  #loginOverlay::before {
    content: '';
    position: fixed; inset: 0;
    background-image:
      linear-gradient(rgba(59,130,246,0.04) 1px, transparent 1px),
      linear-gradient(90deg, rgba(59,130,246,0.04) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
  }
  .login-box {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; padding: 40px 36px;
    width: 380px; position: relative; z-index: 1;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  }
  .login-logo {
    width: 52px; height: 52px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border-radius: 14px;
    display: flex; align-items: center; justify-content: center;
    font-size: 24px; margin: 0 auto 20px;
  }
  .login-title {
    text-align: center; font-size: 18px; font-weight: 700;
    margin-bottom: 4px;
  }
  .login-title span { color: var(--accent); }
  .login-sub {
    text-align: center; font-size: 11px; color: var(--text-dim);
    font-family: 'JetBrains Mono', monospace; margin-bottom: 28px;
  }
  .login-field { margin-bottom: 14px; }
  .login-field label {
    display: block; font-size: 11px; font-weight: 600;
    color: var(--text-muted); margin-bottom: 6px; letter-spacing: 0.4px;
  }
  .login-field input {
    width: 100%; padding: 10px 14px;
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 8px; color: var(--text); font-size: 13px;
    font-family: 'Noto Sans KR', sans-serif; outline: none;
    transition: border-color 0.2s;
  }
  .login-field input:focus { border-color: var(--accent); }
  .login-error {
    font-size: 11px; color: var(--danger);
    text-align: center; margin-bottom: 10px; min-height: 16px;
  }
  .btn-login {
    width: 100%; padding: 11px; border-radius: 8px;
    background: var(--accent); color: white;
    font-size: 13px; font-weight: 700;
    font-family: 'Noto Sans KR', sans-serif;
    border: none; cursor: pointer; margin-top: 6px;
    transition: background 0.15s, transform 0.15s;
  }
  .btn-login:hover { background: #2563eb; transform: translateY(-1px); }

  /* â”€â”€ User Management Modal â”€â”€ */
  #userMgmtModal {
    position: fixed; inset: 0; z-index: 8888;
    background: rgba(0,0,0,0.7);
    display: none; align-items: center; justify-content: center;
    padding: 20px;
  }
  #userMgmtModal.open { display: flex; }
  .mgmt-box {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; padding: 32px 36px;
    width: min(820px, 100%); max-height: 88vh;
    display: flex; flex-direction: column;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  }
  .mgmt-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 24px; flex-shrink: 0;
  }
  .mgmt-header h2 { font-size: 16px; font-weight: 700; }
  .mgmt-close {
    background: transparent; border: 1px solid var(--border);
    color: var(--text-muted); border-radius: 6px;
    width: 30px; height: 30px; cursor: pointer; font-size: 15px;
    display: flex; align-items: center; justify-content: center;
    transition: border-color 0.15s, color 0.15s; flex-shrink: 0;
  }
  .mgmt-close:hover { border-color: var(--danger); color: var(--danger); }

  /* ì¶”ê°€ í¼ â€” 2í–‰ ê·¸ë¦¬ë“œ */
  .mgmt-add-form {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 8px;
    margin-bottom: 8px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }
  .mgmt-add-form input {
    padding: 9px 13px;
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 8px; color: var(--text); font-size: 12px;
    font-family: 'Noto Sans KR', sans-serif; outline: none;
    transition: border-color 0.2s; width: 100%;
  }
  .mgmt-add-form input:focus { border-color: var(--accent); }
  .mgmt-add-form input::placeholder { color: var(--text-dim); }
  .mgmt-add-btn-row {
    grid-column: 1 / -1;
    display: flex; justify-content: flex-end;
  }
  .btn-add-user {
    padding: 9px 22px; border-radius: 8px;
    background: var(--success); color: white;
    font-size: 12px; font-weight: 700;
    font-family: 'Noto Sans KR', sans-serif;
    border: none; cursor: pointer; white-space: nowrap;
    transition: background 0.15s, transform 0.15s;
  }
  .btn-add-user:hover { background: #059669; transform: translateY(-1px); }

  /* ì‚¬ìš©ì ëª©ë¡ */
  .user-list {
    display: flex; flex-direction: column; gap: 7px;
    overflow-y: auto; flex: 1;
    padding-right: 4px;
  }
  .user-list::-webkit-scrollbar { width: 4px; }
  .user-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .user-list-header {
    display: grid;
    grid-template-columns: 64px 110px 110px 80px 1fr auto auto;
    gap: 10px;
    padding: 6px 14px;
    font-size: 10px; font-weight: 700;
    color: var(--text-dim); letter-spacing: 0.5px;
    text-transform: uppercase; flex-shrink: 0;
  }
  .user-item {
    display: grid;
    grid-template-columns: 64px 110px 110px 80px 1fr auto auto;
    align-items: center; gap: 10px;
    padding: 11px 14px; background: var(--surface2);
    border: 1px solid var(--border); border-radius: 9px;
    transition: border-color 0.15s;
  }
  .user-item:hover { border-color: rgba(59,130,246,0.3); }
  .user-item .u-role {
    font-size: 10px; font-weight: 700; padding: 3px 8px;
    border-radius: 4px; white-space: nowrap; text-align: center;
  }
  .role-master { background: rgba(245,158,11,0.15); color: var(--warn); }
  .role-user   { background: rgba(59,130,246,0.15);  color: var(--accent); }
  .u-id   { font-size: 12px; font-weight: 600; font-family: 'JetBrains Mono', monospace; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .u-name { font-size: 12px; color: var(--text-muted); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .u-pw   { font-size: 11px; color: var(--text-dim); font-family: 'JetBrains Mono', monospace; letter-spacing: 2px; }
  .u-status {
    font-size: 10px; padding: 3px 10px; border-radius: 10px;
    font-weight: 600; white-space: nowrap; text-align: center;
  }
  .s-active   { background: rgba(16,185,129,0.12); color: var(--success); }
  .s-inactive { background: rgba(239,68,68,0.12);  color: var(--danger); }

  .btn-toggle-status {
    padding: 5px 12px; border-radius: 6px; font-size: 11px; font-weight: 600;
    font-family: 'Noto Sans KR', sans-serif; border: 1px solid var(--border);
    background: transparent; color: var(--text-muted); cursor: pointer;
    transition: all 0.15s; white-space: nowrap;
  }
  .btn-toggle-status:hover { border-color: var(--warn); color: var(--warn); background: rgba(245,158,11,0.06); }
  .btn-del-user {
    padding: 5px 12px; border-radius: 6px; font-size: 11px; font-weight: 600;
    font-family: 'Noto Sans KR', sans-serif; border: 1px solid var(--border);
    background: transparent; color: var(--text-muted); cursor: pointer;
    transition: all 0.15s; white-space: nowrap;
  }
  .btn-del-user:hover { border-color: var(--danger); color: var(--danger); background: rgba(239,68,68,0.06); }
  .mgmt-protected { font-size: 10px; color: var(--text-dim); padding: 0 4px; white-space: nowrap; grid-column: span 2; text-align: right; }

  /* â”€â”€ Header user info â”€â”€ */
  .header-user {
    margin-left: auto; display: flex; align-items: center; gap: 10px;
  }
  .user-badge {
    display: flex; align-items: center; gap: 7px;
    padding: 6px 12px; background: var(--surface2);
    border: 1px solid var(--border); border-radius: 8px; font-size: 12px;
  }
  .user-dot {
    width: 7px; height: 7px; border-radius: 50%;
    background: var(--success);
  }
  .btn-logout {
    padding: 6px 12px; border-radius: 7px;
    background: transparent; color: var(--text-muted);
    border: 1px solid var(--border); font-size: 11px; font-weight: 600;
    font-family: 'Noto Sans KR', sans-serif; cursor: pointer;
    transition: all 0.15s;
  }
  .btn-logout:hover { border-color: var(--danger); color: var(--danger); }
  .btn-user-mgmt {
    padding: 6px 12px; border-radius: 7px;
    background: rgba(245,158,11,0.1); color: var(--warn);
    border: 1px solid rgba(245,158,11,0.25); font-size: 11px; font-weight: 600;
    font-family: 'Noto Sans KR', sans-serif; cursor: pointer;
    transition: all 0.15s;
  }
  .btn-user-mgmt:hover { background: rgba(245,158,11,0.2); }

  /* â”€â”€ Google Drive â”€â”€ */
  .gdrive-bar {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 14px; margin-bottom: 12px;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 10px; flex-wrap: wrap;
  }
  .gdrive-bar .gd-label {
    font-size: 11px; font-weight: 700; color: var(--text-muted);
    display: flex; align-items: center; gap: 6px; white-space: nowrap;
  }
  .gdrive-bar .gd-label svg { flex-shrink: 0; }
  .gdrive-status {
    font-size: 11px; display: flex; align-items: center; gap: 5px;
  }
  .gd-dot {
    width: 7px; height: 7px; border-radius: 50%;
    background: var(--text-dim); flex-shrink: 0;
  }
  .gd-dot.connected { background: var(--success); }
  .btn-gd-connect {
    padding: 6px 14px; border-radius: 7px; font-size: 11px; font-weight: 600;
    font-family: 'Noto Sans KR', sans-serif; cursor: pointer; white-space: nowrap;
    border: 1px solid rgba(66,133,244,0.4);
    background: rgba(66,133,244,0.08); color: #6ba3ff;
    transition: all 0.15s;
  }
  .btn-gd-connect:hover { background: rgba(66,133,244,0.18); border-color: #6ba3ff; }
  .btn-gd-disconnect {
    padding: 5px 12px; border-radius: 7px; font-size: 11px; font-weight: 600;
    font-family: 'Noto Sans KR', sans-serif; cursor: pointer; white-space: nowrap;
    border: 1px solid var(--border); background: transparent; color: var(--text-dim);
    transition: all 0.15s;
  }
  .btn-gd-disconnect:hover { border-color: var(--danger); color: var(--danger); }
  .gd-user-info { font-size: 11px; color: var(--text-muted); }
  .gd-sep { width: 1px; height: 18px; background: var(--border); flex-shrink: 0; }

  /* upload card ì— Drive ë²„íŠ¼ */
  .btn-from-drive {
    position: relative; z-index: 2;
    margin-top: 6px; padding: 4px 10px; border-radius: 5px;
    font-size: 10px; font-weight: 600;
    font-family: 'Noto Sans KR', sans-serif; cursor: pointer;
    border: 1px solid rgba(66,133,244,0.35);
    background: rgba(66,133,244,0.07); color: #6ba3ff;
    transition: all 0.15s; display: none; align-items: center; gap: 4px;
  }
  .btn-from-drive.visible { display: inline-flex; }
  .btn-from-drive:hover { background: rgba(66,133,244,0.18); }

  /* Drive íŒŒì¼ ì„ íƒ ëª¨ë‹¬ */
  #drivePickerModal {
    position: fixed; inset: 0; z-index: 9100;
    background: rgba(0,0,0,0.75);
    display: none; align-items: center; justify-content: center; padding: 20px;
  }
  #drivePickerModal.open { display: flex; }
  .dpick-box {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; padding: 28px 30px;
    width: min(680px,100%); max-height: 85vh;
    display: flex; flex-direction: column;
    box-shadow: 0 20px 60px rgba(0,0,0,0.6);
  }
  .dpick-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 6px; flex-shrink: 0;
  }
  .dpick-header h3 { font-size: 15px; font-weight: 700; }
  .dpick-sub {
    font-size: 11px; color: var(--text-dim); margin-bottom: 14px;
    font-family: 'JetBrains Mono', monospace; flex-shrink: 0;
  }
  .dpick-search {
    display: flex; gap: 8px; margin-bottom: 12px; flex-shrink: 0;
  }
  .dpick-search input {
    flex: 1; padding: 8px 12px;
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 8px; color: var(--text); font-size: 12px;
    font-family: 'Noto Sans KR', sans-serif; outline: none;
    transition: border-color 0.2s;
  }
  .dpick-search input:focus { border-color: var(--accent); }
  .dpick-list {
    flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 5px;
    padding-right: 4px;
  }
  .dpick-list::-webkit-scrollbar { width: 4px; }
  .dpick-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
  .dpick-item {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 12px; background: var(--surface2);
    border: 1px solid var(--border); border-radius: 8px;
    cursor: pointer; transition: border-color 0.15s, background 0.15s;
  }
  .dpick-item:hover { border-color: var(--accent); background: rgba(59,130,246,0.05); }
  .dpick-item.selected { border-color: var(--accent); background: rgba(59,130,246,0.1); }
  .dpick-icon { font-size: 18px; flex-shrink: 0; }
  .dpick-name { font-size: 12px; font-weight: 500; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .dpick-size { font-size: 10px; color: var(--text-dim); white-space: nowrap; }
  .dpick-date { font-size: 10px; color: var(--text-dim); white-space: nowrap; }
  .dpick-empty { text-align: center; padding: 40px; color: var(--text-dim); font-size: 13px; }
  .dpick-loading { text-align: center; padding: 40px; color: var(--text-dim); font-size: 13px; display: flex; align-items: center; justify-content: center; gap: 10px; }
  .dpick-footer {
    display: flex; align-items: center; justify-content: space-between;
    margin-top: 14px; flex-shrink: 0; gap: 8px;
  }
  .dpick-selected-name { font-size: 11px; color: var(--accent); font-weight: 600; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .btn-dpick-ok {
    padding: 9px 22px; border-radius: 8px; background: var(--accent); color: white;
    font-size: 12px; font-weight: 700; font-family: 'Noto Sans KR', sans-serif;
    border: none; cursor: pointer; white-space: nowrap; transition: all 0.15s;
  }
  .btn-dpick-ok:disabled { opacity: 0.35; cursor: not-allowed; }
  .btn-dpick-ok:not(:disabled):hover { background: #2563eb; transform: translateY(-1px); }
  .btn-dpick-cancel {
    padding: 9px 16px; border-radius: 8px; background: transparent;
    color: var(--text-muted); border: 1px solid var(--border);
    font-size: 12px; font-weight: 600; font-family: 'Noto Sans KR', sans-serif;
    cursor: pointer; transition: all 0.15s;
  }
  .btn-dpick-cancel:hover { border-color: var(--danger); color: var(--danger); }

  /* GCP ì„¤ì • ëª¨ë‹¬ */
  #gcpSetupModal {
    position: fixed; inset: 0; z-index: 9200;
    background: rgba(0,0,0,0.8); display: none;
    align-items: center; justify-content: center; padding: 20px;
  }
  #gcpSetupModal.open { display: flex; }
  .gcp-box {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; padding: 32px 34px; width: min(520px,100%);
    box-shadow: 0 20px 60px rgba(0,0,0,0.6);
  }
  .gcp-box h3 { font-size: 15px; font-weight: 700; margin-bottom: 6px; }
  .gcp-box p  { font-size: 11px; color: var(--text-muted); margin-bottom: 20px; line-height: 1.7; }
  .gcp-field  { margin-bottom: 14px; }
  .gcp-field label { display: block; font-size: 11px; font-weight: 600; color: var(--text-muted); margin-bottom: 5px; }
  .gcp-field input {
    width: 100%; padding: 9px 13px;
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 8px; color: var(--text); font-size: 12px;
    font-family: 'JetBrains Mono', monospace; outline: none;
    transition: border-color 0.2s;
  }
  .gcp-field input:focus { border-color: var(--accent); }
  .gcp-hint { font-size: 10px; color: var(--text-dim); margin-top: 4px; line-height: 1.6; }
  .gcp-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px; }

  /* â”€â”€ Change Password button in header â”€â”€ */
  .btn-chgpw {
    padding: 6px 12px; border-radius: 7px;
    background: rgba(34,211,238,0.08); color: var(--accent2);
    border: 1px solid rgba(34,211,238,0.25); font-size: 11px; font-weight: 600;
    font-family: 'Noto Sans KR', sans-serif; cursor: pointer;
    transition: all 0.15s;
  }
  .btn-chgpw:hover { background: rgba(34,211,238,0.18); }

  /* â”€â”€ Change Password Modal â”€â”€ */
  #chgPwModal {
    position: fixed; inset: 0; z-index: 9000;
    background: rgba(0,0,0,0.72);
    display: none; align-items: center; justify-content: center;
  }
  #chgPwModal.open { display: flex; }
  .chgpw-box {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 14px; padding: 32px 30px;
    width: 360px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.55);
    position: relative;
  }
  .chgpw-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 22px;
  }
  .chgpw-header h2 { font-size: 15px; font-weight: 700; }
  .chgpw-who {
    font-size: 11px; color: var(--text-dim); margin-bottom: 18px;
    padding: 8px 12px; background: var(--surface2);
    border: 1px solid var(--border); border-radius: 7px;
    font-family: 'JetBrains Mono', monospace;
  }
  .chgpw-field { margin-bottom: 13px; }
  .chgpw-field label {
    display: block; font-size: 11px; font-weight: 600;
    color: var(--text-muted); margin-bottom: 5px; letter-spacing: 0.4px;
  }
  .chgpw-field input {
    width: 100%; padding: 9px 13px;
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 7px; color: var(--text); font-size: 13px;
    font-family: 'Noto Sans KR', sans-serif; outline: none;
    transition: border-color 0.2s;
  }
  .chgpw-field input:focus { border-color: var(--accent2); }
  .chgpw-field input.input-err { border-color: var(--danger); }
  .chgpw-field input.input-ok  { border-color: var(--success); }
  .chgpw-error {
    font-size: 11px; color: var(--danger);
    min-height: 16px; margin-bottom: 10px; text-align: center;
  }
  .chgpw-success {
    font-size: 12px; color: var(--success);
    text-align: center; padding: 10px;
    background: rgba(16,185,129,0.08); border: 1px solid rgba(16,185,129,0.2);
    border-radius: 7px; margin-bottom: 12px; display: none;
  }
  .pw-strength {
    height: 3px; border-radius: 2px; margin-top: 5px;
    background: var(--border); transition: all 0.3s;
    overflow: hidden;
  }
  .pw-strength-bar {
    height: 100%; border-radius: 2px; width: 0;
    transition: width 0.3s, background 0.3s;
  }
  .pw-strength-label {
    font-size: 10px; color: var(--text-dim); margin-top: 3px;
    min-height: 14px;
  }
  .btn-save-pw {
    width: 100%; padding: 10px; border-radius: 8px;
    background: var(--accent2); color: #0d0f14;
    font-size: 13px; font-weight: 700;
    font-family: 'Noto Sans KR', sans-serif;
    border: none; cursor: pointer;
    transition: background 0.15s, transform 0.15s;
  }
  .btn-save-pw:hover { background: #06b6d4; transform: translateY(-1px); }
  .btn-save-pw:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

  /* masterê°€ íƒ€ì¸ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½í•  ë•Œ ì“°ëŠ” select */
  .chgpw-target-row {
    display: flex; align-items: center; gap: 8px; margin-bottom: 14px;
  }
  .chgpw-target-row label {
    font-size: 11px; font-weight: 600; color: var(--text-muted);
    white-space: nowrap;
  }
  .chgpw-target-row select {
    flex: 1; padding: 8px 10px;
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 7px; color: var(--text); font-size: 12px;
    font-family: 'JetBrains Mono', monospace; outline: none;
    transition: border-color 0.2s; cursor: pointer;
  }
  .chgpw-target-row select:focus { border-color: var(--accent2); }
  .chgpw-tab-row {
    display: flex; gap: 6px; margin-bottom: 16px;
  }
  .chgpw-tab {
    flex: 1; padding: 7px; border-radius: 7px;
    font-size: 11px; font-weight: 600;
    font-family: 'Noto Sans KR', sans-serif;
    border: 1px solid var(--border);
    background: transparent; color: var(--text-dim);
    cursor: pointer; transition: all 0.15s; text-align: center;
  }
  .chgpw-tab.active-self   { background: var(--accent2); border-color: var(--accent2); color: #0d0f14; }
  .chgpw-tab.active-other  { background: var(--warn);    border-color: var(--warn);    color: #0d0f14; }
  .chgpw-tab:not(.active-self):not(.active-other):hover { border-color: var(--accent2); color: var(--accent2); }
</style>
</head>
<body>

<!-- â”€â”€ Google Drive íŒŒì¼ ì„ íƒ ëª¨ë‹¬ â”€â”€ -->
<div id="drivePickerModal">
  <div class="dpick-box">
    <div class="dpick-header">
      <h3>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="vertical-align:-3px;margin-right:6px">
          <path d="M6.5 20L1 11l4.5-8h13L23 11l-5.5 9H6.5z" fill="#4285F4" opacity=".3"/>
          <path d="M1 11l5.5 9h13L23 11H1z" fill="#4285F4" opacity=".15"/>
          <path d="M8.5 3L1 11h7l4-8-3.5 0z" fill="#0F9D58"/>
          <path d="M15.5 3L23 11h-7l-4-8 3.5 0z" fill="#FBBC05"/>
          <path d="M8 11l4 9 4-9H8z" fill="#EA4335"/>
        </svg>
        Google Driveì—ì„œ ì„ íƒ
      </h3>
      <button class="mgmt-close" onclick="closeDrivePicker()">âœ•</button>
    </div>
    <div class="dpick-sub" id="dpickSub">ìì›ìë£Œ í´ë” â€¢ xlsx / xlsm / xls íŒŒì¼</div>
    <div class="dpick-search">
      <input type="text" id="dpickSearch" placeholder="íŒŒì¼ëª… ê²€ìƒ‰..." oninput="filterDriveFiles()">
    </div>
    <div class="dpick-list" id="dpickList">
      <div class="dpick-loading"><div class="spin"></div>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
    <div class="dpick-footer">
      <span class="dpick-selected-name" id="dpickSelectedName"></span>
      <button class="btn-dpick-cancel" onclick="closeDrivePicker()">ì·¨ì†Œ</button>
      <button class="btn-dpick-ok" id="btnDpickOk" disabled onclick="confirmDrivePick()">ì„ íƒ</button>
    </div>
  </div>
</div>

<!-- â”€â”€ GCP API í‚¤ ì„¤ì • ëª¨ë‹¬ â”€â”€ -->
<div id="gcpSetupModal">
  <div class="gcp-box">
    <h3>âš™ï¸ Google Drive ì—°ë™ ì„¤ì • <span style="font-size:11px;color:var(--warn);font-weight:600;margin-left:8px;">ğŸ”‘ MASTER ì „ìš©</span></h3>
    <p>Google Driveì—ì„œ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ë ¤ë©´ Google Cloud Consoleì—ì„œ ë°œê¸‰í•œ<br>
       <b>API í‚¤</b>ì™€ <b>OAuth í´ë¼ì´ì–¸íŠ¸ ID</b>ê°€ í•„ìš”í•©ë‹ˆë‹¤.<br>
       ì…ë ¥í•œ ì •ë³´ëŠ” ì´ ë¸Œë¼ìš°ì €ì˜ localStorageì— ì €ì¥ë˜ë©°, ë§ˆìŠ¤í„° ê³„ì •ë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    <div class="gcp-field">
      <label>API Key</label>
      <input type="text" id="gcpApiKey" placeholder="AIza..." autocomplete="off">
      <div class="gcp-hint">Google Cloud Console â†’ API ë° ì„œë¹„ìŠ¤ â†’ ì‚¬ìš©ì ì¸ì¦ ì •ë³´ â†’ API í‚¤</div>
    </div>
    <div class="gcp-field">
      <label>OAuth 2.0 í´ë¼ì´ì–¸íŠ¸ ID</label>
      <input type="text" id="gcpClientId" placeholder="xxxxx.apps.googleusercontent.com" autocomplete="off">
      <div class="gcp-hint">Google Cloud Console â†’ API ë° ì„œë¹„ìŠ¤ â†’ ì‚¬ìš©ì ì¸ì¦ ì •ë³´ â†’ OAuth 2.0 í´ë¼ì´ì–¸íŠ¸ ID<br>
      ìŠ¹ì¸ëœ JavaScript ì›ë³¸ì— ì´ í˜ì´ì§€ì˜ URLì„ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤.</div>
    </div>
    <div class="gcp-actions">
      <button class="btn-dpick-cancel" onclick="closeGcpSetup()">ì·¨ì†Œ</button>
      <button class="btn-dpick-ok" onclick="saveGcpSetup()">ì €ì¥ í›„ ì—°ê²°</button>
    </div>
  </div>
</div>

<!-- â”€â”€ Login Overlay â”€â”€ -->
<div id="loginOverlay">
  <div class="login-box">
    <div class="login-logo">ğŸ“‹</div>
    <div class="login-title">ë‚´ì—­ ì½”ë“œ <span>ì²´í¬ ì‹œìŠ¤í…œ</span></div>
    <div class="login-sub">ì•„ì´íŒŒí¬ ê±´ì„¤ Â· ë‚´ì—­ê´€ë¦¬íŒ€</div>
    <div class="login-field">
      <label>ì•„ì´ë””</label>
      <input type="text" id="loginId" placeholder="ì•„ì´ë”” ì…ë ¥" autocomplete="username" onkeydown="if(event.key==='Enter')doLogin()">
    </div>
    <div class="login-field">
      <label>ë¹„ë°€ë²ˆí˜¸</label>
      <input type="password" id="loginPw" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()">
    </div>
    <div class="login-error" id="loginError"></div>
    <button class="btn-login" onclick="doLogin()">ë¡œê·¸ì¸</button>
  </div>
</div>

<!-- â”€â”€ Change Password Modal â”€â”€ -->
<div id="chgPwModal">
  <div class="chgpw-box">
    <div class="chgpw-header">
      <h2>ğŸ” ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h2>
      <button class="mgmt-close" onclick="closeChgPw()">âœ•</button>
    </div>

    <!-- ë§ˆìŠ¤í„° ì „ìš©: ë‚´ ë¹„ë°€ë²ˆí˜¸ / íƒ€ ì‚¬ìš©ì ë¹„ë°€ë²ˆí˜¸ íƒ­ -->
    <div id="chgpwTabRow" class="chgpw-tab-row" style="display:none">
      <button class="chgpw-tab active-self" id="tabSelf"  onclick="switchChgPwTab('self')">ğŸ”‘ ë‚´ ë¹„ë°€ë²ˆí˜¸</button>
      <button class="chgpw-tab"             id="tabOther" onclick="switchChgPwTab('other')">ğŸ‘¥ ì‚¬ìš©ì ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
    </div>

    <!-- ëŒ€ìƒ ì‚¬ìš©ì ì„ íƒ (ë§ˆìŠ¤í„° - íƒ€ ì‚¬ìš©ì íƒ­ì¼ ë•Œë§Œ í‘œì‹œ) -->
    <div id="chgpwTargetRow" class="chgpw-target-row" style="display:none">
      <label>ëŒ€ìƒ ê³„ì •</label>
      <select id="chgpwTargetSel" onchange="onTargetChange()"></select>
    </div>

    <!-- í˜„ì¬ ê³„ì • ì •ë³´ í‘œì‹œ -->
    <div class="chgpw-who" id="chgpwWho">-</div>

    <!-- í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ (ìì‹ ì˜ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹œì—ë§Œ í‘œì‹œ) -->
    <div class="chgpw-field" id="chgpwCurRow">
      <label>í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
      <input type="password" id="chgpwCur" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥"
             oninput="onChgPwInput()" onkeydown="if(event.key==='Enter')saveChgPw()">
    </div>

    <div class="chgpw-field">
      <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
      <input type="password" id="chgpwNew" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)"
             oninput="onChgPwInput()" onkeydown="if(event.key==='Enter')saveChgPw()">
      <div class="pw-strength"><div class="pw-strength-bar" id="pwStrBar"></div></div>
      <div class="pw-strength-label" id="pwStrLabel"></div>
    </div>

    <div class="chgpw-field">
      <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
      <input type="password" id="chgpwConfirm" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì¬ì…ë ¥"
             oninput="onChgPwInput()" onkeydown="if(event.key==='Enter')saveChgPw()">
    </div>

    <div class="chgpw-error"   id="chgpwError"></div>
    <div class="chgpw-success" id="chgpwSuccess">âœ… ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.</div>
    <button class="btn-save-pw" id="btnSavePw" onclick="saveChgPw()">ë³€ê²½ ì €ì¥</button>
  </div>
</div>

<!-- â”€â”€ User Management Modal â”€â”€ -->
<div id="userMgmtModal">
  <div class="mgmt-box">
    <div class="mgmt-header">
      <h2>ğŸ‘¥ ì‚¬ìš©ì ê´€ë¦¬ <span style="color:var(--warn);font-size:11px;margin-left:8px;font-weight:600;">MASTER</span></h2>
      <button class="mgmt-close" onclick="closeMgmt()">âœ•</button>
    </div>

    <!-- ì‚¬ìš©ì ì¶”ê°€ í¼ (3ì—´ ê·¸ë¦¬ë“œ) -->
    <div class="mgmt-add-form">
      <input type="text"     id="newUserId"   placeholder="ì•„ì´ë””">
      <input type="text"     id="newUserName" placeholder="ì´ë¦„">
      <input type="password" id="newUserPw"   placeholder="ë¹„ë°€ë²ˆí˜¸"
             onkeydown="if(event.key==='Enter')addUser()">
      <div class="mgmt-add-btn-row">
        <button class="btn-add-user" onclick="addUser()">ï¼‹ ì‚¬ìš©ì ì¶”ê°€</button>
      </div>
    </div>

    <!-- ëª©ë¡ í—¤ë” -->
    <div class="user-list-header">
      <span>ê¶Œí•œ</span>
      <span>ì•„ì´ë””</span>
      <span>ì´ë¦„</span>
      <span>ìƒíƒœ</span>
      <span></span>
      <span></span>
      <span></span>
    </div>

    <!-- ì‚¬ìš©ì ëª©ë¡ -->
    <div id="userList" class="user-list"></div>
  </div>
</div>

<div class="container">

  <header>
    <div class="logo">ğŸ“‹</div>
    <div>
      <h1>ë‚´ì—­ ì½”ë“œ <span>ì²´í¬ ì‹œìŠ¤í…œ</span></h1>
      <div class="subtitle">ì›ë‚´ì—­ â†” ìì¬ë¦¬ìŠ¤íŠ¸Â·ì¼ìœ„ëŒ€ê°€ë¦¬ìŠ¤íŠ¸ ì½”ë“œê²€í†  / í‘œì¤€ë‚´ì—­ í•­ëª© ë¹„êµ</div>
    </div>
    <div class="header-user" id="headerUser"></div>
  </header>

  <!-- Google Drive ì—°ë™ ë°” -->
  <div class="gdrive-bar" id="gdriveBar">
    <span class="gd-label">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none">
        <path d="M6.5 20L1 11l4.5-8h13L23 11l-5.5 9H6.5z" fill="#4285F4" opacity=".4"/>
        <path d="M8.5 3L1 11h7l4-8-3.5 0z" fill="#0F9D58"/>
        <path d="M15.5 3L23 11h-7l-4-8 3.5 0z" fill="#FBBC05"/>
        <path d="M8 11l4 9 4-9H8z" fill="#EA4335"/>
      </svg>
      Google Drive ì—°ë™
    </span>
    <div class="gdrive-status">
      <div class="gd-dot" id="gdDot"></div>
      <span id="gdStatusText" style="font-size:11px;color:var(--text-dim)">ì—°ê²°ë˜ì§€ ì•ŠìŒ</span>
    </div>
    <div class="gd-sep"></div>
    <span class="gd-user-info" id="gdUserInfo"></span>
    <button class="btn-gd-connect"    id="btnGdConnect"    onclick="initGoogleDrive()" style="display:none">ğŸ”— Google ê³„ì • ì—°ê²°</button>
    <button class="btn-gd-disconnect" id="btnGdDisconnect" onclick="disconnectGoogle()" style="display:none">ì—°ê²° í•´ì œ</button>
    <!-- âš™ï¸ API ì„¤ì •ì€ ë§ˆìŠ¤í„°ë§Œ í‘œì‹œ â€” renderHeaderUser()ì—ì„œ ì œì–´ -->
    <button class="btn-outline" id="btnGcpSetup" style="padding:5px 11px;font-size:10px;margin-left:auto;display:none" onclick="openGcpSetup()">âš™ï¸ API ì„¤ì •</button>
  </div>

  <!-- Upload -->
  <div class="upload-grid">

    <div class="upload-card" id="drop0">
      <input type="file" id="file0" accept=".xlsx,.xlsm,.xls">
      <div class="uc-head">
        <div class="uc-dot d-blue"></div>
        <div class="uc-label">ì›ë‚´ì—­</div>
        <span class="uc-badge req">í•„ìˆ˜</span>
      </div>
      <div class="uc-desc">ê²€í†  ëŒ€ìƒ ì›ë‚´ì—­ íŒŒì¼</div>
      <div class="uc-fn" id="fn0">íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜ ë“œë¡­í•˜ì„¸ìš”</div>
    </div>

    <div class="upload-card" id="drop1">
      <input type="file" id="file1" accept=".xlsx,.xlsm,.xls">
      <div class="uc-head">
        <div class="uc-dot d-green"></div>
        <div class="uc-label">ìì¬ë¦¬ìŠ¤íŠ¸</div>
        <span class="uc-badge req">ì½”ë“œê²€í† </span>
      </div>
      <div class="uc-desc">ìì¬ ì½”ë“œ DB íŒŒì¼</div>
      <div class="uc-fn" id="fn1">íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜ ë“œë¡­í•˜ì„¸ìš”</div>
      <button class="btn-from-drive" id="driveBtn1" onclick="openDrivePicker(1)">
        <svg width="11" height="11" viewBox="0 0 24 24" fill="none"><path d="M8.5 3L1 11h7l4-8-3.5 0z" fill="#0F9D58"/><path d="M15.5 3L23 11h-7l-4-8 3.5 0z" fill="#FBBC05"/><path d="M8 11l4 9 4-9H8z" fill="#EA4335"/></svg>
        Driveì—ì„œ ì„ íƒ
      </button>
    </div>

    <div class="upload-card" id="drop2">
      <input type="file" id="file2" accept=".xlsx,.xlsm,.xls">
      <div class="uc-head">
        <div class="uc-dot d-warn"></div>
        <div class="uc-label">ì¼ìœ„ëŒ€ê°€ë¦¬ìŠ¤íŠ¸</div>
        <span class="uc-badge req">ì½”ë“œê²€í† </span>
      </div>
      <div class="uc-desc">ì¼ìœ„ëŒ€ê°€ ì½”ë“œ DB íŒŒì¼</div>
      <div class="uc-fn" id="fn2">íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜ ë“œë¡­í•˜ì„¸ìš”</div>
      <button class="btn-from-drive" id="driveBtn2" onclick="openDrivePicker(2)">
        <svg width="11" height="11" viewBox="0 0 24 24" fill="none"><path d="M8.5 3L1 11h7l4-8-3.5 0z" fill="#0F9D58"/><path d="M15.5 3L23 11h-7l-4-8 3.5 0z" fill="#FBBC05"/><path d="M8 11l4 9 4-9H8z" fill="#EA4335"/></svg>
        Driveì—ì„œ ì„ íƒ
      </button>
    </div>

    <div class="upload-card" id="drop3">
      <input type="file" id="file3" accept=".xlsx,.xlsm,.xls">
      <div class="uc-head">
        <div class="uc-dot d-purple"></div>
        <div class="uc-label">í‘œì¤€ë‚´ì—­</div>
        <span class="uc-badge opt">í‘œì¤€ë‚´ì—­ë¹„êµ</span>
      </div>
      <div class="uc-desc">í‘œì¤€ë‚´ì—­ ë¹„êµ íŒŒì¼</div>
      <div class="uc-fn" id="fn3">íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜ ë“œë¡­í•˜ì„¸ìš”</div>
      <button class="btn-from-drive" id="driveBtn3" onclick="openDrivePicker(3)">
        <svg width="11" height="11" viewBox="0 0 24 24" fill="none"><path d="M8.5 3L1 11h7l4-8-3.5 0z" fill="#0F9D58"/><path d="M15.5 3L23 11h-7l-4-8 3.5 0z" fill="#FBBC05"/><path d="M8 11l4 9 4-9H8z" fill="#EA4335"/></svg>
        Driveì—ì„œ ì„ íƒ
      </button>
    </div>

  </div>

  <!-- Actions -->
  <div class="action-bar">
    <button class="btn btn-blue"   id="btnCode"   disabled onclick="runCodeCheck()">â–¶ ì½”ë“œ ê²€í†  ì‹¤í–‰</button>
    <button class="btn btn-purple" id="btnStd"    disabled onclick="runStdCheck()">â‡„ í‘œì¤€ë‚´ì—­ ë¹„êµ</button>
    <div class="vsep"></div>
    <button class="btn btn-outline" id="btnExport" disabled onclick="exportResult()">â¬‡ ê²°ê³¼ ì €ì¥</button>
    <button class="btn btn-outline" onclick="resetAll()">â†º ì´ˆê¸°í™”</button>
  </div>

  <!-- Mode tabs -->
  <div id="modeTabs" style="display:none" class="mode-tabs">
    <button class="mode-tab" id="tabCode" onclick="switchTab('code')">ğŸ“Œ ì½”ë“œ ê²€í†  ê²°ê³¼</button>
    <button class="mode-tab" id="tabStd"  onclick="switchTab('std')">ğŸ“Š í‘œì¤€ë‚´ì—­ ë¹„êµ ê²°ê³¼</button>
  </div>

  <!-- Stats -->
  <div id="statsArea"></div>

  <!-- Filter -->
  <div id="filterArea"></div>

  <!-- Hint -->
  <div id="hintArea"></div>

  <!-- Table -->
  <div class="table-wrapper">
    <div class="table-scroll" id="tableWrap">
      <div class="empty">
        <div class="ico">ğŸ“‹</div>
        <p>ì›ë‚´ì—­ + ìì¬ë¦¬ìŠ¤íŠ¸/ì¼ìœ„ëŒ€ê°€ë¦¬ìŠ¤íŠ¸ë¥¼ ì—…ë¡œë“œ í›„<br><b>ì½”ë“œ ê²€í†  ì‹¤í–‰</b> í´ë¦­<br><br>
           í‘œì¤€ë‚´ì—­ê³¼ í•­ëª© ë¹„êµëŠ” í‘œì¤€ë‚´ì—­ë„ ì—…ë¡œë“œ í›„<br><b>í‘œì¤€ë‚´ì—­ ë¹„êµ</b> í´ë¦­</p>
      </div>
    </div>
  </div>

</div>

<!-- â”€â”€ Google Drive Script â”€â”€ -->
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Google Drive ì—°ë™ â€” ë§ˆìŠ¤í„° ê´€ë¦¬ / ìë™ ì¬ì—°ê²°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const GCP_STORAGE_KEY  = 'cc_gcp_config';
const GD_TOKEN_KEY     = 'cc_gd_token';      // ìë™ ì¬ì—°ê²°ìš© í† í° ìºì‹œ
const GD_USERINFO_KEY  = 'cc_gd_userinfo';   // ì—°ê²°ëœ Google ê³„ì • ì •ë³´ ìºì‹œ
const DRIVE_FOLDER_ID  = '1nJf81_SOPRzP8VfAh5xPba6YHCOz4LBW';
const DRIVE_SCOPES     = 'https://www.googleapis.com/auth/drive.readonly';
const TOKEN_EXPIRE_MS  = 55 * 60 * 1000;     // 55ë¶„ (êµ¬ê¸€ í† í° ìœ íš¨ 1ì‹œê°„)

let gdTokenClient  = null;
let gdAccessToken  = null;
let gdTokenExpiry  = 0;
let gdAllFiles     = [];
let dpickTargetIdx = null;
let dpickSelected  = null;
let gapiReady      = false;

// â”€â”€ ì„¤ì • ì €ì¥/ë¡œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadGcpConfig() {
  try { return JSON.parse(localStorage.getItem(GCP_STORAGE_KEY) || 'null'); } catch { return null; }
}
function saveGcpConfig(cfg) {
  localStorage.setItem(GCP_STORAGE_KEY, JSON.stringify(cfg));
}
function loadCachedToken() {
  try { return JSON.parse(localStorage.getItem(GD_TOKEN_KEY) || 'null'); } catch { return null; }
}
function saveCachedToken(token, expiry) {
  localStorage.setItem(GD_TOKEN_KEY, JSON.stringify({ token, expiry }));
}
function clearCachedToken() {
  localStorage.removeItem(GD_TOKEN_KEY);
  localStorage.removeItem(GD_USERINFO_KEY);
}
function loadCachedUserInfo() {
  try { return JSON.parse(localStorage.getItem(GD_USERINFO_KEY) || 'null'); } catch { return null; }
}
function saveCachedUserInfo(info) {
  localStorage.setItem(GD_USERINFO_KEY, JSON.stringify(info));
}

// â”€â”€ ê¶Œí•œ ì œì–´ â€” ë¡œê·¸ì¸ í›„ renderGdriveBar() í˜¸ì¶œë¡œ ë°˜ì˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderGdriveBar() {
  if (!currentUser) return;
  const isMaster   = currentUser.role === 'master';
  const cfg        = loadGcpConfig();
  const hasConfig  = !!(cfg && cfg.apiKey && cfg.clientId);
  const isConnected = !!(gdAccessToken && Date.now() < gdTokenExpiry);

  // âš™ï¸ API ì„¤ì • â€” ë§ˆìŠ¤í„°ë§Œ
  document.getElementById('btnGcpSetup').style.display = isMaster ? '' : 'none';

  // ì—°ê²°/í•´ì œ ë²„íŠ¼ â€” ëª¨ë“  ì‚¬ìš©ì (ì„¤ì •ì´ ìˆì„ ë•Œë§Œ)
  const showConnect = hasConfig && !isConnected;
  const showDisconnect = isConnected;
  document.getElementById('btnGdConnect').style.display    = showConnect    ? '' : 'none';
  document.getElementById('btnGdDisconnect').style.display = showDisconnect ? '' : 'none';

  // ìƒíƒœ í‘œì‹œ
  if (isConnected) {
    const info = loadCachedUserInfo();
    document.getElementById('gdDot').classList.add('connected');
    document.getElementById('gdStatusText').textContent = 'ì—°ê²°ë¨';
    document.getElementById('gdStatusText').style.color = 'var(--success)';
    document.getElementById('gdUserInfo').textContent   = info ? (info.name || info.email || '') : '';
    [1,2,3].forEach(i => document.getElementById('driveBtn'+i).classList.add('visible'));
  } else if (!hasConfig) {
    document.getElementById('gdDot').classList.remove('connected');
    document.getElementById('gdStatusText').textContent = isMaster ? 'API í‚¤ ë¯¸ì„¤ì • (âš™ï¸ í´ë¦­í•˜ì—¬ ì„¤ì •)' : 'Drive ë¯¸ì„¤ì • (ê´€ë¦¬ì ë¬¸ì˜)';
    document.getElementById('gdStatusText').style.color = 'var(--text-dim)';
    document.getElementById('gdUserInfo').textContent   = '';
    [1,2,3].forEach(i => document.getElementById('driveBtn'+i).classList.remove('visible'));
  } else {
    document.getElementById('gdDot').classList.remove('connected');
    document.getElementById('gdStatusText').textContent = 'ì—°ê²° í•„ìš”';
    document.getElementById('gdStatusText').style.color = 'var(--warn)';
    document.getElementById('gdUserInfo').textContent   = '';
    [1,2,3].forEach(i => document.getElementById('driveBtn'+i).classList.remove('visible'));
  }
}

// â”€â”€ GCP ì„¤ì • ëª¨ë‹¬ â€” ë§ˆìŠ¤í„° ì „ìš© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openGcpSetup() {
  if (!currentUser || currentUser.role !== 'master') {
    alert('API ì„¤ì •ì€ ë§ˆìŠ¤í„° ê³„ì •ë§Œ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'); return;
  }
  const cfg = loadGcpConfig();
  document.getElementById('gcpApiKey').value   = cfg?.apiKey    || '';
  document.getElementById('gcpClientId').value = cfg?.clientId  || '';
  document.getElementById('gcpSetupModal').classList.add('open');
}
function closeGcpSetup() {
  document.getElementById('gcpSetupModal').classList.remove('open');
}
function saveGcpSetup() {
  if (!currentUser || currentUser.role !== 'master') return;
  const apiKey   = document.getElementById('gcpApiKey').value.trim();
  const clientId = document.getElementById('gcpClientId').value.trim();
  if (!apiKey || !clientId) { alert('API í‚¤ì™€ í´ë¼ì´ì–¸íŠ¸ IDë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  saveGcpConfig({ apiKey, clientId });
  clearCachedToken();   // í‚¤ ë³€ê²½ ì‹œ ê¸°ì¡´ í† í° ë¬´íš¨í™”
  gdAccessToken = null; gdTokenExpiry = 0;
  closeGcpSetup();
  initGoogleDrive();    // ì €ì¥ ì¦‰ì‹œ ì—°ê²° ì‹œë„
}

// â”€â”€ GAPI ì´ˆê¸°í™” (í•œ ë²ˆë§Œ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ensureGapiReady(cfg) {
  return new Promise((resolve, reject) => {
    if (gapiReady) { resolve(); return; }
    gapi.load('client', async () => {
      try {
        await gapi.client.init({
          apiKey: cfg.apiKey,
          discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
        });
        gapiReady = true;
        resolve();
      } catch(e) { reject(e); }
    });
  });
}

// â”€â”€ Google Drive ì—°ê²° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function initGoogleDrive() {
  const cfg = loadGcpConfig();
  if (!cfg?.apiKey || !cfg?.clientId) { openGcpSetup(); return; }

  try {
    await ensureGapiReady(cfg);

    // â‘  ìºì‹œëœ í† í°ì´ ìœ íš¨í•˜ë©´ ì¬ì‚¬ìš© (ìë™ ì¬ì—°ê²°)
    const cached = loadCachedToken();
    if (cached && cached.token && Date.now() < cached.expiry - 60000) {
      gdAccessToken = cached.token;
      gdTokenExpiry = cached.expiry;
      gapi.client.setToken({ access_token: gdAccessToken });
      const info = loadCachedUserInfo();
      onGoogleConnected(info);
      return;
    }

    // â‘¡ í† í° ë§Œë£Œ/ì—†ìŒ â†’ ìƒˆ í† í° ìš”ì²­ (prompt:'' ë¡œ íŒì—… ìµœì†Œí™”)
    gdTokenClient = google.accounts.oauth2.initTokenClient({
      client_id: cfg.clientId,
      scope: DRIVE_SCOPES,
      prompt: '',   // ì´ë¯¸ ë™ì˜í•œ ê²½ìš° íŒì—… ì—†ì´ ì¦‰ì‹œ ë°œê¸‰
      callback: async (resp) => {
        if (resp.error) {
          // prompt:'' ì‹¤íŒ¨ ì‹œ ëª…ì‹œì  ë™ì˜ì°½ ì¬ì‹œë„
          if (resp.error === 'interaction_required' || resp.error === 'access_denied') {
            gdTokenClient.requestAccessToken({ prompt: 'consent' });
          } else {
            alert('Google ì¸ì¦ ì‹¤íŒ¨: ' + resp.error);
          }
          return;
        }
        gdAccessToken = resp.access_token;
        gdTokenExpiry = Date.now() + TOKEN_EXPIRE_MS;
        gapi.client.setToken({ access_token: gdAccessToken });

        // userinfo ì¡°íšŒ í›„ ìºì‹œ
        try {
          const r = await fetch('https://www.googleapis.com/oauth2/v3/userinfo',
            { headers: { Authorization: 'Bearer ' + gdAccessToken } });
          const info = await r.json();
          saveCachedToken(gdAccessToken, gdTokenExpiry);
          saveCachedUserInfo(info);
          onGoogleConnected(info);
        } catch { onGoogleConnected(null); }
      }
    });
    gdTokenClient.requestAccessToken({ prompt: '' });

  } catch(e) {
    alert('Google Drive ì´ˆê¸°í™” ì‹¤íŒ¨: ' + e.message);
  }
}

function onGoogleConnected(info) {
  renderGdriveBar();
  fetchDriveFiles();   // íŒŒì¼ ëª©ë¡ ë¯¸ë¦¬ ìºì‹œ

  // í† í° ìë™ ê°±ì‹  íƒ€ì´ë¨¸ (ë§Œë£Œ 5ë¶„ ì „)
  const remaining = gdTokenExpiry - Date.now() - 5 * 60 * 1000;
  if (remaining > 0) {
    setTimeout(() => {
      if (gdAccessToken) initGoogleDrive();  // ì¡°ìš©íˆ ì¬ë°œê¸‰
    }, remaining);
  }
}

function disconnectGoogle() {
  if (gdAccessToken) {
    try { google.accounts.oauth2.revoke(gdAccessToken, () => {}); } catch {}
  }
  gdAccessToken = null; gdTokenExpiry = 0; gdAllFiles = [];
  clearCachedToken();
  gapiReady = false;
  renderGdriveBar();
}

// â”€â”€ Drive íŒŒì¼ ëª©ë¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchDriveFiles() {
  try {
    const res = await gapi.client.drive.files.list({
      q: `'${DRIVE_FOLDER_ID}' in parents and trashed=false and ` +
         `(mimeType='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' ` +
         `or mimeType='application/vnd.ms-excel' or name contains '.xlsm')`,
      fields: 'files(id,name,size,modifiedTime,mimeType)',
      orderBy: 'name', pageSize: 200
    });
    gdAllFiles = res.result.files || [];
  } catch(e) {
    console.error('Drive ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨', e);
    gdAllFiles = [];
  }
}

// â”€â”€ Drive Picker ëª¨ë‹¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SLOT_LABELS = { 1:'ìì¬ë¦¬ìŠ¤íŠ¸', 2:'ì¼ìœ„ëŒ€ê°€ë¦¬ìŠ¤íŠ¸', 3:'í‘œì¤€ë‚´ì—­' };

async function openDrivePicker(idx) {
  if (!gdAccessToken || Date.now() >= gdTokenExpiry) {
    alert('Google Drive ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤. ì—°ê²° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.'); return;
  }
  dpickTargetIdx = idx;
  dpickSelected  = null;
  document.getElementById('dpickSelectedName').textContent = '';
  document.getElementById('btnDpickOk').disabled = true;
  document.getElementById('dpickSearch').value   = '';
  document.getElementById('dpickSub').textContent = `ìì›ìë£Œ í´ë” â€¢ ${SLOT_LABELS[idx]} ì„ íƒ`;
  document.getElementById('dpickList').innerHTML =
    '<div class="dpick-loading"><div class="spin"></div>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
  document.getElementById('drivePickerModal').classList.add('open');
  if (!gdAllFiles.length) await fetchDriveFiles();
  renderDriveFiles(gdAllFiles);
}

function closeDrivePicker() {
  document.getElementById('drivePickerModal').classList.remove('open');
  dpickSelected = null; dpickTargetIdx = null;
}

function renderDriveFiles(files) {
  const el = document.getElementById('dpickList');
  if (!files.length) {
    el.innerHTML = '<div class="dpick-empty">ğŸ“‚ xlsx / xlsm / xls íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤</div>'; return;
  }
  el.innerHTML = files.map(f => {
    const ext  = f.name.split('.').pop().toLowerCase();
    const icon = ext === 'xlsm' ? 'ğŸ“—' : 'ğŸ“Š';
    const kb   = f.size ? (f.size < 1048576 ? Math.round(f.size/1024)+'KB' : (f.size/1048576).toFixed(1)+'MB') : '';
    const dt   = f.modifiedTime ? new Date(f.modifiedTime).toLocaleDateString('ko-KR') : '';
    return `<div class="dpick-item" data-id="${esc(f.id)}" data-name="${esc(f.name)}"
              onclick="selectDriveFile(this,'${esc(f.id)}','${esc(f.name).replace(/'/g,'&#39;')}')">
              <span class="dpick-icon">${icon}</span>
              <span class="dpick-name" title="${esc(f.name)}">${esc(f.name)}</span>
              <span class="dpick-size">${esc(kb)}</span>
              <span class="dpick-date">${esc(dt)}</span>
            </div>`;
  }).join('');
}

function filterDriveFiles() {
  const q = document.getElementById('dpickSearch').value.toLowerCase();
  renderDriveFiles(gdAllFiles.filter(f => f.name.toLowerCase().includes(q)));
  dpickSelected = null;
  document.getElementById('dpickSelectedName').textContent = '';
  document.getElementById('btnDpickOk').disabled = true;
}

function selectDriveFile(el, id, name) {
  document.querySelectorAll('.dpick-item').forEach(e => e.classList.remove('selected'));
  el.classList.add('selected');
  dpickSelected = { id, name };
  document.getElementById('dpickSelectedName').textContent = 'âœ“ ' + name;
  document.getElementById('btnDpickOk').disabled = false;
}

async function confirmDrivePick() {
  if (!dpickSelected || dpickTargetIdx === null) return;
  const { id, name } = dpickSelected;
  const fnEl  = document.getElementById('fn'   + dpickTargetIdx);
  const card  = document.getElementById('drop' + dpickTargetIdx);
  const dotCl = ['c-blue','c-green','c-warn','c-purple'][dpickTargetIdx];

  fnEl.textContent = 'â¬ ë‹¤ìš´ë¡œë“œ ì¤‘...'; fnEl.className = 'uc-fn';
  closeDrivePicker();

  try {
    const fetchRes = await fetch(
      `https://www.googleapis.com/drive/v3/files/${id}?alt=media`,
      { headers: { Authorization: 'Bearer ' + gdAccessToken } }
    );
    if (!fetchRes.ok) throw new Error('ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ (' + fetchRes.status + ')');
    const buf = await fetchRes.arrayBuffer();
    wbs[dpickTargetIdx] = XLSX.read(buf, { type: 'array' });
    fnEl.textContent = 'âœ“ [Drive] ' + name;
    fnEl.className   = 'uc-fn ok';
    card.classList.add('loaded', dotCl);
  } catch(e) {
    fnEl.textContent = 'âŒ ' + e.message;
    fnEl.className   = 'uc-fn';
  }
  updateBtns();
}

// â”€â”€ ì•± ì‹œì‘ ì‹œ ìë™ ì¬ì—°ê²° ì‹œë„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// doLogin() ì™„ë£Œ í›„ í˜¸ì¶œë¨ (renderHeaderUser ë‹¤ìŒ)
async function tryAutoReconnectDrive() {
  const cfg    = loadGcpConfig();
  if (!cfg?.apiKey || !cfg?.clientId) { renderGdriveBar(); return; }

  const cached = loadCachedToken();
  if (!cached?.token || Date.now() >= cached.expiry - 60000) {
    // í† í° ì—†ê±°ë‚˜ ë§Œë£Œ â€” ì¡°ìš©íˆ ê°±ì‹  ì‹œë„ (prompt:'')
    try {
      await ensureGapiReady(cfg);
      gdTokenClient = google.accounts.oauth2.initTokenClient({
        client_id: cfg.clientId,
        scope: DRIVE_SCOPES,
        prompt: '',
        callback: async (resp) => {
          if (resp.error) { renderGdriveBar(); return; }   // ì‹¤íŒ¨í•´ë„ ì¡°ìš©íˆ
          gdAccessToken = resp.access_token;
          gdTokenExpiry = Date.now() + TOKEN_EXPIRE_MS;
          gapi.client.setToken({ access_token: gdAccessToken });
          try {
            const r = await fetch('https://www.googleapis.com/oauth2/v3/userinfo',
              { headers: { Authorization: 'Bearer ' + gdAccessToken } });
            const info = await r.json();
            saveCachedToken(gdAccessToken, gdTokenExpiry);
            saveCachedUserInfo(info);
          } catch {}
          onGoogleConnected(loadCachedUserInfo());
        }
      });
      gdTokenClient.requestAccessToken({ prompt: '' });
    } catch { renderGdriveBar(); }
    return;
  }

  // ìºì‹œ ìœ íš¨ â€” ë°”ë¡œ ë³µì›
  gdAccessToken = cached.token;
  gdTokenExpiry = cached.expiry;
  try {
    await ensureGapiReady(cfg);
    gapi.client.setToken({ access_token: gdAccessToken });
    onGoogleConnected(loadCachedUserInfo());
  } catch { renderGdriveBar(); }
}

// ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­
document.getElementById('drivePickerModal').addEventListener('click', function(e){ if(e.target===this) closeDrivePicker(); });
document.getElementById('gcpSetupModal').addEventListener('click',    function(e){ if(e.target===this) closeGcpSetup(); });
</script>

<script>
// â”€â”€ Shared Utils (must be first) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// â”€â”€ Auth & User Management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const STORAGE_KEY = 'cc_ipark_users';

// ê¸°ë³¸ ê³„ì • â€” localStorageì— ë°ì´í„°ê°€ ì—†ì„ ë•Œ í•œ ë²ˆë§Œ ì‚¬ìš©
const DEFAULT_USERS = [
  { id: 'master', name: 'ê´€ë¦¬ì', pw: 'master1234', role: 'master', active: true },
  { id: 'user1',  name: 'í™ê¸¸ë™', pw: 'user1234',   role: 'user',   active: true }
];

function loadUsers() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) return JSON.parse(raw);
  } catch(e) {}
  // ìµœì´ˆ ì‹¤í–‰ ì‹œ ê¸°ë³¸ê°’ì„ ì €ì¥í•˜ê³  ë°˜í™˜
  saveUsers(DEFAULT_USERS);
  return JSON.parse(JSON.stringify(DEFAULT_USERS));
}

function saveUsers(users) {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(users));
  } catch(e) {
    alert('ì €ì¥ ì‹¤íŒ¨: ' + e.message);
  }
}

/** saveUsers ë˜í¼ â€” ì„¸ì…˜ ë‚´ currentUser ë¹„ë°€ë²ˆí˜¸ë„ ë™ê¸°í™” */
function persistUsers(users) {
  saveUsers(users);
  // í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ì ì •ë³´ë¥¼ ìµœì‹ ìœ¼ë¡œ ê°±ì‹ 
  if (currentUser) {
    const updated = users.find(u => u.id === currentUser.id);
    if (updated) currentUser = updated;
  }
}

function doLogin() {
  const id = document.getElementById('loginId').value.trim();
  const pw = document.getElementById('loginPw').value;
  const errEl = document.getElementById('loginError');
  errEl.textContent = '';

  if (!id || !pw) { errEl.textContent = 'ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'; return; }

  const users = loadUsers();
  const user = users.find(u => u.id === id && u.pw === pw);

  if (!user) { errEl.textContent = 'ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'; return; }
  if (!user.active) { errEl.textContent = 'ë¹„í™œì„±í™”ëœ ê³„ì •ì…ë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.'; return; }

  currentUser = user;
  document.getElementById('loginOverlay').style.display = 'none';
  renderHeaderUser();
  tryAutoReconnectDrive();   // ë¡œê·¸ì¸ í›„ Drive ìë™ ì¬ì—°ê²° ì‹œë„
}

function doLogout() {
  currentUser = null;
  document.getElementById('loginId').value = '';
  document.getElementById('loginPw').value = '';
  document.getElementById('loginError').textContent = '';
  document.getElementById('loginOverlay').style.display = 'flex';
  document.getElementById('headerUser').innerHTML = '';
  // Drive ë²„íŠ¼ ìˆ¨ê¸°ê¸° (ì—°ê²°ì€ ìœ ì§€ â€” ë‹¤ìŒ ë¡œê·¸ì¸ ì‹œ ìë™ ë³µì›)
  [1,2,3].forEach(i => document.getElementById('driveBtn'+i).classList.remove('visible'));
  document.getElementById('btnGdConnect').style.display    = 'none';
  document.getElementById('btnGdDisconnect').style.display = 'none';
  document.getElementById('btnGcpSetup').style.display     = 'none';
  resetAll();
}

function renderHeaderUser() {
  const el = document.getElementById('headerUser');
  const roleLabel = currentUser.role === 'master' ? 'ğŸ”‘ ë§ˆìŠ¤í„°' : 'ğŸ‘¤ ì‚¬ìš©ì';
  el.innerHTML = `
    <div class="user-badge">
      <div class="user-dot"></div>
      <span>${esc(currentUser.name)} <span style="color:var(--text-dim);font-size:10px">(${esc(currentUser.id)})</span></span>
      <span style="font-size:10px;color:${currentUser.role==='master'?'var(--warn)':'var(--accent)'};font-weight:700">${roleLabel}</span>
    </div>
    ${currentUser.role === 'master' ? `<button class="btn-user-mgmt" onclick="openMgmt()">ğŸ‘¥ ì‚¬ìš©ì ê´€ë¦¬</button>` : ''}
    <button class="btn-chgpw" onclick="openChgPw()">ğŸ” ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
    <button class="btn-logout" onclick="doLogout()">ë¡œê·¸ì•„ì›ƒ</button>
  `;
}

// â”€â”€ User Management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openMgmt() {
  renderUserList();
  document.getElementById('userMgmtModal').classList.add('open');
}

function closeMgmt() {
  document.getElementById('userMgmtModal').classList.remove('open');
  document.getElementById('newUserId').value = '';
  document.getElementById('newUserName').value = '';
  document.getElementById('newUserPw').value = '';
}

function renderUserList() {
  const users = loadUsers();
  const el = document.getElementById('userList');
  if (!users.length) {
    el.innerHTML = '<div style="text-align:center;color:var(--text-dim);font-size:12px;padding:24px">ë“±ë¡ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤</div>';
    return;
  }
  el.innerHTML = users.map((u, i) => `
    <div class="user-item">
      <span class="u-role ${u.role === 'master' ? 'role-master' : 'role-user'}">${esc(u.role === 'master' ? 'ë§ˆìŠ¤í„°' : 'ì‚¬ìš©ì')}</span>
      <span class="u-id">${esc(u.id)}</span>
      <span class="u-name">${esc(u.name)}</span>
      <span class="u-status ${u.active ? 's-active' : 's-inactive'}">${u.active ? 'â— í™œì„±' : 'â—‹ ë¹„í™œì„±'}</span>
      ${u.role !== 'master' ? `
        <span></span>
        <button class="btn-toggle-status" data-action="toggle" data-idx="${i}">${u.active ? 'ë¹„í™œì„±í™”' : 'í™œì„±í™”'}</button>
        <button class="btn-del-user"      data-action="delete" data-idx="${i}">ì‚­ì œ</button>
      ` : `<span></span><span></span><span class="mgmt-protected">ğŸ”’ ë³´í˜¸ë¨</span>`}
    </div>
  `).join('');
}

// userList ì´ë²¤íŠ¸ ìœ„ì„ â€” ë²„íŠ¼ í´ë¦­ì„ í•œ ê³³ì—ì„œ ì²˜ë¦¬
document.getElementById('userList').addEventListener('click', function(e) {
  const btn = e.target.closest('[data-action]');
  if (!btn) return;
  const idx    = parseInt(btn.dataset.idx, 10);
  const action = btn.dataset.action;
  if (action === 'toggle') toggleUser(idx);
  if (action === 'delete') deleteUser(idx);
});

function addUser() {
  const id   = document.getElementById('newUserId').value.trim();
  const name = document.getElementById('newUserName').value.trim();
  const pw   = document.getElementById('newUserPw').value;

  if (!id || !name || !pw) { alert('ì•„ì´ë””, ì´ë¦„, ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.'); return; }

  const users = loadUsers();
  if (users.find(u => u.id === id)) { alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤.'); return; }

  users.push({ id, name, pw, role: 'user', active: true });
  persistUsers(users);
  document.getElementById('newUserId').value = '';
  document.getElementById('newUserName').value = '';
  document.getElementById('newUserPw').value = '';
  renderUserList();
}

function toggleUser(i) {
  const users = loadUsers();
  if (users[i].role === 'master') return;
  users[i].active = !users[i].active;
  persistUsers(users);
  renderUserList();
}

function deleteUser(i) {
  const users = loadUsers();
  if (users[i].role === 'master') return;
  if (!confirm(`'${users[i].name}(${users[i].id})' ê³„ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
  users.splice(i, 1);
  persistUsers(users);
  renderUserList();
}

// ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
document.getElementById('userMgmtModal').addEventListener('click', function(e) {
  if (e.target === this) closeMgmt();
});
document.getElementById('chgPwModal').addEventListener('click', function(e) {
  if (e.target === this) closeChgPw();
});

// â”€â”€ Change Password â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let chgPwTab = 'self'; // 'self' | 'other'

function openChgPw() {
  chgPwTab = 'self';
  const isMaster = currentUser.role === 'master';

  // ë§ˆìŠ¤í„° íƒ­ í‘œì‹œ
  document.getElementById('chgpwTabRow').style.display = isMaster ? 'flex' : 'none';
  document.getElementById('tabSelf').className  = 'chgpw-tab active-self';
  document.getElementById('tabOther').className = 'chgpw-tab';
  document.getElementById('chgpwTargetRow').style.display = 'none';

  // í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ í•„ë“œ í‘œì‹œ
  document.getElementById('chgpwCurRow').style.display = 'block';

  // ê³„ì • ì •ë³´ í‘œì‹œ
  document.getElementById('chgpwWho').textContent = `${currentUser.name}  (${currentUser.id})  Â·  ${currentUser.role === 'master' ? 'ë§ˆìŠ¤í„°' : 'ì‚¬ìš©ì'}`;

  // ì…ë ¥ ì´ˆê¸°í™”
  ['chgpwCur','chgpwNew','chgpwConfirm'].forEach(id => {
    const el = document.getElementById(id);
    el.value = ''; el.className = '';
  });
  document.getElementById('chgpwError').textContent = '';
  document.getElementById('chgpwSuccess').style.display = 'none';
  document.getElementById('pwStrBar').style.cssText = 'width:0';
  document.getElementById('pwStrLabel').textContent = '';
  document.getElementById('btnSavePw').disabled = false;

  document.getElementById('chgPwModal').classList.add('open');
  setTimeout(() => document.getElementById('chgpwCur').focus(), 80);
}

function closeChgPw() {
  document.getElementById('chgPwModal').classList.remove('open');
}

function switchChgPwTab(tab) {
  chgPwTab = tab;
  document.getElementById('tabSelf').className  = tab === 'self'  ? 'chgpw-tab active-self'  : 'chgpw-tab';
  document.getElementById('tabOther').className = tab === 'other' ? 'chgpw-tab active-other' : 'chgpw-tab';

  // ì…ë ¥ ì´ˆê¸°í™”
  ['chgpwCur','chgpwNew','chgpwConfirm'].forEach(id => {
    const el = document.getElementById(id); el.value = ''; el.className = '';
  });
  document.getElementById('chgpwError').textContent = '';
  document.getElementById('chgpwSuccess').style.display = 'none';
  document.getElementById('pwStrBar').style.cssText = 'width:0';
  document.getElementById('pwStrLabel').textContent = '';

  if (tab === 'self') {
    document.getElementById('chgpwTargetRow').style.display = 'none';
    document.getElementById('chgpwCurRow').style.display = 'block';
    document.getElementById('chgpwWho').textContent = `${currentUser.name}  (${currentUser.id})  Â·  ë§ˆìŠ¤í„°`;
  } else {
    // íƒ€ ì‚¬ìš©ì ëª©ë¡ ì±„ìš°ê¸°
    const users = loadUsers().filter(u => u.role !== 'master');
    const sel = document.getElementById('chgpwTargetSel');
    sel.innerHTML = users.length
      ? users.map(u => `<option value="${esc(u.id)}">${esc(u.name)} (${esc(u.id)})</option>`).join('')
      : '<option value="">â€” ì‚¬ìš©ì ì—†ìŒ â€”</option>';
    document.getElementById('chgpwTargetRow').style.display = 'flex';
    // ë§ˆìŠ¤í„°ê°€ íƒ€ ì‚¬ìš©ì ë³€ê²½ ì‹œ í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ ë¶ˆí•„ìš”
    document.getElementById('chgpwCurRow').style.display = 'none';
    onTargetChange();
  }
}

function onTargetChange() {
  const sel = document.getElementById('chgpwTargetSel');
  const uid = sel.value;
  const users = loadUsers();
  const u = users.find(x => x.id === uid);
  document.getElementById('chgpwWho').textContent = u
    ? `${u.name}  (${u.id})  Â·  ${u.active ? 'í™œì„±' : 'ë¹„í™œì„±'}`
    : 'â€”';
}

function pwStrength(pw) {
  if (!pw) return { score: 0, label: '', color: '' };
  let s = 0;
  if (pw.length >= 6)  s++;
  if (pw.length >= 10) s++;
  if (/[A-Z]/.test(pw)) s++;
  if (/[0-9]/.test(pw)) s++;
  if (/[^A-Za-z0-9]/.test(pw)) s++;
  if (s <= 1) return { score: 20,  label: 'ë§¤ìš° ì•½í•¨', color: 'var(--danger)' };
  if (s === 2) return { score: 40,  label: 'ì•½í•¨',     color: 'var(--warn)' };
  if (s === 3) return { score: 65,  label: 'ë³´í†µ',     color: '#eab308' };
  if (s === 4) return { score: 85,  label: 'ê°•í•¨',     color: 'var(--success)' };
  return                { score: 100, label: 'ë§¤ìš° ê°•í•¨', color: 'var(--accent2)' };
}

function onChgPwInput() {
  const newPw = document.getElementById('chgpwNew').value;
  const confirm = document.getElementById('chgpwConfirm');

  // ê°•ë„ í‘œì‹œ
  const str = pwStrength(newPw);
  const bar = document.getElementById('pwStrBar');
  bar.style.width = str.score + '%';
  bar.style.background = str.color || 'transparent';
  document.getElementById('pwStrLabel').textContent = str.label;
  document.getElementById('pwStrLabel').style.color = str.color;

  // í™•ì¸ í•„ë“œ ìƒ‰ìƒ
  if (confirm.value) {
    confirm.className = confirm.value === newPw ? 'input-ok' : 'input-err';
  } else {
    confirm.className = '';
  }

  document.getElementById('chgpwError').textContent = '';
  document.getElementById('chgpwSuccess').style.display = 'none';
}

function saveChgPw() {
  const errEl = document.getElementById('chgpwError');
  const sucEl = document.getElementById('chgpwSuccess');
  errEl.textContent = ''; sucEl.style.display = 'none';

  const newPw     = document.getElementById('chgpwNew').value;
  const confirmPw = document.getElementById('chgpwConfirm').value;

  if (newPw.length < 6) { errEl.textContent = 'ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.'; return; }
  if (newPw !== confirmPw) { errEl.textContent = 'ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'; return; }

  const users = loadUsers();

  if (chgPwTab === 'self' || currentUser.role !== 'master') {
    // ìì‹ ì˜ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ â†’ í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ í•„ìš”
    const curPw = document.getElementById('chgpwCur').value;
    if (!curPw) { errEl.textContent = 'í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'; return; }
    const idx = users.findIndex(u => u.id === currentUser.id);
    if (idx < 0 || users[idx].pw !== curPw) { errEl.textContent = 'í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'; return; }
    if (curPw === newPw) { errEl.textContent = 'ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ì™€ ë™ì¼í•©ë‹ˆë‹¤.'; return; }
    users[idx].pw = newPw;
    currentUser.pw = newPw;
  } else {
    // ë§ˆìŠ¤í„°ê°€ íƒ€ ì‚¬ìš©ì ë³€ê²½
    const targetId = document.getElementById('chgpwTargetSel').value;
    if (!targetId) { errEl.textContent = 'ëŒ€ìƒ ì‚¬ìš©ìë¥¼ ì„ íƒí•˜ì„¸ìš”.'; return; }
    const idx = users.findIndex(u => u.id === targetId);
    if (idx < 0) { errEl.textContent = 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'; return; }
    users[idx].pw = newPw;
  }

  persistUsers(users);

  // ì„±ê³µ UI
  sucEl.style.display = 'block';
  document.getElementById('btnSavePw').disabled = true;
  ['chgpwCur','chgpwNew','chgpwConfirm'].forEach(id => {
    document.getElementById(id).value = '';
    document.getElementById(id).className = '';
  });
  document.getElementById('pwStrBar').style.cssText = 'width:0';
  document.getElementById('pwStrLabel').textContent = '';

  setTimeout(closeChgPw, 1800);
}
</script>
<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const wbs = [null,null,null,null];
const dotCls = ['c-blue','c-green','c-warn','c-purple'];

let codeRes = [];
let stdRes  = [];
let curTab  = '';
let curFilter = 'all';
let curSearch = '';

// â”€â”€ File Drop Setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ìŠ¬ë¡¯ë³„ ë ˆì´ë¸”
const SLOT_NAME = ['ì›ë‚´ì—­','ìì¬ë¦¬ìŠ¤íŠ¸','ì¼ìœ„ëŒ€ê°€ë¦¬ìŠ¤íŠ¸','í‘œì¤€ë‚´ì—­'];

// íŒŒì¼ ì¢…ë¥˜ ìë™ íŒë³„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ë°˜í™˜ê°’: 0=ì›ë‚´ì—­, 1=ìì¬ë¦¬ìŠ¤íŠ¸, 2=ì¼ìœ„ëŒ€ê°€ë¦¬ìŠ¤íŠ¸, 3=í‘œì¤€ë‚´ì—­, -1=ë¶ˆëª…
function detectFileType(wb) {
  const sheetNames = wb.SheetNames.map(s => s.replace(/\s/g,'').toLowerCase());

  // â‘  ì‹œíŠ¸ëª… í‚¤ì›Œë“œ íŒë³„
  const matKw   = ['ìì¬','ìì¬ë¦¬ìŠ¤íŠ¸','material'];
  const unitKw  = ['ì¼ìœ„ëŒ€ê°€','ì¼ìœ„','ë‹¨ê°€','unitprice'];
  const stdKw   = ['í‘œì¤€ë‚´ì—­','í‘œì¤€','standard'];
  const srcKw   = ['ì›ë‚´ì—­','ë‚´ì—­','ì›_ë‚´ì—­','source'];

  if (sheetNames.some(s => matKw.some(k  => s.includes(k))))  return 1;
  if (sheetNames.some(s => unitKw.some(k => s.includes(k))))  return 2;
  if (sheetNames.some(s => stdKw.some(k  => s.includes(k))))  return 3;
  if (sheetNames.some(s => srcKw.some(k  => s.includes(k))))  return 0;

  // â‘¡ ì²« ë²ˆì§¸ ì‹œíŠ¸ í—¤ë” í–‰ ë¶„ì„ (ì½”ë“œ ì»¬ëŸ¼ ì¡´ì¬ ì—¬ë¶€)
  for (const sn of wb.SheetNames) {
    const rows = XLSX.utils.sheet_to_json(wb.Sheets[sn], {header:1, defval:'', range:0});
    if (!rows || !rows.length) continue;
    // í—¤ë” 10í–‰ ì´ë‚´ íƒìƒ‰
    for (let r = 0; r < Math.min(10, rows.length); r++) {
      const rowStr = rows[r].map(c => String(c||'').replace(/\s/g,'').toLowerCase()).join(',');
      if (rowStr.includes('ìì¬') && rowStr.includes('ì½”ë“œ')) return 1;
      if (rowStr.includes('ì¼ìœ„') && rowStr.includes('ì½”ë“œ')) return 2;
      if (rowStr.includes('í‘œì¤€') && rowStr.includes('ì½”ë“œ')) return 3;
    }
  }

  // â‘¢ íŒë³„ ë¶ˆê°€ â†’ ì›ë‚´ì—­ìœ¼ë¡œ ê¸°ë³¸ ì²˜ë¦¬
  return 0;
}

// ìŠ¬ë¡¯ì— íŒŒì¼ ì„¸íŒ…
function setSlot(slotIdx, wb, fileName) {
  wbs[slotIdx] = wb;
  const fnEl = document.getElementById('fn'   + slotIdx);
  const card  = document.getElementById('drop' + slotIdx);
  // ì´ì „ ìƒ‰ìƒ í´ë˜ìŠ¤ ì œê±° í›„ ì¬ì ìš©
  dotCls.forEach(c => card.classList.remove(c));
  card.classList.add('loaded', dotCls[slotIdx]);
  fnEl.textContent = 'âœ“ ' + fileName;
  fnEl.className   = 'uc-fn ok';
}

// ìŠ¬ë¡¯ ì´ˆê¸°í™”
function clearSlot(slotIdx) {
  wbs[slotIdx] = null;
  const fnEl = document.getElementById('fn'   + slotIdx);
  const card  = document.getElementById('drop' + slotIdx);
  dotCls.forEach(c => card.classList.remove(c));
  card.classList.remove('loaded');
  fnEl.textContent = 'íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜ ë“œë¡­í•˜ì„¸ìš”';
  fnEl.className   = 'uc-fn';
}

// íŒŒì¼ ë¡œë“œ + ìë™ íŒë³„ í›„ ì˜¬ë°”ë¥¸ ìŠ¬ë¡¯ì— ë°°ì¹˜
function loadWb(file, hintSlot) {
  const r = new FileReader();
  r.onload = e => {
    let wb;
    try {
      wb = XLSX.read(e.target.result, {type:'array'});
    } catch(err) {
      const fnEl = document.getElementById('fn' + hintSlot);
      fnEl.textContent = 'âŒ ' + err.message;
      fnEl.className   = 'uc-fn';
      updateBtns(); return;
    }

    const detected = detectFileType(wb);

    // íŒë³„ ê²°ê³¼ê°€ íŒíŠ¸(ë“œë¡­í•œ ì¹´ë“œ)ì™€ ë‹¤ë¥¼ ë•Œ í™•ì¸
    if (detected !== hintSlot) {
      const detectedName = SLOT_NAME[detected];
      const hintName     = SLOT_NAME[hintSlot];
      const msg = `íŒŒì¼ ë¶„ì„ ê²°ê³¼ ã€Œ${detectedName}ã€ë¡œ íŒë³„ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n`
        + `â€¢ ã€Œ${detectedName}ã€ ìŠ¬ë¡¯ì— ë°°ì¹˜: í™•ì¸\n`
        + `â€¢ ã€Œ${hintName}ã€ ìŠ¬ë¡¯ì— ê·¸ëŒ€ë¡œ: ì·¨ì†Œ`;
      const useDetected = confirm(msg);
      const targetSlot  = useDetected ? detected : hintSlot;

      // ëŒ€ìƒ ìŠ¬ë¡¯ì— ì´ë¯¸ íŒŒì¼ì´ ìˆìœ¼ë©´ ë®ì–´ì“¸ì§€ í™•ì¸
      if (wbs[targetSlot]) {
        if (!confirm(`ã€Œ${SLOT_NAME[targetSlot]}ã€ì— ì´ë¯¸ íŒŒì¼ì´ ìˆìŠµë‹ˆë‹¤. êµì²´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
          updateBtns(); return;
        }
        clearSlot(targetSlot);
      }
      setSlot(targetSlot, wb, file.name);
    } else {
      // íŒë³„ ì¼ì¹˜ â†’ ë°”ë¡œ ë°°ì¹˜ (ê¸°ì¡´ íŒŒì¼ ìˆìœ¼ë©´ êµì²´)
      if (wbs[hintSlot]) clearSlot(hintSlot);
      setSlot(hintSlot, wb, file.name);
    }
    updateBtns();
  };
  r.readAsArrayBuffer(file);
}

// ì¹´ë“œë³„ ì´ë²¤íŠ¸ ë“±ë¡
[0,1,2,3].forEach(i => {
  const inp  = document.getElementById('file'+i);
  const card = document.getElementById('drop'+i);

  inp.addEventListener('change', e => {
    if (e.target.files[0]) loadWb(e.target.files[0], i);
  });
  card.addEventListener('dragover',  e => { e.preventDefault(); card.classList.add('drag-over'); });
  card.addEventListener('dragleave', () => card.classList.remove('drag-over'));
  card.addEventListener('drop', e => {
    e.preventDefault(); card.classList.remove('drag-over');
    if (e.dataTransfer.files[0]) loadWb(e.dataTransfer.files[0], i);
  });
});

function updateBtns() {
  document.getElementById('btnCode').disabled = !(wbs[0] && (wbs[1]||wbs[2]));
  document.getElementById('btnStd').disabled  = !(wbs[0] && wbs[3]);
}

// â”€â”€ Excel Utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function normH(s)    { return String(s||'').replace(/\s/g,''); }
function normSpec(s) { return String(s||'').replace(/\s/g,''); }

function sheetRows(wb, sn) {
  const sh = wb.Sheets[sn]; if(!sh) return null;
  return XLSX.utils.sheet_to_json(sh, {header:1, defval:''});
}

function findHdrRow(rows) {
  for(let i=0;i<Math.min(10,rows.length);i++)
    if(rows[i].some(c=>normH(c)==='ì½”ë“œ')) return i;
  return 2;
}

function colIdx(hdr) {
  return {
    ci: hdr.findIndex(c=>normH(c)==='ì½”ë“œ'),
    ni: hdr.findIndex(c=>normH(c)==='í’ˆëª…'),
    si: hdr.findIndex(c=>normH(c)==='ê·œê²©'),
    ui: hdr.findIndex(c=>normH(c)==='ë‹¨ìœ„'),
  };
}

// Build codeâ†’{name,spec,unit,src} map from a workbook
// preferSheets: try these first, then rest of SheetNames
function buildMap(wb, preferSheets) {
  const map = new Map();
  const tried = new Set();
  for(const sn of [...preferSheets, ...wb.SheetNames]) {
    if(tried.has(sn)) continue; tried.add(sn);
    const rows = sheetRows(wb, sn); if(!rows) continue;
    const hr = findHdrRow(rows);
    const {ci,ni,si,ui} = colIdx(rows[hr]);
    if(ci<0) continue;
    for(let r=hr+1; r<rows.length; r++) {
      const code = String(rows[r][ci]||'').trim();
      if(!code || /^[0-9]{1,2}$/.test(code)) continue;
      if(!map.has(code)) map.set(code, {
        name: ni>=0 ? String(rows[r][ni]||'').trim() : '',
        spec: si>=0 ? String(rows[r][si]||'').trim() : '',
        unit: ui>=0 ? String(rows[r][ui]||'').trim() : '',
        src:  sn,
      });
    }
  }
  return map;
}

// Parse ì›ë‚´ì—­ â†’ array of items
function parseSource(wb) {
  const snPri = ['ì›ë‚´ì—­','ë‚´ì—­','Sheet1'];
  const sn = snPri.find(s=>wb.SheetNames.includes(s)) || wb.SheetNames[0];
  const rows = sheetRows(wb, sn);
  if(!rows) throw new Error('ì›ë‚´ì—­ ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
  const hr = findHdrRow(rows);
  const {ci,ni,si,ui} = colIdx(rows[hr]);
  const out = [];
  for(let r=hr+1; r<rows.length; r++) {
    const code = String(rows[r][ci]||'').trim();
    if(!code) continue;
    if(/^[0-9]{1,2}$/.test(code)) {
      out.push({isSection:true, code, name:String(rows[r][ni]||'').trim()});
      continue;
    }
    out.push({
      isSection:false, row:r+1, code,
      name: ni>=0 ? String(rows[r][ni]||'').trim() : '',
      spec: si>=0 ? String(rows[r][si]||'').trim() : '',
      unit: ui>=0 ? String(rows[r][ui]||'').trim() : '',
    });
  }
  return out;
}

// â”€â”€ CODE CHECK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function runCodeCheck() {
  loading();
  setTimeout(()=>{
    try {
      // DB: ìì¬ë¦¬ìŠ¤íŠ¸(wbs[1]) + ì¼ìœ„ëŒ€ê°€ë¦¬ìŠ¤íŠ¸(wbs[2]) ë§Œ ì‚¬ìš©
      const dbMap = new Map();
      if(wbs[1]) buildMap(wbs[1],['ìì¬ë¦¬ìŠ¤íŠ¸']).forEach((v,k)=>{ if(!dbMap.has(k)) dbMap.set(k,v); });
      if(wbs[2]) buildMap(wbs[2],['ì¼ìœ„ëŒ€ê°€ë¦¬ìŠ¤íŠ¸']).forEach((v,k)=>{ if(!dbMap.has(k)) dbMap.set(k,v); });

      const items = parseSource(wbs[0]);
      codeRes = items.map(item=>{
        if(item.isSection) return item;
        const db = dbMap.get(item.code);
        if(!db) return {...item, status:'miss', db:null};

        const sS=normSpec(item.spec), dS=normSpec(db.spec);
        const sU=item.unit.trim(),    dU=(db.unit||'').trim();
        const sN=item.name.trim(),    dN=(db.name||'').trim();

        const sdiff = dS!==sS && (dS||sS);
        const udiff = dU!==sU && (dU||sU);
        const ndiff = dN!==sN && (dN||sN);

        return {...item, status:(sdiff||udiff||ndiff)?'diff':'ok', db, sdiff, udiff, ndiff};
      });

      curTab='code'; curFilter='all'; curSearch='';
      renderCode();
      showTabs();
      document.getElementById('btnExport').disabled=false;
    } catch(e){ errMsg(e.message); }
  },30);
}

function renderCode() {
  const f=curFilter, q=curSearch;
  const visible = codeRes.filter(r=>{
    if(r.isSection) return f==='all' && !q;
    if(q && !r.code.toLowerCase().includes(q) && !r.name.toLowerCase().includes(q)) return false;
    if(f==='all') return true;
    return r.status===f;
  });

  const items = codeRes.filter(r=>!r.isSection);
  const N  = items.length;
  const ok = items.filter(r=>r.status==='ok').length;
  const df = items.filter(r=>r.status==='diff').length;
  const ms = items.filter(r=>r.status==='miss').length;
  const nc = items.filter(r=>r.status==='nocode').length;

  setStats(`
    <div class="stats-bar">
      <div class="stat-card"><div class="stat-label">ì „ì²´</div><div class="stat-val v-blue">${N}</div></div>
      <div class="stat-card"><div class="stat-label">âœ… ì¼ì¹˜</div><div class="stat-val v-green">${ok}</div></div>
      <div class="stat-card"><div class="stat-label">âš  ì½”ë“œìƒì´</div><div class="stat-val v-yellow">${df}</div></div>
      <div class="stat-card"><div class="stat-label">âŒ DBì—†ìŒ</div><div class="stat-val v-red">${ms}</div></div>
      ${nc>0?`<div class="stat-card"><div class="stat-label">â€” ë¯¸í™•ì¸</div><div class="stat-val v-cyan">${nc}</div></div>`:''}
    </div>`);

  setFilter(`
    <button class="fbtn ${f==='all'?'fa-all':''}"    onclick="sf('all','code')">ì „ì²´ ${N}</button>
    <button class="fbtn ${f==='ok'?'fa-ok':''}"      onclick="sf('ok','code')">âœ… ì¼ì¹˜ ${ok}</button>
    <button class="fbtn ${f==='diff'?'fa-diff':''}"  onclick="sf('diff','code')">âš  ì½”ë“œìƒì´ ${df}</button>
    <button class="fbtn ${f==='miss'?'fa-miss':''}"  onclick="sf('miss','code')">âŒ DBì—†ìŒ ${ms}</button>
    ${nc>0?`<button class="fbtn ${f==='nocode'?'fa-nocode':''}" onclick="sf('nocode','code')">â€” ë¯¸í™•ì¸ ${nc}</button>`:''}
    <input class="search-input" id="si" placeholder="ì½”ë“œÂ·í’ˆëª… ê²€ìƒ‰..." value="${esc(q)}" oninput="ss(this.value,'code')">`);

  setHint('');

  if(!visible.length){ emptyMsg('ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ'); return; }

  let h=`<table><thead><tr>
    <th>í–‰</th><th>ì½”ë“œ</th><th>í’ˆëª… (ì›ë‚´ì—­)</th><th>ê·œê²© (ì›ë‚´ì—­)</th><th>ë‹¨ìœ„</th>
    <th>DB í’ˆëª…</th><th>DB ê·œê²©</th><th>DB ë‹¨ìœ„</th><th>ì¶œì²˜</th><th>ê²°ê³¼</th>
  </tr></thead><tbody>`;

  for(const r of visible){
    if(r.isSection){ h+=`<tr class="sec-row"><td colspan="10">â–¶ ${esc(r.name||r.code)}</td></tr>`; continue; }
    h+=`<tr>
      <td class="tr">${r.row}</td>
      <td class="tc">${esc(r.code)}</td>
      <td class="tn">${esc(r.name)}</td>
      <td class="ts">${esc(r.spec)}</td>
      <td class="tu">${esc(r.unit)}</td>
      <td class="ts ${r.ndiff?'hl':''}">${esc(r.db?.name||'')}</td>
      <td class="ts ${r.sdiff?'hl':''}">${esc(r.db?.spec||'')}</td>
      <td class="tu ${r.udiff?'hl':''}">${esc(r.db?.unit||'')}</td>
      <td class="ts" style="font-size:10px;color:var(--text-dim)">${esc(r.db?.src||'')}</td>
      <td>${codeBadge(r.status)}</td>
    </tr>`;
  }
  h+='</tbody></table>';
  document.getElementById('tableWrap').innerHTML=h;
}

function codeBadge(s){
  const m={ok:['bk','âœ“ ì¼ì¹˜'],diff:['bd','âš  ì½”ë“œìƒì´'],miss:['bm','âœ• DBì—†ìŒ'],nocode:['bn','â€” ë¯¸í™•ì¸']};
  const [c,l]=m[s]||['bn',s];
  return `<span class="badge ${c}">${l}</span>`;
}

// â”€â”€ STANDARD CHECK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function runStdCheck() {
  loading();
  setTimeout(()=>{
    try {
      // ì›ë‚´ì—­ ì „ì²´(ì„¹ì…˜ í¬í•¨) íŒŒì‹±
      const allSrc   = parseSource(wbs[0]);
      const wonItems = allSrc.filter(r=>!r.isSection);
      const wonCodes = new Set(wonItems.map(r=>r.code));

      // í‘œì¤€ë‚´ì—­ map
      const stdMap = buildMap(wbs[3], ['í‘œì¤€ë‚´ì—­']);

      // â”€â”€ ì›ë‚´ì—­ ê³µì¢… ì„¹ì…˜ êµ¬ì¡° íŒŒì•… â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const sections = [];
      let curSec = null;
      for(const item of allSrc){
        if(item.isSection){
          curSec = { secCode:item.code, secName:item.name, wonItems:[], stdOnlyItems:[] };
          sections.push(curSec);
        } else {
          if(!curSec){
            curSec = { secCode:'', secName:'ê³µì¢…ë¯¸ë¶„ë¥˜', wonItems:[], stdOnlyItems:[] };
            sections.push(curSec);
          }
          curSec.wonItems.push(item);
        }
      }

      // â”€â”€ í‘œì¤€ë‚´ì—­ ì½”ë“œì— ê³µì¢… ë°°ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // í‘œì¤€ë‚´ì—­ íŒŒì¼ ì„¹ì…˜ ë§µ ìƒì„± (ì½”ë“œ â†’ ì„¹ì…˜ì½”ë“œ)
      const stdSecMap = buildStdSectionMap(wbs[3]);

      // í‘œì¤€ë‚´ì—­ì—ë§Œ ìˆëŠ” í•­ëª© â†’ ì›ë‚´ì—­ ì„¹ì…˜ì— ë°°ì •
      stdMap.forEach((v, code)=>{
        if(wonCodes.has(code)) return;

        const stdSecCode = stdSecMap.get(code) || '';
        let targetSec = sections.find(s=>s.secCode === stdSecCode);

        if(!targetSec){
          if(!sections.find(s=>s.secCode==='__only2__')){
            sections.push({ secCode:'__only2__', secName:'í‘œì¤€ë‚´ì—­ì—ë§Œ ì¡´ì¬', wonItems:[], stdOnlyItems:[] });
          }
          targetSec = sections.find(s=>s.secCode==='__only2__');
        }
        targetSec.stdOnlyItems.push({
          isSection:false, code, name:v.name, spec:v.spec, unit:v.unit,
          status:'only2', si:v
        });
      });

      // â”€â”€ stdRes ì¡°ë¦½: ì›ë‚´ì—­ ê³µì¢… ìˆœì„œ ê·¸ëŒ€ë¡œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      stdRes = [];
      for(const sec of sections){
        const hasContent = sec.wonItems.length > 0 || sec.stdOnlyItems.length > 0;
        if(!hasContent) continue;

        // ì„¹ì…˜ í—¤ë”
        if(sec.secCode === '__only2__'){
          stdRes.push({ isSection:true, code:'', name:'ğŸ“ í‘œì¤€ë‚´ì—­ì—ë§Œ ì¡´ì¬í•˜ëŠ” í•­ëª©' });
        } else if(sec.secCode){
          stdRes.push({ isSection:true, code:sec.secCode, name:sec.secName });
        }

        // ì›ë‚´ì—­ í•­ëª© (ì›ë‚´ì—­ ìˆœì„œ ìœ ì§€)
        for(const item of sec.wonItems){
          if(stdMap.has(item.code)){
            stdRes.push({...item, status:'both', si:stdMap.get(item.code)});
          } else {
            stdRes.push({...item, status:'only1'});
          }
        }

        // í•´ë‹¹ ê³µì¢…ì˜ í‘œì¤€ë‚´ì—­ only í•­ëª©
        for(const item of sec.stdOnlyItems){
          stdRes.push(item);
        }
      }

      curTab='std'; curFilter='all'; curSearch='';
      renderStd();
      showTabs();
      document.getElementById('btnExport').disabled=false;
    } catch(e){ errMsg(e.message); }
  },30);
}

// í‘œì¤€ë‚´ì—­ íŒŒì¼ì—ì„œ ì½”ë“œâ†’ì„¹ì…˜ì½”ë“œ ë§¤í•‘ ìƒì„±
function buildStdSectionMap(wb){
  const map = new Map();
  const snList = ['í‘œì¤€ë‚´ì—­', ...wb.SheetNames];
  const tried = new Set();
  for(const sn of snList){
    if(tried.has(sn)) continue; tried.add(sn);
    const rows = sheetRows(wb, sn); if(!rows) continue;
    const hr = findHdrRow(rows);
    const {ci} = colIdx(rows[hr]);
    if(ci<0) continue;
    let curSec = '';
    for(let r=hr+1; r<rows.length; r++){
      const code = String(rows[r][ci]||'').trim();
      if(!code) continue;
      if(/^[0-9]{1,2}$/.test(code)){ curSec=code; continue; }
      map.set(code, curSec);
    }
    break;
  }
  return map;
}

function renderStd(){
  const f=curFilter, q=curSearch;
  const only1 = stdRes.filter(r=>!r.isSection && r.status==='only1');
  const only2 = stdRes.filter(r=>!r.isSection && r.status==='only2');
  const both  = stdRes.filter(r=>!r.isSection && r.status==='both');

  const visible = stdRes.filter(r=>{
    // ì„¹ì…˜ í—¤ë”: í•„í„°ê°€ allì´ê³  ê²€ìƒ‰ì–´ ì—†ì„ ë•Œ, ë˜ëŠ” í•´ë‹¹ ì„¹ì…˜ ì•„ë˜ visible í•­ëª©ì´ ìˆì„ ë•Œ í‘œì‹œ
    if(r.isSection){
      if(q) return false; // ê²€ìƒ‰ ì¤‘ì—” ì„¹ì…˜ ìˆ¨ê¹€
      if(f==='all') return true;
      // í•„í„° í™œì„± ì‹œ: í•´ë‹¹ ì„¹ì…˜ì½”ë“œ ì•„ë˜ì— visible í•­ëª©ì´ ìˆëŠ”ì§€ í™•ì¸
      const secIdx = stdRes.indexOf(r);
      for(let i=secIdx+1; i<stdRes.length; i++){
        if(stdRes[i].isSection) break;
        if(stdRes[i].status===f) return true;
      }
      return false;
    }
    if(q && !r.code.toLowerCase().includes(q) && !r.name.toLowerCase().includes(q)) return false;
    if(f==='all') return true;
    return r.status===f;
  });

  setStats(`
    <div class="stats-bar">
      <div class="stat-card"><div class="stat-label">ì›ë‚´ì—­ í•­ëª© ìˆ˜</div><div class="stat-val v-blue">${only1.length+both.length}</div></div>
      <div class="stat-card"><div class="stat-label">í‘œì¤€ë‚´ì—­ í•­ëª© ìˆ˜</div><div class="stat-val v-purple">${only2.length+both.length}</div></div>
      <div class="stat-card"><div class="stat-label">âš¡ ì›ë‚´ì—­ì—ë§Œ ì¡´ì¬</div><div class="stat-val v-blue">${only1.length}</div></div>
      <div class="stat-card"><div class="stat-label">ğŸ“ í‘œì¤€ë‚´ì—­ì—ë§Œ ì¡´ì¬</div><div class="stat-val v-purple">${only2.length}</div></div>
      <div class="stat-card"><div class="stat-label">âœ… ì–‘ìª½ ëª¨ë‘ ì¡´ì¬</div><div class="stat-val v-green">${both.length}</div></div>
    </div>`);

  setFilter(`
    <button class="fbtn ${f==='all'?'fa-all':''}"    onclick="sf('all','std')">ì „ì²´ ${stdRes.length}</button>
    <button class="fbtn ${f==='only1'?'fa-only1':''}" onclick="sf('only1','std')">âš¡ ì›ë‚´ì—­ë§Œ ${only1.length}</button>
    <button class="fbtn ${f==='only2'?'fa-only2':''}" onclick="sf('only2','std')">ğŸ“ í‘œì¤€ë‚´ì—­ë§Œ ${only2.length}</button>
    <button class="fbtn ${f==='both'?'fa-both':''}"   onclick="sf('both','std')">âœ… ì–‘ìª½ ëª¨ë‘ ${both.length}</button>
    <input class="search-input" id="si" placeholder="ì½”ë“œÂ·í’ˆëª… ê²€ìƒ‰..." value="${esc(q)}" oninput="ss(this.value,'std')">`);

  setHint(`
    <b>âš¡ ì›ë‚´ì—­ë§Œ ì¡´ì¬</b> (${only1.length}ê±´): ì›ë‚´ì—­ì—ëŠ” ìˆìœ¼ë‚˜ í‘œì¤€ë‚´ì—­ì— ì—†ëŠ” í•­ëª© &nbsp;|&nbsp;
    <b>ğŸ“ í‘œì¤€ë‚´ì—­ë§Œ ì¡´ì¬</b> (${only2.length}ê±´): í‘œì¤€ë‚´ì—­ì—ëŠ” ìˆìœ¼ë‚˜ ì›ë‚´ì—­ì— ì—†ëŠ” í•­ëª© &nbsp;|&nbsp;
    <b>âœ… ì–‘ìª½ ëª¨ë‘</b> (${both.length}ê±´): ë‘ ë‚´ì—­ ëª¨ë‘ì— ì½”ë“œ ì¡´ì¬`);

  if(!visible.length){ emptyMsg('ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ'); return; }

  let h=`<table><thead><tr>
    <th>êµ¬ë¶„</th>
    <th>ì½”ë“œ</th>
    <th>ì›ë‚´ì—­ í’ˆëª…</th><th>ì›ë‚´ì—­ ê·œê²©</th><th>ì›ë‚´ì—­ ë‹¨ìœ„</th>
    <th>í‘œì¤€ë‚´ì—­ í’ˆëª…</th><th>í‘œì¤€ë‚´ì—­ ê·œê²©</th><th>í‘œì¤€ë‚´ì—­ ë‹¨ìœ„</th>
  </tr></thead><tbody>`;

  for(const r of visible){
    // ì„¹ì…˜ í—¤ë” í–‰
    if(r.isSection){
      const secLabel = r.code ? `[${esc(r.code)}] ${esc(r.name||r.code)}` : esc(r.name||'');
      h+=`<tr class="sec-row"><td colspan="8">â–¶ ${secLabel}</td></tr>`;
      continue;
    }
    const si = r.si||{};
    const isOnly2 = r.status==='only2';

    const wName = isOnly2 ? `<span style="color:var(--text-dim)">â€”</span>` : esc(r.name);
    const wSpec = isOnly2 ? `<span style="color:var(--text-dim)">â€”</span>` : esc(r.spec);
    const wUnit = isOnly2 ? `<span style="color:var(--text-dim)">â€”</span>` : esc(r.unit);
    const sColor = isOnly2 ? 'color:var(--purple)' : 'color:var(--text-muted)';

    h+=`<tr>
      <td>${stdBadge(r.status)}</td>
      <td class="tc">${esc(r.code)}</td>
      <td class="tn">${wName}</td>
      <td class="ts">${wSpec}</td>
      <td class="tu">${wUnit}</td>
      <td class="ts" style="${sColor}">${esc(si.name||'')}</td>
      <td class="ts" style="${sColor}">${esc(si.spec||'')}</td>
      <td class="tu" style="${sColor}">${esc(si.unit||'')}</td>
    </tr>`;
  }
  h+='</tbody></table>';
  document.getElementById('tableWrap').innerHTML=h;
}

function stdBadge(s){
  const m={only1:['b1','âš¡ ì›ë‚´ì—­ë§Œ'],only2:['b2','ğŸ“ í‘œì¤€ë‚´ì—­ë§Œ'],both:['bb','âœ… ì–‘ìª½']};
  const [c,l]=m[s]||['bn',s];
  return `<span class="badge ${c}">${l}</span>`;
}

// â”€â”€ Tabs / Filter / Search â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showTabs(){
  document.getElementById('modeTabs').style.display='flex';
  document.getElementById('tabCode').className = 'mode-tab'+(curTab==='code'?' tab-blue':'');
  document.getElementById('tabStd').className  = 'mode-tab'+(curTab==='std'?' tab-purple':'');
}

function switchTab(tab){
  curTab=tab; curFilter='all'; curSearch='';
  showTabs();
  if(tab==='code' && codeRes.length) renderCode();
  else if(tab==='std' && stdRes.length) renderStd();
}

function sf(f, mode){ curFilter=f; mode==='code'?renderCode():renderStd(); }
function ss(v, mode){ curSearch=v.toLowerCase(); mode==='code'?renderCode():renderStd(); }

// â”€â”€ Export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportResult(){
  const wb = XLSX.utils.book_new();

  if(codeRes.length){
    const rows=[['í–‰','ì½”ë“œ','í’ˆëª…','ê·œê²©','ë‹¨ìœ„','DB í’ˆëª…','DB ê·œê²©','DB ë‹¨ìœ„','ì¶œì²˜','ê²°ê³¼']];
    const lbl={ok:'ì¼ì¹˜',diff:'ì½”ë“œìƒì´',miss:'í˜„ì¥ì½”ë“œ(DBì—†ìŒ)',nocode:'ë¯¸í™•ì¸'};
    for(const r of codeRes){
      if(r.isSection){ rows.push([`â–¶ ${r.name||r.code}`,'','','','','','','','','']); continue; }
      rows.push([r.row,r.code,r.name,r.spec,r.unit,r.db?.name||'',r.db?.spec||'',r.db?.unit||'',r.db?.src||'',lbl[r.status]||r.status]);
    }
    const ws=XLSX.utils.aoa_to_sheet(rows);
    ws['!cols']=[5,14,22,24,6,22,24,6,12,12].map(w=>({wch:w}));
    XLSX.utils.book_append_sheet(wb,ws,'ì½”ë“œê²€í† ê²°ê³¼');
  }

  if(stdRes.length){
    const rows=[['êµ¬ë¶„','ì½”ë“œ','ì›ë‚´ì—­ í’ˆëª…','ì›ë‚´ì—­ ê·œê²©','ì›ë‚´ì—­ ë‹¨ìœ„','í‘œì¤€ë‚´ì—­ í’ˆëª…','í‘œì¤€ë‚´ì—­ ê·œê²©','í‘œì¤€ë‚´ì—­ ë‹¨ìœ„']];
    const lbl={only1:'ì›ë‚´ì—­ë§Œ',only2:'í‘œì¤€ë‚´ì—­ë§Œ',both:'ì–‘ìª½ëª¨ë‘'};
    for(const r of stdRes){
      if(r.isSection){ rows.push([`â–¶ ${r.code?'['+r.code+'] ':''}${r.name||''}`,'','','','','','','']); continue; }
      const si=r.si||{};
      rows.push([lbl[r.status]||r.status,r.code,r.name||'',r.spec||'',r.unit||'',si.name||'',si.spec||'',si.unit||'']);
    }
    const ws=XLSX.utils.aoa_to_sheet(rows);
    ws['!cols']=[12,14,22,24,6,22,24,6].map(w=>({wch:w}));
    XLSX.utils.book_append_sheet(wb,ws,'í‘œì¤€ë‚´ì—­ë¹„êµê²°ê³¼');
  }

  if(!wb.SheetNames.length){ alert('ë‚´ë³´ë‚¼ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤'); return; }
  XLSX.writeFile(wb, `ì½”ë“œì²´í¬ê²°ê³¼_${new Date().toISOString().slice(0,10)}.xlsx`);
}

// â”€â”€ Reset â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resetAll(){
  [0,1,2,3].forEach(i=>{
    clearSlot(i);
    document.getElementById('file'+i).value='';
  });
  codeRes=[]; stdRes=[]; curTab=''; curFilter='all'; curSearch='';
  updateBtns();
  document.getElementById('btnExport').disabled=true;
  document.getElementById('modeTabs').style.display='none';
  setStats(''); setFilter(''); setHint('');
  document.getElementById('tableWrap').innerHTML=
    `<div class="empty"><div class="ico">ğŸ“‹</div><p>ì›ë‚´ì—­ + ìì¬ë¦¬ìŠ¤íŠ¸/ì¼ìœ„ëŒ€ê°€ë¦¬ìŠ¤íŠ¸ë¥¼ ì—…ë¡œë“œ í›„<br><b>ì½”ë“œ ê²€í†  ì‹¤í–‰</b> í´ë¦­<br><br>í‘œì¤€ë‚´ì—­ í•­ëª© ë¹„êµëŠ” í‘œì¤€ë‚´ì—­ë„ ì—…ë¡œë“œ í›„<br><b>í‘œì¤€ë‚´ì—­ ë¹„êµ</b> í´ë¦­</p></div>`;
}

// â”€â”€ DOM helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loading(){ document.getElementById('tableWrap').innerHTML='<div class="loading"><div class="spin"></div>ë¶„ì„ ì¤‘...</div>'; setStats(''); setFilter(''); setHint(''); }
function errMsg(m){ document.getElementById('tableWrap').innerHTML=`<div class="empty"><div class="ico">âŒ</div><p>ì˜¤ë¥˜: ${esc(m)}</p></div>`; }
function emptyMsg(m){ document.getElementById('tableWrap').innerHTML=`<div class="empty"><div class="ico">ğŸ”</div><p>${m}</p></div>`; }
function setStats(h){ document.getElementById('statsArea').innerHTML=h; }
function setFilter(h){ document.getElementById('filterArea').innerHTML=h; }
function setHint(h){
  const el=document.getElementById('hintArea');
  if(h){ el.className='hint-box'; el.innerHTML=h; }
  else { el.className=''; el.innerHTML=''; }
}
</script>
</body>
</html>
