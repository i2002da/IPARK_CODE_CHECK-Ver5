<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë‚´ì—­ ì½”ë“œ ì²´í¬ ì‹œìŠ¤í…œ</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=JetBrains+Mono:wght@400;700&display=swap');

  :root {
    --bg: #0d0f14;
    --surface: #141820;
    --surface2: #1c2230;
    --border: #252d3d;
    --accent: #3b82f6;
    --accent2: #22d3ee;
    --warn: #f59e0b;
    --danger: #ef4444;
    --success: #10b981;
    --purple: #a855f7;
    --text: #e2e8f0;
    --text-dim: #64748b;
    --text-muted: #94a3b8;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Noto Sans KR', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(59,130,246,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(59,130,246,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  .container { max-width: 1700px; margin: 0 auto; padding: 24px; position: relative; z-index: 1; }

  header {
    display: flex; align-items: center; gap: 14px;
    margin-bottom: 28px; padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
  }
  .logo {
    width: 42px; height: 42px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 20px; flex-shrink: 0;
  }
  h1 { font-size: 20px; font-weight: 700; letter-spacing: -0.5px; }
  h1 span { color: var(--accent); }
  .subtitle { font-size: 11px; color: var(--text-dim); margin-top: 2px; font-family: 'JetBrains Mono', monospace; }

  /* Upload grid */
  .upload-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin-bottom: 20px;
  }

  .upload-card {
    background: var(--surface);
    border: 1.5px dashed var(--border);
    border-radius: 10px;
    padding: 16px 14px;
    cursor: pointer;
    position: relative;
    transition: border-color 0.2s, background 0.2s;
  }
  .upload-card:hover, .upload-card.drag-over {
    border-color: var(--accent);
    background: rgba(59,130,246,0.05);
  }
  .upload-card.loaded { border-style: solid; }
  .upload-card.c-blue   { border-color: var(--accent); }
  .upload-card.c-green  { border-color: var(--success); }
  .upload-card.c-warn   { border-color: var(--warn); }
  .upload-card.c-purple { border-color: var(--purple); }

  .upload-card input[type="file"] {
    position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%;
  }

  .uc-head { display: flex; align-items: center; gap: 7px; margin-bottom: 5px; }
  .uc-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
  .d-blue   { background: var(--accent); }
  .d-green  { background: var(--success); }
  .d-warn   { background: var(--warn); }
  .d-purple { background: var(--purple); }
  .uc-label { font-size: 12px; font-weight: 700; }

  .uc-badge {
    margin-left: auto;
    padding: 2px 7px; border-radius: 10px;
    font-size: 10px; font-weight: 600;
  }
  .req  { background: rgba(239,68,68,0.15); color: var(--danger); }
  .opt  { background: rgba(100,116,139,0.12); color: var(--text-dim); }

  .uc-desc { font-size: 11px; color: var(--text-dim); margin-bottom: 8px; }
  .uc-fn {
    font-size: 11px; color: var(--text-dim);
    font-family: 'JetBrains Mono', monospace;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .uc-fn.ok { color: var(--success); }

  /* Action bar */
  .action-bar {
    display: flex; align-items: center; gap: 10px;
    margin-bottom: 20px; flex-wrap: wrap;
  }
  .vsep { width: 1px; height: 28px; background: var(--border); }

  .btn {
    padding: 9px 18px; border-radius: 8px;
    font-size: 13px; font-weight: 600;
    font-family: 'Noto Sans KR', sans-serif;
    border: none; cursor: pointer;
    transition: all 0.15s;
    display: flex; align-items: center; gap: 6px;
    white-space: nowrap;
  }
  .btn:disabled { opacity: 0.35; cursor: not-allowed; transform: none !important; }

  .btn-blue   { background: var(--accent);  color: white; }
  .btn-blue:not(:disabled):hover   { background: #2563eb; transform: translateY(-1px); }
  .btn-purple { background: var(--purple);  color: white; }
  .btn-purple:not(:disabled):hover { background: #9333ea; transform: translateY(-1px); }
  .btn-outline {
    background: transparent; color: var(--text-muted);
    border: 1px solid var(--border);
  }
  .btn-outline:not(:disabled):hover { border-color: var(--accent); color: var(--accent); }

  /* Mode tabs */
  .mode-tabs {
    display: flex; gap: 0;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 10px; padding: 4px;
    width: fit-content; margin-bottom: 16px;
  }
  .mode-tab {
    padding: 7px 18px; border-radius: 7px;
    font-size: 12px; font-weight: 600;
    font-family: 'Noto Sans KR', sans-serif;
    border: none; cursor: pointer;
    background: transparent; color: var(--text-dim);
    transition: all 0.15s;
  }
  .tab-blue   { background: var(--accent); color: white; }
  .tab-purple { background: var(--purple); color: white; }

  /* Stats */
  .stats-bar { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; }
  .stat-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 8px; padding: 10px 14px; min-width: 110px;
  }
  .stat-label { font-size: 10px; color: var(--text-dim); margin-bottom: 4px; letter-spacing: 0.5px; text-transform: uppercase; }
  .stat-val { font-size: 22px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
  .v-blue   { color: var(--accent); }
  .v-green  { color: var(--success); }
  .v-yellow { color: var(--warn); }
  .v-red    { color: var(--danger); }
  .v-cyan   { color: var(--accent2); }
  .v-purple { color: var(--purple); }

  /* Filter bar */
  .filter-bar {
    display: flex; gap: 8px; margin-bottom: 12px;
    flex-wrap: wrap; align-items: center;
  }
  .fbtn {
    padding: 5px 12px; border-radius: 20px;
    font-size: 11px; font-weight: 600;
    font-family: 'Noto Sans KR', sans-serif;
    border: 1px solid var(--border);
    background: transparent; color: var(--text-muted);
    cursor: pointer; transition: all 0.15s;
  }
  .fbtn:hover { border-color: var(--accent); color: var(--accent); }
  .fa-all    { background: var(--accent);   border-color: var(--accent);   color: white; }
  .fa-ok     { background: var(--success);  border-color: var(--success);  color: white; }
  .fa-diff   { background: var(--warn);     border-color: var(--warn);     color: white; }
  .fa-miss   { background: var(--danger);   border-color: var(--danger);   color: white; }
  .fa-nocode { background: var(--text-dim); border-color: var(--text-dim); color: white; }
  .fa-only1  { background: var(--accent);   border-color: var(--accent);   color: white; }
  .fa-only2  { background: var(--purple);   border-color: var(--purple);   color: white; }
  .fa-both   { background: var(--success);  border-color: var(--success);  color: white; }

  .search-input {
    padding: 5px 12px; background: var(--surface);
    border: 1px solid var(--border); border-radius: 8px;
    color: var(--text); font-size: 12px;
    font-family: 'Noto Sans KR', sans-serif;
    width: 200px; outline: none; margin-left: auto;
  }
  .search-input:focus { border-color: var(--accent); }

  /* Hint box */
  .hint-box {
    background: rgba(168,85,247,0.06); border: 1px solid rgba(168,85,247,0.2);
    border-radius: 8px; padding: 10px 14px;
    font-size: 11px; color: var(--text-muted);
    margin-bottom: 12px; line-height: 1.8;
  }
  .hint-box b { color: var(--purple); }

  /* Table */
  .table-wrapper {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 10px; overflow: hidden;
  }
  .table-scroll { max-height: 60vh; overflow-y: auto; }
  .table-scroll::-webkit-scrollbar { width: 5px; }
  .table-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  table { width: 100%; border-collapse: collapse; font-size: 12px; }
  thead tr { background: var(--surface2); }
  th {
    padding: 9px 12px; text-align: left;
    font-size: 10px; font-weight: 700; color: var(--text-dim);
    letter-spacing: 0.6px; text-transform: uppercase; white-space: nowrap;
    position: sticky; top: 0; background: var(--surface2); z-index: 10;
    border-bottom: 1px solid var(--border);
  }
  tbody tr { border-bottom: 1px solid rgba(37,45,61,0.5); transition: background 0.1s; }
  tbody tr:hover { background: rgba(59,130,246,0.04); }
  tbody tr:last-child { border-bottom: none; }
  td { padding: 8px 12px; vertical-align: middle; }

  .tc   { font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--accent2); white-space: nowrap; }
  .tn   { font-weight: 500; }
  .ts   { color: var(--text-muted); font-size: 11px; }
  .tu   { color: var(--text-dim); font-size: 11px; text-align: center; }
  .tr   { color: var(--text-dim); font-size: 10px; font-family: 'JetBrains Mono', monospace; text-align: center; }
  .hl   { color: var(--warn); }

  tr.sec-row td {
    background: rgba(59,130,246,0.07);
    color: var(--accent); font-weight: 700; font-size: 11px;
    border-bottom: 1px solid rgba(59,130,246,0.15);
  }

  .badge {
    display: inline-flex; align-items: center; gap: 3px;
    padding: 2px 8px; border-radius: 4px;
    font-size: 10px; font-weight: 700; white-space: nowrap;
  }
  .bk  { background: rgba(16,185,129,0.15);  color: var(--success); }
  .bd  { background: rgba(245,158,11,0.15);   color: var(--warn); }
  .bm  { background: rgba(239,68,68,0.15);    color: var(--danger); }
  .bn  { background: rgba(100,116,139,0.1);   color: var(--text-muted); }
  .b1  { background: rgba(59,130,246,0.15);   color: var(--accent); }
  .b2  { background: rgba(168,85,247,0.15);   color: var(--purple); }
  .bb  { background: rgba(16,185,129,0.15);   color: var(--success); }

  .loading {
    display: flex; align-items: center; justify-content: center;
    padding: 60px; gap: 12px; color: var(--text-dim); font-size: 14px;
  }
  .spin {
    width: 18px; height: 18px;
    border: 2px solid var(--border); border-top-color: var(--accent);
    border-radius: 50%; animation: spin 0.7s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .empty {
    padding: 70px; text-align: center; color: var(--text-dim);
  }
  .empty .ico { font-size: 42px; margin-bottom: 12px; }
  .empty p { font-size: 13px; line-height: 1.9; }

  /* â”€â”€ Login Overlay â”€â”€ */
  #loginOverlay {
    position: fixed; inset: 0; z-index: 9999;
    background: var(--bg);
    display: flex; align-items: center; justify-content: center;
  }
  #loginOverlay::before {
    content: '';
    position: fixed; inset: 0;
    background-image:
      linear-gradient(rgba(59,130,246,0.04) 1px, transparent 1px),
      linear-gradient(90deg, rgba(59,130,246,0.04) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
  }
  .login-box {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; padding: 40px 36px;
    width: 380px; position: relative; z-index: 1;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  }
  .login-logo {
    width: 52px; height: 52px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border-radius: 14px;
    display: flex; align-items: center; justify-content: center;
    font-size: 24px; margin: 0 auto 20px;
  }
  .login-title {
    text-align: center; font-size: 18px; font-weight: 700;
    margin-bottom: 4px;
  }
  .login-title span { color: var(--accent); }
  .login-sub {
    text-align: center; font-size: 11px; color: var(--text-dim);
    font-family: 'JetBrains Mono', monospace; margin-bottom: 28px;
  }
  .login-field { margin-bottom: 14px; }
  .login-field label {
    display: block; font-size: 11px; font-weight: 600;
    color: var(--text-muted); margin-bottom: 6px; letter-spacing: 0.4px;
  }
  .login-field input {
    width: 100%; padding: 10px 14px;
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 8px; color: var(--text); font-size: 13px;
    font-family: 'Noto Sans KR', sans-serif; outline: none;
    transition: border-color 0.2s;
  }
  .login-field input:focus { border-color: var(--accent); }
  .login-error {
    font-size: 11px; color: var(--danger);
    text-align: center; margin-bottom: 10px; min-height: 16px;
  }
  .btn-login {
    width: 100%; padding: 11px; border-radius: 8px;
    background: var(--accent); color: white;
    font-size: 13px; font-weight: 700;
    font-family: 'Noto Sans KR', sans-serif;
    border: none; cursor: pointer; margin-top: 6px;
    transition: background 0.15s, transform 0.15s;
  }
  .btn-login:hover { background: #2563eb; transform: translateY(-1px); }

  /* â”€â”€ User Management Modal â”€â”€ */
  #userMgmtModal {
    position: fixed; inset: 0; z-index: 8888;
    background: rgba(0,0,0,0.7);
    display: none; align-items: center; justify-content: center;
    padding: 20px;
  }
  #userMgmtModal.open { display: flex; }
  .mgmt-box {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; padding: 32px 36px;
    width: min(820px, 100%); max-height: 88vh;
    display: flex; flex-direction: column;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  }
  .mgmt-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 24px; flex-shrink: 0;
  }
  .mgmt-header h2 { font-size: 16px; font-weight: 700; }
  .mgmt-close {
    background: transparent; border: 1px solid var(--border);
    color: var(--text-muted); border-radius: 6px;
    width: 30px; height: 30px; cursor: pointer; font-size: 15px;
    display: flex; align-items: center; justify-content: center;
    transition: border-color 0.15s, color 0.15s; flex-shrink: 0;
  }
  .mgmt-close:hover { border-color: var(--danger); color: var(--danger); }

  /* ì¶”ê°€ í¼ â€” 2í–‰ ê·¸ë¦¬ë“œ */
  .mgmt-add-form {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 8px;
    margin-bottom: 8px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }
  .mgmt-add-form input {
    padding: 9px 13px;
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 8px; color: var(--text); font-size: 12px;
    font-family: 'Noto Sans KR', sans-serif; outline: none;
    transition: border-color 0.2s; width: 100%;
  }
  .mgmt-add-form input:focus { border-color: var(--accent); }
  .mgmt-add-form input::placeholder { color: var(--text-dim); }
  .mgmt-add-btn-row {
    grid-column: 1 / -1;
    display: flex; justify-content: flex-end;
  }
  .btn-add-user {
    padding: 9px 22px; border-radius: 8px;
    background: var(--success); color: white;
    font-size: 12px; font-weight: 700;
    font-family: 'Noto Sans KR', sans-serif;
    border: none; cursor: pointer; white-space: nowrap;
    transition: background 0.15s, transform 0.15s;
  }
  .btn-add-user:hover { background: #059669; transform: translateY(-1px); }

  /* ì‚¬ìš©ì ëª©ë¡ */
  .user-list {
    display: flex; flex-direction: column; gap: 7px;
    overflow-y: auto; flex: 1;
    padding-right: 4px;
  }
  .user-list::-webkit-scrollbar { width: 4px; }
  .user-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .user-list-header {
    display: grid;
    grid-template-columns: 64px 110px 110px 80px 1fr auto auto;
    gap: 10px;
    padding: 6px 14px;
    font-size: 10px; font-weight: 700;
    color: var(--text-dim); letter-spacing: 0.5px;
    text-transform: uppercase; flex-shrink: 0;
  }
  .user-item {
    display: grid;
    grid-template-columns: 64px 110px 110px 80px 1fr auto auto;
    align-items: center; gap: 10px;
    padding: 11px 14px; background: var(--surface2);
    border: 1px solid var(--border); border-radius: 9px;
    transition: border-color 0.15s;
  }
  .user-item:hover { border-color: rgba(59,130,246,0.3); }
  .user-item .u-role {
    font-size: 10px; font-weight: 700; padding: 3px 8px;
    border-radius: 4px; white-space: nowrap; text-align: center;
  }
  .role-master { background: rgba(245,158,11,0.15); color: var(--warn); }
  .role-user   { background: rgba(59,130,246,0.15);  color: var(--accent); }
  .u-id   { font-size: 12px; font-weight: 600; font-family: 'JetBrains Mono', monospace; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .u-name { font-size: 12px; color: var(--text-muted); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .u-pw   { font-size: 11px; color: var(--text-dim); font-family: 'JetBrains Mono', monospace; letter-spacing: 2px; }
  .u-status {
    font-size: 10px; padding: 3px 10px; border-radius: 10px;
    font-weight: 600; white-space: nowrap; text-align: center;
  }
  .s-active   { background: rgba(16,185,129,0.12); color: var(--success); }
  .s-inactive { background: rgba(239,68,68,0.12);  color: var(--danger); }

  .btn-toggle-status {
    padding: 5px 12px; border-radius: 6px; font-size: 11px; font-weight: 600;
    font-family: 'Noto Sans KR', sans-serif; border: 1px solid var(--border);
    background: transparent; color: var(--text-muted); cursor: pointer;
    transition: all 0.15s; white-space: nowrap;
  }
  .btn-toggle-status:hover { border-color: var(--warn); color: var(--warn); background: rgba(245,158,11,0.06); }
  .btn-del-user {
    padding: 5px 12px; border-radius: 6px; font-size: 11px; font-weight: 600;
    font-family: 'Noto Sans KR', sans-serif; border: 1px solid var(--border);
    background: transparent; color: var(--text-muted); cursor: pointer;
    transition: all 0.15s; white-space: nowrap;
  }
  .btn-del-user:hover { border-color: var(--danger); color: var(--danger); background: rgba(239,68,68,0.06); }
  .mgmt-protected { font-size: 10px; color: var(--text-dim); padding: 0 4px; white-space: nowrap; grid-column: span 2; text-align: right; }

  /* â”€â”€ Header user info â”€â”€ */
  .header-user {
    margin-left: auto; display: flex; align-items: center; gap: 10px;
  }
  .user-badge {
    display: flex; align-items: center; gap: 7px;
    padding: 6px 12px; background: var(--surface2);
    border: 1px solid var(--border); border-radius: 8px; font-size: 12px;
  }
  .user-dot {
    width: 7px; height: 7px; border-radius: 50%;
    background: var(--success);
  }
  .btn-logout {
    padding: 6px 12px; border-radius: 7px;
    background: transparent; color: var(--text-muted);
    border: 1px solid var(--border); font-size: 11px; font-weight: 600;
    font-family: 'Noto Sans KR', sans-serif; cursor: pointer;
    transition: all 0.15s;
  }
  .btn-logout:hover { border-color: var(--danger); color: var(--danger); }
  .btn-user-mgmt {
    padding: 6px 12px; border-radius: 7px;
    background: rgba(245,158,11,0.1); color: var(--warn);
    border: 1px solid rgba(245,158,11,0.25); font-size: 11px; font-weight: 600;
    font-family: 'Noto Sans KR', sans-serif; cursor: pointer;
    transition: all 0.15s;
  }
  .btn-user-mgmt:hover { background: rgba(245,158,11,0.2); }

  /* â”€â”€ ë‘ë ˆì´ íŒŒì¼ ê´€ë¦¬ ë°” â”€â”€ */
  .dooray-bar {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 16px; margin-bottom: 12px;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 10px; flex-wrap: wrap;
  }
  .dooray-bar .db-label {
    font-size: 11px; font-weight: 700; color: var(--text-muted);
    display: flex; align-items: center; gap: 6px; white-space: nowrap;
  }
  .db-sep { width: 1px; height: 18px; background: var(--border); flex-shrink: 0; }

  /* upload card íŒŒì¼ ì„ íƒ ë²„íŠ¼ */
  .btn-from-dooray {
    position: relative; z-index: 2;
    margin-top: 6px; padding: 4px 10px; border-radius: 5px;
    font-size: 10px; font-weight: 600;
    font-family: 'Noto Sans KR', sans-serif; cursor: pointer;
    border: 1px solid rgba(99,179,237,0.4);
    background: rgba(99,179,237,0.08); color: #93c5fd;
    transition: all 0.15s; display: inline-flex; align-items: center; gap: 4px;
  }
  .btn-from-dooray:hover { background: rgba(99,179,237,0.18); }

  /* íŒŒì¼ ì„ íƒ ëª¨ë‹¬ (ê³µìš©) */
  #filePickerModal {
    position: fixed; inset: 0; z-index: 9100;
    background: rgba(0,0,0,0.75);
    display: none; align-items: center; justify-content: center; padding: 20px;
  }
  #filePickerModal.open { display: flex; }
  .fpick-box {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; padding: 28px 30px;
    width: min(700px,100%); max-height: 85vh;
    display: flex; flex-direction: column;
    box-shadow: 0 20px 60px rgba(0,0,0,0.6);
  }
  .fpick-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 6px; flex-shrink: 0;
  }
  .fpick-header h3 { font-size: 15px; font-weight: 700; }
  .fpick-sub {
    font-size: 11px; color: var(--text-dim); margin-bottom: 14px;
    font-family: 'JetBrains Mono', monospace; flex-shrink: 0;
  }
  .fpick-search {
    display: flex; gap: 8px; margin-bottom: 12px; flex-shrink: 0;
  }
  .fpick-search input {
    flex: 1; padding: 8px 12px;
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 8px; color: var(--text); font-size: 12px;
    font-family: 'Noto Sans KR', sans-serif; outline: none;
    transition: border-color 0.2s;
  }
  .fpick-search input:focus { border-color: var(--accent); }
  .fpick-list {
    flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 5px;
    padding-right: 4px;
  }
  .fpick-list::-webkit-scrollbar { width: 4px; }
  .fpick-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
  .fpick-item {
    display: grid; grid-template-columns: 28px 1fr auto auto;
    align-items: center; gap: 10px;
    padding: 10px 14px; background: var(--surface2);
    border: 1px solid var(--border); border-radius: 8px;
    cursor: pointer; transition: border-color 0.15s, background 0.15s;
  }
  .fpick-item:hover   { border-color: var(--accent); background: rgba(59,130,246,0.05); }
  .fpick-item.selected { border-color: var(--accent); background: rgba(59,130,246,0.1); }
  .fpick-icon { font-size: 18px; }
  .fpick-name { font-size: 12px; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .fpick-tag  {
    font-size: 10px; font-weight: 600; padding: 2px 7px; border-radius: 4px;
    white-space: nowrap;
  }
  .fpick-tag-mat   { background: rgba(16,185,129,0.12); color: var(--success); }
  .fpick-tag-unit  { background: rgba(245,158,11,0.12);  color: var(--warn); }
  .fpick-tag-std   { background: rgba(168,85,247,0.12);  color: var(--purple); }
  .fpick-tag-src   { background: rgba(59,130,246,0.12);  color: var(--accent); }
  .fpick-tag-other { background: rgba(100,116,139,0.12); color: var(--text-dim); }
  .fpick-date { font-size: 10px; color: var(--text-dim); white-space: nowrap; }
  .fpick-empty   { text-align: center; padding: 40px; color: var(--text-dim); font-size: 13px; }
  .fpick-footer {
    display: flex; align-items: center; justify-content: space-between;
    margin-top: 14px; flex-shrink: 0; gap: 8px;
  }
  .fpick-selected-name {
    font-size: 11px; color: var(--accent); font-weight: 600; flex: 1;
    overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  }
  .btn-fpick-ok {
    padding: 9px 22px; border-radius: 8px; background: var(--accent); color: white;
    font-size: 12px; font-weight: 700; font-family: 'Noto Sans KR', sans-serif;
    border: none; cursor: pointer; white-space: nowrap; transition: all 0.15s;
  }
  .btn-fpick-ok:disabled { opacity: 0.35; cursor: not-allowed; }
  .btn-fpick-ok:not(:disabled):hover { background: #2563eb; transform: translateY(-1px); }
  .btn-fpick-cancel {
    padding: 9px 16px; border-radius: 8px; background: transparent;
    color: var(--text-muted); border: 1px solid var(--border);
    font-size: 12px; font-weight: 600; font-family: 'Noto Sans KR', sans-serif;
    cursor: pointer; transition: all 0.15s;
  }
  .btn-fpick-cancel:hover { border-color: var(--danger); color: var(--danger); }

  /* íŒŒì¼ ëª©ë¡ ê´€ë¦¬ ëª¨ë‹¬ (ë§ˆìŠ¤í„° ì „ìš©) */
  #fileMgmtModal {
    position: fixed; inset: 0; z-index: 9200;
    background: rgba(0,0,0,0.78); display: none;
    align-items: center; justify-content: center; padding: 20px;
  }
  #fileMgmtModal.open { display: flex; }
  .fmgmt-box {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; padding: 30px 32px;
    width: min(780px,100%); max-height: 88vh;
    display: flex; flex-direction: column;
    box-shadow: 0 20px 60px rgba(0,0,0,0.6);
  }
  .fmgmt-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 20px; flex-shrink: 0;
  }
  .fmgmt-header h2 { font-size: 15px; font-weight: 700; }
  .fmgmt-add-form {
    display: grid; grid-template-columns: 2fr 1fr 1fr auto;
    gap: 8px; margin-bottom: 8px;
    padding-bottom: 18px; border-bottom: 1px solid var(--border); flex-shrink: 0;
  }
  .fmgmt-add-form input, .fmgmt-add-form select {
    padding: 9px 12px; background: var(--surface2);
    border: 1px solid var(--border); border-radius: 8px;
    color: var(--text); font-size: 12px;
    font-family: 'Noto Sans KR', sans-serif; outline: none;
    transition: border-color 0.2s; width: 100%;
  }
  .fmgmt-add-form input:focus, .fmgmt-add-form select:focus { border-color: var(--accent); }
  .fmgmt-add-form input::placeholder { color: var(--text-dim); }
  .btn-add-file {
    padding: 9px 16px; border-radius: 8px; background: var(--success); color: white;
    font-size: 12px; font-weight: 700; font-family: 'Noto Sans KR', sans-serif;
    border: none; cursor: pointer; white-space: nowrap; transition: all 0.15s; align-self: end;
  }
  .btn-add-file:hover { background: #059669; transform: translateY(-1px); }
  .fmgmt-list-header {
    display: grid; grid-template-columns: 1fr 100px 110px 32px;
    gap: 10px; padding: 6px 14px;
    font-size: 10px; font-weight: 700; color: var(--text-dim);
    letter-spacing: 0.5px; text-transform: uppercase; flex-shrink: 0;
  }
  .fmgmt-list {
    flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 5px;
    padding-right: 4px;
  }
  .fmgmt-list::-webkit-scrollbar { width: 4px; }
  .fmgmt-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
  .fmgmt-item {
    display: grid; grid-template-columns: 1fr 100px 110px 32px;
    align-items: center; gap: 10px;
    padding: 10px 14px; background: var(--surface2);
    border: 1px solid var(--border); border-radius: 8px;
    transition: border-color 0.15s;
  }
  .fmgmt-item:hover { border-color: rgba(59,130,246,0.3); }
  .fmgmt-name { font-size: 12px; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .btn-del-file {
    width: 28px; height: 28px; border-radius: 6px; display: flex; align-items: center; justify-content: center;
    background: transparent; border: 1px solid var(--border); color: var(--text-dim);
    cursor: pointer; font-size: 13px; transition: all 0.15s;
  }
  .btn-del-file:hover { border-color: var(--danger); color: var(--danger); background: rgba(239,68,68,0.06); }

  /* ì—…ë¡œë“œ ë“œë˜ê·¸ ì˜ì—­ */
  .fmgmt-upload-area {
    border: 2px dashed var(--border); border-radius: 12px;
    margin-bottom: 14px; flex-shrink: 0; transition: border-color 0.2s, background 0.2s;
    cursor: pointer;
  }
  .fmgmt-upload-area:hover, .fmgmt-upload-area.drag-over {
    border-color: var(--accent); background: rgba(59,130,246,0.04);
  }
  .fmgmt-drop-inner {
    padding: 24px; text-align: center; pointer-events: none;
  }

  /* ëŒ€ê¸° íŒŒì¼ ëª©ë¡ */
  .fmgmt-pending-list {
    display: flex; flex-direction: column; gap: 6px;
    max-height: 200px; overflow-y: auto; margin-bottom: 4px;
  }
  .fmgmt-pending-item {
    display: grid; grid-template-columns: 1fr 140px;
    align-items: center; gap: 10px;
    padding: 9px 14px; background: rgba(59,130,246,0.05);
    border: 1px solid rgba(59,130,246,0.2); border-radius: 8px;
  }
  .fmgmt-pending-item select {
    padding: 6px 10px; background: var(--surface2);
    border: 1px solid var(--border); border-radius: 6px;
    color: var(--text); font-size: 11px;
    font-family: 'Noto Sans KR', sans-serif; outline: none;
  }
  .fmgmt-pending-item select:focus { border-color: var(--accent); }

  /* ìŠ¤í† ë¦¬ì§€ ë°” */
  .storage-bar-wrap {
    display: flex; align-items: center; gap: 10px; font-size: 10px; color: var(--text-dim);
  }
  .storage-bar-track {
    flex: 1; height: 4px; background: var(--surface2); border-radius: 2px; overflow: hidden;
  }
  .storage-bar-fill {
    height: 100%; border-radius: 2px; background: var(--accent); transition: width 0.3s;
  }
  .storage-bar-fill.warn  { background: var(--warn); }
  .storage-bar-fill.danger { background: var(--danger); }

  /* â”€â”€ Change Password button in header â”€â”€ */
  .btn-chgpw {
    padding: 6px 12px; border-radius: 7px;
    background: rgba(34,211,238,0.08); color: var(--accent2);
    border: 1px solid rgba(34,211,238,0.25); font-size: 11px; font-weight: 600;
    font-family: 'Noto Sans KR', sans-serif; cursor: pointer;
    transition: all 0.15s;
  }
  .btn-chgpw:hover { background: rgba(34,211,238,0.18); }

  /* â”€â”€ Change Password Modal â”€â”€ */
  #chgPwModal {
    position: fixed; inset: 0; z-index: 9000;
    background: rgba(0,0,0,0.72);
    display: none; align-items: center; justify-content: center;
  }
  #chgPwModal.open { display: flex; }
  .chgpw-box {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 14px; padding: 32px 30px;
    width: 360px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.55);
    position: relative;
  }
  .chgpw-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 22px;
  }
  .chgpw-header h2 { font-size: 15px; font-weight: 700; }
  .chgpw-who {
    font-size: 11px; color: var(--text-dim); margin-bottom: 18px;
    padding: 8px 12px; background: var(--surface2);
    border: 1px solid var(--border); border-radius: 7px;
    font-family: 'JetBrains Mono', monospace;
  }
  .chgpw-field { margin-bottom: 13px; }
  .chgpw-field label {
    display: block; font-size: 11px; font-weight: 600;
    color: var(--text-muted); margin-bottom: 5px; letter-spacing: 0.4px;
  }
  .chgpw-field input {
    width: 100%; padding: 9px 13px;
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 7px; color: var(--text); font-size: 13px;
    font-family: 'Noto Sans KR', sans-serif; outline: none;
    transition: border-color 0.2s;
  }
  .chgpw-field input:focus { border-color: var(--accent2); }
  .chgpw-field input.input-err { border-color: var(--danger); }
  .chgpw-field input.input-ok  { border-color: var(--success); }
  .chgpw-error {
    font-size: 11px; color: var(--danger);
    min-height: 16px; margin-bottom: 10px; text-align: center;
  }
  .chgpw-success {
    font-size: 12px; color: var(--success);
    text-align: center; padding: 10px;
    background: rgba(16,185,129,0.08); border: 1px solid rgba(16,185,129,0.2);
    border-radius: 7px; margin-bottom: 12px; display: none;
  }
  .pw-strength {
    height: 3px; border-radius: 2px; margin-top: 5px;
    background: var(--border); transition: all 0.3s;
    overflow: hidden;
  }
  .pw-strength-bar {
    height: 100%; border-radius: 2px; width: 0;
    transition: width 0.3s, background 0.3s;
  }
  .pw-strength-label {
    font-size: 10px; color: var(--text-dim); margin-top: 3px;
    min-height: 14px;
  }
  .btn-save-pw {
    width: 100%; padding: 10px; border-radius: 8px;
    background: var(--accent2); color: #0d0f14;
    font-size: 13px; font-weight: 700;
    font-family: 'Noto Sans KR', sans-serif;
    border: none; cursor: pointer;
    transition: background 0.15s, transform 0.15s;
  }
  .btn-save-pw:hover { background: #06b6d4; transform: translateY(-1px); }
  .btn-save-pw:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

  /* masterê°€ íƒ€ì¸ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½í•  ë•Œ ì“°ëŠ” select */
  .chgpw-target-row {
    display: flex; align-items: center; gap: 8px; margin-bottom: 14px;
  }
  .chgpw-target-row label {
    font-size: 11px; font-weight: 600; color: var(--text-muted);
    white-space: nowrap;
  }
  .chgpw-target-row select {
    flex: 1; padding: 8px 10px;
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 7px; color: var(--text); font-size: 12px;
    font-family: 'JetBrains Mono', monospace; outline: none;
    transition: border-color 0.2s; cursor: pointer;
  }
  .chgpw-target-row select:focus { border-color: var(--accent2); }
  .chgpw-tab-row {
    display: flex; gap: 6px; margin-bottom: 16px;
  }
  .chgpw-tab {
    flex: 1; padding: 7px; border-radius: 7px;
    font-size: 11px; font-weight: 600;
    font-family: 'Noto Sans KR', sans-serif;
    border: 1px solid var(--border);
    background: transparent; color: var(--text-dim);
    cursor: pointer; transition: all 0.15s; text-align: center;
  }
  .chgpw-tab.active-self   { background: var(--accent2); border-color: var(--accent2); color: #0d0f14; }
  .chgpw-tab.active-other  { background: var(--warn);    border-color: var(--warn);    color: #0d0f14; }
  .chgpw-tab:not(.active-self):not(.active-other):hover { border-color: var(--accent2); color: var(--accent2); }
</style>
</head>
<body>

<!-- â”€â”€ íŒŒì¼ ì„ íƒ ëª¨ë‹¬ â”€â”€ -->
<div id="filePickerModal">
  <div class="fpick-box">
    <div class="fpick-header">
      <h3 id="fpickTitle">ğŸ“‚ íŒŒì¼ ì„ íƒ</h3>
      <button class="mgmt-close" onclick="closeFilePicker()">âœ•</button>
    </div>
    <div class="fpick-sub" id="fpickSub">ìì›íŒŒì¼ ì„œë²„ ì €ì¥ì†Œ</div>
    <div class="fpick-search">
      <input type="text" id="fpickSearch" placeholder="íŒŒì¼ëª… ê²€ìƒ‰..." oninput="filterFileList()">
    </div>
    <div class="fpick-list" id="fpickList"></div>
    <div class="fpick-footer">
      <span class="fpick-selected-name" id="fpickSelectedName"></span>
      <button class="btn-fpick-cancel" onclick="closeFilePicker()">ì·¨ì†Œ</button>
      <button class="btn-fpick-ok" id="btnFpickOk" disabled onclick="confirmFilePick()">ì„ íƒ</button>
    </div>
  </div>
</div>

<!-- â”€â”€ ìì›íŒŒì¼ ì—…ë¡œë“œ ê´€ë¦¬ ëª¨ë‹¬ (ë§ˆìŠ¤í„° ì „ìš©) â”€â”€ -->
<div id="fileMgmtModal">
  <div class="fmgmt-box">
    <div class="fmgmt-header">
      <h2>ğŸ“¤ ìì›íŒŒì¼ ì—…ë¡œë“œ ê´€ë¦¬ <span style="color:var(--warn);font-size:11px;margin-left:8px;font-weight:600;">ğŸ”‘ MASTER ì „ìš©</span></h2>
      <button class="mgmt-close" onclick="closeFileMgmt()">âœ•</button>
    </div>

    <!-- ì—…ë¡œë“œ ì˜ì—­ -->
    <div id="fmgmtDrop" class="fmgmt-upload-area">
      <input type="file" id="fmgmtFileInput" accept=".xlsx,.xlsm,.xls" multiple style="display:none"
             onchange="handleMasterUpload(this.files)">
      <div class="fmgmt-drop-inner" onclick="document.getElementById('fmgmtFileInput').click()">
        <div style="font-size:28px;margin-bottom:8px">ğŸ“¤</div>
        <div style="font-size:13px;font-weight:700;margin-bottom:4px">íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</div>
        <div style="font-size:11px;color:var(--text-dim)">xlsx / xlsm / xls Â· ì—¬ëŸ¬ íŒŒì¼ ë™ì‹œ ì—…ë¡œë“œ ê°€ëŠ¥</div>
      </div>
    </div>

    <!-- ì—…ë¡œë“œëœ íŒŒì¼ êµ¬ë¶„ ì„¤ì • í–‰ (ì—…ë¡œë“œ ì§í›„ í‘œì‹œ) -->
    <div id="fmgmtPendingArea" style="display:none">
      <div style="font-size:11px;font-weight:700;color:var(--text-muted);margin-bottom:8px;flex-shrink:0">
        â¬‡ ì—…ë¡œë“œí•  íŒŒì¼ êµ¬ë¶„ ì„¤ì • í›„ ì €ì¥
      </div>
      <div id="fmgmtPendingList" class="fmgmt-pending-list"></div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px;padding-top:10px;border-top:1px solid var(--border)">
        <button class="btn-dpick-cancel" onclick="cancelPending()">ì·¨ì†Œ</button>
        <button class="btn-add-file" onclick="savePendingFiles()">ğŸ’¾ ì €ì¥</button>
      </div>
    </div>

    <!-- ì €ì¥ëœ íŒŒì¼ ëª©ë¡ -->
    <div class="fmgmt-list-header" style="margin-top:16px">
      <span>íŒŒì¼ëª…</span><span>êµ¬ë¶„</span><span>í¬ê¸°</span><span></span>
    </div>
    <div id="fmgmtList" class="fmgmt-list"></div>

    <!-- ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©ëŸ‰ -->
    <div id="fmgmtStorageBar" style="margin-top:12px;flex-shrink:0"></div>
  </div>
</div>

<!-- â”€â”€ Login Overlay â”€â”€ -->
<div id="loginOverlay">
  <div class="login-box">
    <div class="login-logo">ğŸ“‹</div>
    <div class="login-title">ë‚´ì—­ ì½”ë“œ <span>ì²´í¬ ì‹œìŠ¤í…œ</span></div>
    <div class="login-sub">ì•„ì´íŒŒí¬ ê±´ì„¤ Â· ë‚´ì—­ê´€ë¦¬íŒ€</div>
    <div class="login-field">
      <label>ì•„ì´ë””</label>
      <input type="text" id="loginId" placeholder="ì•„ì´ë”” ì…ë ¥" autocomplete="username" onkeydown="if(event.key==='Enter')doLogin()">
    </div>
    <div class="login-field">
      <label>ë¹„ë°€ë²ˆí˜¸</label>
      <input type="password" id="loginPw" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()">
    </div>
    <div class="login-error" id="loginError"></div>
    <button class="btn-login" onclick="doLogin()">ë¡œê·¸ì¸</button>
  </div>
</div>

<!-- â”€â”€ Change Password Modal â”€â”€ -->
<div id="chgPwModal">
  <div class="chgpw-box">
    <div class="chgpw-header">
      <h2>ğŸ” ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h2>
      <button class="mgmt-close" onclick="closeChgPw()">âœ•</button>
    </div>

    <!-- ë§ˆìŠ¤í„° ì „ìš©: ë‚´ ë¹„ë°€ë²ˆí˜¸ / íƒ€ ì‚¬ìš©ì ë¹„ë°€ë²ˆí˜¸ íƒ­ -->
    <div id="chgpwTabRow" class="chgpw-tab-row" style="display:none">
      <button class="chgpw-tab active-self" id="tabSelf"  onclick="switchChgPwTab('self')">ğŸ”‘ ë‚´ ë¹„ë°€ë²ˆí˜¸</button>
      <button class="chgpw-tab"             id="tabOther" onclick="switchChgPwTab('other')">ğŸ‘¥ ì‚¬ìš©ì ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
    </div>

    <!-- ëŒ€ìƒ ì‚¬ìš©ì ì„ íƒ (ë§ˆìŠ¤í„° - íƒ€ ì‚¬ìš©ì íƒ­ì¼ ë•Œë§Œ í‘œì‹œ) -->
    <div id="chgpwTargetRow" class="chgpw-target-row" style="display:none">
      <label>ëŒ€ìƒ ê³„ì •</label>
      <select id="chgpwTargetSel" onchange="onTargetChange()"></select>
    </div>

    <!-- í˜„ì¬ ê³„ì • ì •ë³´ í‘œì‹œ -->
    <div class="chgpw-who" id="chgpwWho">-</div>

    <!-- í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ (ìì‹ ì˜ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹œì—ë§Œ í‘œì‹œ) -->
    <div class="chgpw-field" id="chgpwCurRow">
      <label>í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
      <input type="password" id="chgpwCur" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥"
             oninput="onChgPwInput()" onkeydown="if(event.key==='Enter')saveChgPw()">
    </div>

    <div class="chgpw-field">
      <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
      <input type="password" id="chgpwNew" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)"
             oninput="onChgPwInput()" onkeydown="if(event.key==='Enter')saveChgPw()">
      <div class="pw-strength"><div class="pw-strength-bar" id="pwStrBar"></div></div>
      <div class="pw-strength-label" id="pwStrLabel"></div>
    </div>

    <div class="chgpw-field">
      <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
      <input type="password" id="chgpwConfirm" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì¬ì…ë ¥"
             oninput="onChgPwInput()" onkeydown="if(event.key==='Enter')saveChgPw()">
    </div>

    <div class="chgpw-error"   id="chgpwError"></div>
    <div class="chgpw-success" id="chgpwSuccess">âœ… ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.</div>
    <button class="btn-save-pw" id="btnSavePw" onclick="saveChgPw()">ë³€ê²½ ì €ì¥</button>
  </div>
</div>

<!-- â”€â”€ User Management Modal â”€â”€ -->
<div id="userMgmtModal">
  <div class="mgmt-box">
    <div class="mgmt-header">
      <h2>ğŸ‘¥ ì‚¬ìš©ì ê´€ë¦¬ <span style="color:var(--warn);font-size:11px;margin-left:8px;font-weight:600;">MASTER</span></h2>
      <button class="mgmt-close" onclick="closeMgmt()">âœ•</button>
    </div>

    <!-- ì‚¬ìš©ì ì¶”ê°€ í¼ (3ì—´ ê·¸ë¦¬ë“œ) -->
    <div class="mgmt-add-form">
      <input type="text"     id="newUserId"   placeholder="ì•„ì´ë””">
      <input type="text"     id="newUserName" placeholder="ì´ë¦„">
      <input type="password" id="newUserPw"   placeholder="ë¹„ë°€ë²ˆí˜¸"
             onkeydown="if(event.key==='Enter')addUser()">
      <div class="mgmt-add-btn-row">
        <button class="btn-add-user" onclick="addUser()">ï¼‹ ì‚¬ìš©ì ì¶”ê°€</button>
      </div>
    </div>

    <!-- ëª©ë¡ í—¤ë” -->
    <div class="user-list-header">
      <span>ê¶Œí•œ</span>
      <span>ì•„ì´ë””</span>
      <span>ì´ë¦„</span>
      <span>ìƒíƒœ</span>
      <span></span>
      <span></span>
      <span></span>
    </div>

    <!-- ì‚¬ìš©ì ëª©ë¡ -->
    <div id="userList" class="user-list"></div>
  </div>
</div>

<div class="container">

  <header>
    <div class="logo">ğŸ“‹</div>
    <div>
      <h1>ë‚´ì—­ ì½”ë“œ <span>ì²´í¬ ì‹œìŠ¤í…œ</span></h1>
      <div class="subtitle">ì›ë‚´ì—­ â†” ìì¬ë¦¬ìŠ¤íŠ¸Â·ì¼ìœ„ëŒ€ê°€ë¦¬ìŠ¤íŠ¸ ì½”ë“œê²€í†  / í‘œì¤€ë‚´ì—­ í•­ëª© ë¹„êµ</div>
    </div>
    <div class="header-user" id="headerUser"></div>
  </header>

  <!-- ìì›íŒŒì¼ ê´€ë¦¬ ë°” -->
  <div class="dooray-bar" id="doorayBar">
    <span class="db-label">ğŸ“ ìì›íŒŒì¼ ê´€ë¦¬</span>
    <span id="dbFileCount" style="font-size:11px;color:var(--text-dim)">íŒŒì¼ 0ê°œ ë“±ë¡ë¨</span>
    <div class="db-sep"></div>
    <span id="dbStorageInfo" style="font-size:10px;color:var(--text-dim)"></span>
    <button class="btn-user-mgmt" id="btnFileMgmt" style="display:none" onclick="openFileMgmt()">
      ğŸ“¤ ìì›íŒŒì¼ ì—…ë¡œë“œ ê´€ë¦¬
    </button>
  </div>

  <!-- Upload -->
  <div class="upload-grid">

    <div class="upload-card" id="drop0">
      <input type="file" id="file0" accept=".xlsx,.xlsm,.xls">
      <div class="uc-head">
        <div class="uc-dot d-blue"></div>
        <div class="uc-label">ì›ë‚´ì—­</div>
        <span class="uc-badge req">í•„ìˆ˜</span>
      </div>
      <div class="uc-desc">ê²€í†  ëŒ€ìƒ ì›ë‚´ì—­ íŒŒì¼</div>
      <div class="uc-fn" id="fn0">íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜ ë“œë¡­í•˜ì„¸ìš”</div>
      <button class="btn-from-dooray" onclick="openFilePicker(0)">ğŸ“‚ ìì›íŒŒì¼ì—ì„œ ì„ íƒ</button>
    </div>

    <div class="upload-card" id="drop1">
      <input type="file" id="file1" accept=".xlsx,.xlsm,.xls">
      <div class="uc-head">
        <div class="uc-dot d-green"></div>
        <div class="uc-label">ìì¬ë¦¬ìŠ¤íŠ¸</div>
        <span class="uc-badge req">ì½”ë“œê²€í† </span>
      </div>
      <div class="uc-desc">ìì¬ ì½”ë“œ DB íŒŒì¼</div>
      <div class="uc-fn" id="fn1">íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜ ë“œë¡­í•˜ì„¸ìš”</div>
      <button class="btn-from-dooray" onclick="openFilePicker(1)">ğŸ“‚ ìì›íŒŒì¼ì—ì„œ ì„ íƒ</button>
    </div>

    <div class="upload-card" id="drop2">
      <input type="file" id="file2" accept=".xlsx,.xlsm,.xls">
      <div class="uc-head">
        <div class="uc-dot d-warn"></div>
        <div class="uc-label">ì¼ìœ„ëŒ€ê°€ë¦¬ìŠ¤íŠ¸</div>
        <span class="uc-badge req">ì½”ë“œê²€í† </span>
      </div>
      <div class="uc-desc">ì¼ìœ„ëŒ€ê°€ ì½”ë“œ DB íŒŒì¼</div>
      <div class="uc-fn" id="fn2">íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜ ë“œë¡­í•˜ì„¸ìš”</div>
      <button class="btn-from-dooray" onclick="openFilePicker(2)">ğŸ“‚ ìì›íŒŒì¼ì—ì„œ ì„ íƒ</button>
    </div>

    <div class="upload-card" id="drop3">
      <input type="file" id="file3" accept=".xlsx,.xlsm,.xls">
      <div class="uc-head">
        <div class="uc-dot d-purple"></div>
        <div class="uc-label">í‘œì¤€ë‚´ì—­</div>
        <span class="uc-badge opt">í‘œì¤€ë‚´ì—­ë¹„êµ</span>
      </div>
      <div class="uc-desc">í‘œì¤€ë‚´ì—­ ë¹„êµ íŒŒì¼</div>
      <div class="uc-fn" id="fn3">íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜ ë“œë¡­í•˜ì„¸ìš”</div>
      <button class="btn-from-dooray" onclick="openFilePicker(3)">ğŸ“‚ ìì›íŒŒì¼ì—ì„œ ì„ íƒ</button>
    </div>

  </div>

  <!-- Actions -->
  <div class="action-bar">
    <button class="btn btn-blue"   id="btnCode"   disabled onclick="runCodeCheck()">â–¶ ì½”ë“œ ê²€í†  ì‹¤í–‰</button>
    <button class="btn btn-purple" id="btnStd"    disabled onclick="runStdCheck()">â‡„ í‘œì¤€ë‚´ì—­ ë¹„êµ</button>
    <div class="vsep"></div>
    <button class="btn btn-outline" id="btnExport" disabled onclick="exportResult()">â¬‡ ê²°ê³¼ ì €ì¥</button>
    <button class="btn btn-outline" onclick="resetAll()">â†º ì´ˆê¸°í™”</button>
  </div>

  <!-- Mode tabs -->
  <div id="modeTabs" style="display:none" class="mode-tabs">
    <button class="mode-tab" id="tabCode" onclick="switchTab('code')">ğŸ“Œ ì½”ë“œ ê²€í†  ê²°ê³¼</button>
    <button class="mode-tab" id="tabStd"  onclick="switchTab('std')">ğŸ“Š í‘œì¤€ë‚´ì—­ ë¹„êµ ê²°ê³¼</button>
  </div>

  <!-- Stats -->
  <div id="statsArea"></div>

  <!-- Filter -->
  <div id="filterArea"></div>

  <!-- Hint -->
  <div id="hintArea"></div>

  <!-- Table -->
  <div class="table-wrapper">
    <div class="table-scroll" id="tableWrap">
      <div class="empty">
        <div class="ico">ğŸ“‹</div>
        <p>ì›ë‚´ì—­ + ìì¬ë¦¬ìŠ¤íŠ¸/ì¼ìœ„ëŒ€ê°€ë¦¬ìŠ¤íŠ¸ë¥¼ ì—…ë¡œë“œ í›„<br><b>ì½”ë“œ ê²€í†  ì‹¤í–‰</b> í´ë¦­<br><br>
           í‘œì¤€ë‚´ì—­ê³¼ í•­ëª© ë¹„êµëŠ” í‘œì¤€ë‚´ì—­ë„ ì—…ë¡œë“œ í›„<br><b>í‘œì¤€ë‚´ì—­ ë¹„êµ</b> í´ë¦­</p>
      </div>
    </div>
  </div>

</div>

<!-- â”€â”€ ìì›íŒŒì¼ ê´€ë¦¬ Script â”€â”€ -->
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ìì›íŒŒì¼ ì„œë²„ ì €ì¥ì†Œ â€” ë§ˆìŠ¤í„° ì—…ë¡œë“œ / ì‚¬ìš©ì ì„ íƒ
//  íŒŒì¼ ë°ì´í„°ëŠ” base64ë¡œ localStorageì— ì €ì¥ë©ë‹ˆë‹¤.
//  localStorage ìš©ëŸ‰: ë„ë©”ì¸ë‹¹ ë³´í†µ 5~10MB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const FILE_META_KEY   = 'cc_res_meta';   // [{id, name, type, size, addedAt}]
const FILE_DATA_PREFIX = 'cc_res_data_'; // + id â†’ base64 íŒŒì¼ ë°ì´í„°

const FILE_TYPES = {
  src:   { label: 'ì›ë‚´ì—­',       cls: 'fpick-tag-src',   icon: 'ğŸ“˜' },
  mat:   { label: 'ìì¬ë¦¬ìŠ¤íŠ¸',   cls: 'fpick-tag-mat',   icon: 'ğŸ“—' },
  unit:  { label: 'ì¼ìœ„ëŒ€ê°€',     cls: 'fpick-tag-unit',  icon: 'ğŸ“™' },
  std:   { label: 'í‘œì¤€ë‚´ì—­',     cls: 'fpick-tag-std',   icon: 'ğŸ““' },
  other: { label: 'ê¸°íƒ€',         cls: 'fpick-tag-other', icon: 'ğŸ“„' },
};
const SLOT_DEFAULT_TYPE = { 0:'src', 1:'mat', 2:'unit', 3:'std' };
const SLOT_LABELS       = { 0:'ì›ë‚´ì—­', 1:'ìì¬ë¦¬ìŠ¤íŠ¸', 2:'ì¼ìœ„ëŒ€ê°€ë¦¬ìŠ¤íŠ¸', 3:'í‘œì¤€ë‚´ì—­' };
const SLOT_DOTCLS       = ['c-blue','c-green','c-warn','c-purple'];

let fpickTargetIdx = null;
let fpickSelected  = null;
let pendingFiles   = [];   // ì—…ë¡œë“œ ëŒ€ê¸° [{name, type, base64, size}]

// â”€â”€ ë©”íƒ€ ì €ì¥/ë¡œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadMeta()        { try { return JSON.parse(localStorage.getItem(FILE_META_KEY)||'[]'); } catch { return []; } }
function saveMeta(list)    { localStorage.setItem(FILE_META_KEY, JSON.stringify(list)); }
function loadFileData(id)  { return localStorage.getItem(FILE_DATA_PREFIX + id); }
function saveFileData(id, b64) { localStorage.setItem(FILE_DATA_PREFIX + id, b64); }
function deleteFileData(id){ localStorage.removeItem(FILE_DATA_PREFIX + id); }
function genId()           { return Date.now().toString(36) + Math.random().toString(36).slice(2,6); }

// â”€â”€ localStorage ì‚¬ìš©ëŸ‰ ê³„ì‚° (bytes) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calcStorageUsed() {
  let total = 0;
  for (const k in localStorage) {
    if (!Object.prototype.hasOwnProperty.call(localStorage, k)) continue;
    total += (localStorage[k].length + k.length) * 2;
  }
  return total;
}
function formatSize(bytes) {
  if (bytes < 1024)        return bytes + 'B';
  if (bytes < 1048576)     return Math.round(bytes/1024) + 'KB';
  return (bytes/1048576).toFixed(1) + 'MB';
}

// â”€â”€ ìì›íŒŒì¼ ë°” ê°±ì‹  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateDoorayBar() {
  const meta     = loadMeta();
  const used     = calcStorageUsed();
  const isMaster = currentUser && currentUser.role === 'master';
  document.getElementById('dbFileCount').textContent  = 'íŒŒì¼ ' + meta.length + 'ê°œ ì €ì¥ë¨';
  document.getElementById('dbStorageInfo').textContent = 'ì €ì¥ì†Œ ì‚¬ìš©: ' + formatSize(used);
  document.getElementById('btnFileMgmt').style.display = isMaster ? '' : 'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  íŒŒì¼ ì„ íƒ ëª¨ë‹¬ (ëª¨ë“  ì‚¬ìš©ì)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openFilePicker(slotIdx) {
  fpickTargetIdx = slotIdx;
  fpickSelected  = null;
  document.getElementById('fpickTitle').textContent       = 'ğŸ“‚ ' + SLOT_LABELS[slotIdx] + ' ì„ íƒ';
  document.getElementById('fpickSub').textContent         = 'ìì›íŒŒì¼ ì„œë²„ ì €ì¥ì†Œ â€¢ ' + SLOT_LABELS[slotIdx] + ' íŒŒì¼ ë¨¼ì € í‘œì‹œ';
  document.getElementById('fpickSearch').value            = '';
  document.getElementById('fpickSelectedName').textContent = '';
  document.getElementById('btnFpickOk').disabled          = true;
  renderFilePickList(loadMeta(), slotIdx);
  document.getElementById('filePickerModal').classList.add('open');
}
function closeFilePicker() {
  document.getElementById('filePickerModal').classList.remove('open');
  fpickSelected = null; fpickTargetIdx = null;
}

function renderFilePickList(meta, slotIdx) {
  const el = document.getElementById('fpickList');
  if (!meta.length) {
    const isMaster = currentUser && currentUser.role === 'master';
    el.innerHTML = '<div class="fpick-empty">ğŸ“­ ì €ì¥ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.<br>'
      + (isMaster
          ? '<span style="color:var(--accent)">ã€Œìì›íŒŒì¼ ì—…ë¡œë“œ ê´€ë¦¬ã€ì—ì„œ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.</span>'
          : '<span style="color:var(--text-dim)">ê´€ë¦¬ìì—ê²Œ íŒŒì¼ ì—…ë¡œë“œë¥¼ ìš”ì²­í•˜ì„¸ìš”.</span>')
      + '</div>';
    return;
  }
  const defType = SLOT_DEFAULT_TYPE[slotIdx];
  const sorted  = [...meta].sort((a,b) => {
    if (a.type === defType && b.type !== defType) return -1;
    if (b.type === defType && a.type !== defType) return  1;
    return a.name.localeCompare(b.name, 'ko');
  });
  el.innerHTML = sorted.map(f => {
    const ft   = FILE_TYPES[f.type] || FILE_TYPES.other;
    const date = f.addedAt ? new Date(f.addedAt).toLocaleDateString('ko-KR') : '';
    const sz   = f.size ? formatSize(f.size) : '';
    return '<div class="fpick-item" data-id="' + esc(f.id) + '" onclick="selectFileItem(this,\'' + esc(f.id) + '\')">'
      + '<span class="fpick-icon">' + ft.icon + '</span>'
      + '<span class="fpick-name" title="' + esc(f.name) + '">' + esc(f.name) + '</span>'
      + '<span class="fpick-tag ' + ft.cls + '">' + ft.label + '</span>'
      + '<span class="fpick-date">' + esc(sz) + (sz && date ? ' Â· ' : '') + esc(date) + '</span>'
      + '</div>';
  }).join('');
}

function filterFileList() {
  const q      = document.getElementById('fpickSearch').value.toLowerCase();
  const meta   = loadMeta();
  const result = q ? meta.filter(f => f.name.toLowerCase().includes(q)) : meta;
  renderFilePickList(result, fpickTargetIdx);
  fpickSelected = null;
  document.getElementById('fpickSelectedName').textContent = '';
  document.getElementById('btnFpickOk').disabled = true;
}

function selectFileItem(el, id) {
  document.querySelectorAll('.fpick-item').forEach(e => e.classList.remove('selected'));
  el.classList.add('selected');
  const meta = loadMeta();
  fpickSelected = meta.find(f => f.id === id) || null;
  document.getElementById('fpickSelectedName').textContent = fpickSelected ? 'âœ“ ' + fpickSelected.name : '';
  document.getElementById('btnFpickOk').disabled = !fpickSelected;
}

function confirmFilePick() {
  if (!fpickSelected || fpickTargetIdx === null) return;
  const { id, name } = fpickSelected;
  const fnEl  = document.getElementById('fn'   + fpickTargetIdx);
  const card  = document.getElementById('drop' + fpickTargetIdx);
  const dotCl = SLOT_DOTCLS[fpickTargetIdx];

  closeFilePicker();

  try {
    const b64 = loadFileData(id);
    if (!b64) throw new Error('ì €ì¥ëœ íŒŒì¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
    // base64 â†’ ArrayBuffer
    const bin = atob(b64);
    const buf = new Uint8Array(bin.length);
    for (let i = 0; i < bin.length; i++) buf[i] = bin.charCodeAt(i);
    wbs[fpickTargetIdx] = XLSX.read(buf, { type: 'array' });
    fnEl.textContent = 'âœ“ [ìì›íŒŒì¼] ' + name;
    fnEl.className   = 'uc-fn ok';
    card.classList.add('loaded', dotCl);
  } catch(e) {
    fnEl.textContent = 'âŒ ë¡œë“œ ì‹¤íŒ¨: ' + e.message;
    fnEl.className   = 'uc-fn';
  }
  updateBtns();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ìì›íŒŒì¼ ì—…ë¡œë“œ ê´€ë¦¬ ëª¨ë‹¬ (ë§ˆìŠ¤í„° ì „ìš©)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openFileMgmt() {
  if (!currentUser || currentUser.role !== 'master') {
    alert('ìì›íŒŒì¼ ì—…ë¡œë“œ ê´€ë¦¬ëŠ” ë§ˆìŠ¤í„° ê³„ì •ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.'); return;
  }
  pendingFiles = [];
  document.getElementById('fmgmtPendingArea').style.display = 'none';
  document.getElementById('fmgmtFileInput').value = '';
  renderFmgmtList();
  renderStorageBar();
  document.getElementById('fileMgmtModal').classList.add('open');
  initDropZone();
}
function closeFileMgmt() {
  document.getElementById('fileMgmtModal').classList.remove('open');
  pendingFiles = [];
}

// ë“œë˜ê·¸&ë“œë¡­ ì´ˆê¸°í™”
function initDropZone() {
  const zone = document.getElementById('fmgmtDrop');
  zone.ondragover  = (e) => { e.preventDefault(); zone.classList.add('drag-over'); };
  zone.ondragleave = ()  => { zone.classList.remove('drag-over'); };
  zone.ondrop      = (e) => {
    e.preventDefault(); zone.classList.remove('drag-over');
    handleMasterUpload(e.dataTransfer.files);
  };
}

// íŒŒì¼ ì½ê¸° â†’ ëŒ€ê¸° ëª©ë¡ì— ì¶”ê°€
// ArrayBuffer â†’ base64 (ì²­í¬ ë°©ì‹ â€” ìŠ¤íƒ ì˜¤ë²„í”Œë¡œìš° ë°©ì§€)
function arrayBufferToBase64(buffer) {
  const bytes  = new Uint8Array(buffer);
  const CHUNK  = 8192;
  let binary   = '';
  for (let i = 0; i < bytes.length; i += CHUNK) {
    binary += String.fromCharCode.apply(null, bytes.subarray(i, i + CHUNK));
  }
  return btoa(binary);
}

function handleMasterUpload(fileList) {
  if (!fileList || !fileList.length) return;
  const validExts = ['xlsx','xlsm','xls'];
  const tasks = Array.from(fileList).filter(f => {
    const ext = f.name.split('.').pop().toLowerCase();
    return validExts.includes(ext);
  });
  if (!tasks.length) { alert('xlsx / xlsm / xls íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.'); return; }

  // ì½ëŠ” ì¤‘ í‘œì‹œ
  const dropInner = document.querySelector('.fmgmt-drop-inner');
  const origHtml  = dropInner.innerHTML;
  dropInner.innerHTML = '<div class="spin" style="margin:0 auto 8px"></div>'
    + '<div style="font-size:12px;color:var(--text-muted)">íŒŒì¼ ì½ëŠ” ì¤‘...</div>';

  let done = 0;
  pendingFiles = [];   // ì´ì „ ëŒ€ê¸° ì´ˆê¸°í™”

  tasks.forEach(file => {
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const b64 = arrayBufferToBase64(e.target.result);
        // íŒŒì¼ëª…ì—ì„œ êµ¬ë¶„ ìë™ ì¶”ì •
        const lower = file.name.toLowerCase();
        let guessType = 'other';
        if      (lower.includes('ì›ë‚´ì—­') || lower.includes('ì›_ë‚´ì—­'))      guessType = 'src';
        else if (lower.includes('ìì¬'))                                     guessType = 'mat';
        else if (lower.includes('ì¼ìœ„ëŒ€ê°€') || lower.includes('ì¼ìœ„'))       guessType = 'unit';
        else if (lower.includes('í‘œì¤€'))                                     guessType = 'std';
        pendingFiles.push({ name: file.name, type: guessType, base64: b64, size: file.size });
      } catch(err) {
        console.error('íŒŒì¼ ì½ê¸° ì˜¤ë¥˜:', file.name, err);
      }
      done++;
      if (done === tasks.length) {
        dropInner.innerHTML = origHtml;   // ì›ë˜ UI ë³µì›
        if (pendingFiles.length) showPendingArea();
        else alert('íŒŒì¼ì„ ì½ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.');
      }
    };
    reader.onerror = () => {
      done++;
      if (done === tasks.length) {
        dropInner.innerHTML = origHtml;
        if (pendingFiles.length) showPendingArea();
      }
    };
    reader.readAsArrayBuffer(file);
  });
}

function showPendingArea() {
  document.getElementById('fmgmtPendingArea').style.display = '';
  const el = document.getElementById('fmgmtPendingList');
  el.innerHTML = pendingFiles.map((f, i) =>
    '<div class="fmgmt-pending-item">'
    + '<span style="font-size:12px;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="' + esc(f.name) + '">'
    + 'ğŸ“„ ' + esc(f.name) + ' <span style="color:var(--text-dim);font-size:10px">(' + formatSize(f.size) + ')</span></span>'
    + '<select onchange="pendingFiles[' + i + '].type=this.value">'
    + Object.entries(FILE_TYPES).map(([k,v]) =>
        '<option value="' + k + '"' + (f.type===k?' selected':'') + '>' + v.label + '</option>'
      ).join('')
    + '</select>'
    + '</div>'
  ).join('');
}

function cancelPending() {
  pendingFiles = [];
  document.getElementById('fmgmtPendingArea').style.display = 'none';
  document.getElementById('fmgmtFileInput').value = '';
}

function savePendingFiles() {
  if (!pendingFiles.length) return;

  // ì €ì¥ ì „ ìš©ëŸ‰ ì‚¬ì „ ì²´í¬ (base64ëŠ” ì›ë³¸ì˜ ì•½ 1.37ë°°)
  const totalNewBytes = pendingFiles.reduce((s, f) => s + f.base64.length * 2, 0);
  const usedBytes     = calcStorageUsed();
  const MAX_BYTES     = 4.5 * 1024 * 1024; // ì•ˆì „ ìƒí•œ 4.5MB

  if (usedBytes + totalNewBytes > MAX_BYTES) {
    const need = formatSize(totalNewBytes);
    const avail = formatSize(Math.max(0, MAX_BYTES - usedBytes));
    alert(`ì €ì¥ ê³µê°„ ë¶€ì¡±!\ní•„ìš”: ${need} / ì—¬ìœ : ${avail}\n\nê¸°ì¡´ íŒŒì¼ì„ ì¼ë¶€ ì‚­ì œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.`);
    return;
  }

  const meta   = loadMeta();
  const saved  = [];
  const errors = [];

  for (const f of pendingFiles) {
    const id = genId();
    try {
      saveFileData(id, f.base64);
      meta.push({ id, name: f.name, type: f.type, size: f.size, addedAt: new Date().toISOString() });
      saved.push(f.name);
    } catch(err) {
      // QuotaExceededError ë“± ì €ì¥ ì‹¤íŒ¨
      deleteFileData(id);   // ì¤‘ê°„ ì €ì¥ rollback
      errors.push(f.name + ' â€” ' + (err.name === 'QuotaExceededError' ? 'ì €ì¥ ê³µê°„ ì´ˆê³¼' : err.message));
    }
  }

  if (saved.length) saveMeta(meta);

  pendingFiles = [];
  document.getElementById('fmgmtPendingArea').style.display = 'none';
  document.getElementById('fmgmtFileInput').value = '';
  renderFmgmtList();
  renderStorageBar();
  updateDoorayBar();

  if (errors.length) {
    alert('ì¼ë¶€ íŒŒì¼ ì €ì¥ ì‹¤íŒ¨:\n' + errors.join('\n'));
  } else if (saved.length) {
    // ì„±ê³µ í† ìŠ¤íŠ¸
    showToast('âœ… ' + saved.length + 'ê°œ íŒŒì¼ ì €ì¥ ì™„ë£Œ', 'success');
  }
}

// íŒŒì¼ êµ¬ë¶„ ë³€ê²½ (ì €ì¥ëœ íŒŒì¼)
function changeFileType(id, newType) {
  const meta = loadMeta();
  const f = meta.find(m => m.id === id);
  if (f) { f.type = newType; saveMeta(meta); }
}

// íŒŒì¼ ì‚­ì œ
function deleteResFile(id) {
  if (!confirm('íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œëœ íŒŒì¼ì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
  const meta = loadMeta().filter(f => f.id !== id);
  saveMeta(meta);
  deleteFileData(id);
  renderFmgmtList();
  renderStorageBar();
  updateDoorayBar();
}

function renderFmgmtList() {
  const meta = loadMeta();
  const el   = document.getElementById('fmgmtList');
  if (!meta.length) {
    el.innerHTML = '<div style="text-align:center;color:var(--text-dim);font-size:12px;padding:28px">ì—…ë¡œë“œëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤</div>';
    return;
  }
  el.innerHTML = meta.map(f => {
    const ft  = FILE_TYPES[f.type] || FILE_TYPES.other;
    const sz  = f.size ? formatSize(f.size) : '';
    const dt  = f.addedAt ? new Date(f.addedAt).toLocaleDateString('ko-KR') : '';
    return '<div class="fmgmt-item">'
      + '<div><div class="fmgmt-name" title="' + esc(f.name) + '">' + ft.icon + ' ' + esc(f.name) + '</div>'
      + '<div style="font-size:10px;color:var(--text-dim);margin-top:2px">' + esc(sz) + (sz && dt ? ' Â· ' : '') + esc(dt) + '</div></div>'
      + '<select onchange="changeFileType(\'' + esc(f.id) + '\',this.value)" style="padding:5px 8px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:11px;font-family:\'Noto Sans KR\',sans-serif;outline:none">'
      + Object.entries(FILE_TYPES).map(([k,v]) =>
          '<option value="' + k + '"' + (f.type===k?' selected':'') + '>' + v.label + '</option>'
        ).join('')
      + '</select>'
      + '<span style="font-size:10px;color:var(--text-dim);white-space:nowrap">' + esc(sz) + '</span>'
      + '<button class="btn-del-file" onclick="deleteResFile(\'' + esc(f.id) + '\')" title="ì‚­ì œ">âœ•</button>'
      + '</div>';
  }).join('');
}

function renderStorageBar() {
  const used   = calcStorageUsed();
  const maxBytes = 5 * 1024 * 1024; // 5MB ê¸°ì¤€
  const pct    = Math.min(100, Math.round(used / maxBytes * 100));
  const cls    = pct > 85 ? 'danger' : pct > 65 ? 'warn' : '';
  document.getElementById('fmgmtStorageBar').innerHTML =
    '<div class="storage-bar-wrap">'
    + '<span>ì €ì¥ì†Œ</span>'
    + '<div class="storage-bar-track"><div class="storage-bar-fill ' + cls + '" style="width:' + pct + '%"></div></div>'
    + '<span>' + formatSize(used) + ' / ~5MB</span>'
    + '</div>';
}

// â”€â”€ í† ìŠ¤íŠ¸ ì•Œë¦¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg, type) {
  const t = document.createElement('div');
  const color = type === 'success' ? 'var(--success)' : type === 'warn' ? 'var(--warn)' : 'var(--accent)';
  t.style.cssText = 'position:fixed;bottom:28px;left:50%;transform:translateX(-50%);'
    + 'background:var(--surface);border:1px solid ' + color + ';border-radius:10px;'
    + 'padding:12px 22px;z-index:9999;box-shadow:0 6px 24px rgba(0,0,0,0.45);'
    + 'font-size:12px;font-weight:600;color:' + color + ';white-space:nowrap;';
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 3000);
}

// â”€â”€ ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ë‹«ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('filePickerModal').addEventListener('click', function(e){ if(e.target===this) closeFilePicker(); });
document.getElementById('fileMgmtModal').addEventListener('click',   function(e){ if(e.target===this) closeFileMgmt(); });
</script>



<script>
// â”€â”€ Shared Utils (must be first) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// â”€â”€ Auth & User Management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const STORAGE_KEY = 'cc_ipark_users';

// ê¸°ë³¸ ê³„ì • â€” localStorageì— ë°ì´í„°ê°€ ì—†ì„ ë•Œ í•œ ë²ˆë§Œ ì‚¬ìš©
const DEFAULT_USERS = [
  { id: 'master', name: 'ê´€ë¦¬ì', pw: 'master1234', role: 'master', active: true },
  { id: 'user1',  name: 'í™ê¸¸ë™', pw: 'user1234',   role: 'user',   active: true }
];

function loadUsers() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) return JSON.parse(raw);
  } catch(e) {}
  // ìµœì´ˆ ì‹¤í–‰ ì‹œ ê¸°ë³¸ê°’ì„ ì €ì¥í•˜ê³  ë°˜í™˜
  saveUsers(DEFAULT_USERS);
  return JSON.parse(JSON.stringify(DEFAULT_USERS));
}

function saveUsers(users) {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(users));
  } catch(e) {
    alert('ì €ì¥ ì‹¤íŒ¨: ' + e.message);
  }
}

/** saveUsers ë˜í¼ â€” ì„¸ì…˜ ë‚´ currentUser ë¹„ë°€ë²ˆí˜¸ë„ ë™ê¸°í™” */
function persistUsers(users) {
  saveUsers(users);
  // í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ì ì •ë³´ë¥¼ ìµœì‹ ìœ¼ë¡œ ê°±ì‹ 
  if (currentUser) {
    const updated = users.find(u => u.id === currentUser.id);
    if (updated) currentUser = updated;
  }
}

function doLogin() {
  const id = document.getElementById('loginId').value.trim();
  const pw = document.getElementById('loginPw').value;
  const errEl = document.getElementById('loginError');
  errEl.textContent = '';

  if (!id || !pw) { errEl.textContent = 'ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'; return; }

  const users = loadUsers();
  const user = users.find(u => u.id === id && u.pw === pw);

  if (!user) { errEl.textContent = 'ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'; return; }
  if (!user.active) { errEl.textContent = 'ë¹„í™œì„±í™”ëœ ê³„ì •ì…ë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.'; return; }

  currentUser = user;
  document.getElementById('loginOverlay').style.display = 'none';
  renderHeaderUser();
  updateDoorayBar();   // ë‘ë ˆì´ ë°” ê¶Œí•œ ê°±ì‹ 
}

function doLogout() {
  currentUser = null;
  document.getElementById('loginId').value = '';
  document.getElementById('loginPw').value = '';
  document.getElementById('loginError').textContent = '';
  document.getElementById('loginOverlay').style.display = 'flex';
  document.getElementById('headerUser').innerHTML = '';
  document.getElementById('btnFileMgmt').style.display = 'none';
  resetAll();
}

function renderHeaderUser() {
  const el = document.getElementById('headerUser');
  const roleLabel = currentUser.role === 'master' ? 'ğŸ”‘ ë§ˆìŠ¤í„°' : 'ğŸ‘¤ ì‚¬ìš©ì';
  el.innerHTML = `
    <div class="user-badge">
      <div class="user-dot"></div>
      <span>${esc(currentUser.name)} <span style="color:var(--text-dim);font-size:10px">(${esc(currentUser.id)})</span></span>
      <span style="font-size:10px;color:${currentUser.role==='master'?'var(--warn)':'var(--accent)'};font-weight:700">${roleLabel}</span>
    </div>
    ${currentUser.role === 'master' ? `<button class="btn-user-mgmt" onclick="openMgmt()">ğŸ‘¥ ì‚¬ìš©ì ê´€ë¦¬</button>` : ''}
    <button class="btn-chgpw" onclick="openChgPw()">ğŸ” ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
    <button class="btn-logout" onclick="doLogout()">ë¡œê·¸ì•„ì›ƒ</button>
  `;
}

// â”€â”€ User Management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openMgmt() {
  renderUserList();
  document.getElementById('userMgmtModal').classList.add('open');
}

function closeMgmt() {
  document.getElementById('userMgmtModal').classList.remove('open');
  document.getElementById('newUserId').value = '';
  document.getElementById('newUserName').value = '';
  document.getElementById('newUserPw').value = '';
}

function renderUserList() {
  const users = loadUsers();
  const el = document.getElementById('userList');
  if (!users.length) {
    el.innerHTML = '<div style="text-align:center;color:var(--text-dim);font-size:12px;padding:24px">ë“±ë¡ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤</div>';
    return;
  }
  el.innerHTML = users.map((u, i) => `
    <div class="user-item">
      <span class="u-role ${u.role === 'master' ? 'role-master' : 'role-user'}">${esc(u.role === 'master' ? 'ë§ˆìŠ¤í„°' : 'ì‚¬ìš©ì')}</span>
      <span class="u-id">${esc(u.id)}</span>
      <span class="u-name">${esc(u.name)}</span>
      <span class="u-status ${u.active ? 's-active' : 's-inactive'}">${u.active ? 'â— í™œì„±' : 'â—‹ ë¹„í™œì„±'}</span>
      ${u.role !== 'master' ? `
        <span></span>
        <button class="btn-toggle-status" data-action="toggle" data-idx="${i}">${u.active ? 'ë¹„í™œì„±í™”' : 'í™œì„±í™”'}</button>
        <button class="btn-del-user"      data-action="delete" data-idx="${i}">ì‚­ì œ</button>
      ` : `<span></span><span></span><span class="mgmt-protected">ğŸ”’ ë³´í˜¸ë¨</span>`}
    </div>
  `).join('');
}

// userList ì´ë²¤íŠ¸ ìœ„ì„ â€” ë²„íŠ¼ í´ë¦­ì„ í•œ ê³³ì—ì„œ ì²˜ë¦¬
document.getElementById('userList').addEventListener('click', function(e) {
  const btn = e.target.closest('[data-action]');
  if (!btn) return;
  const idx    = parseInt(btn.dataset.idx, 10);
  const action = btn.dataset.action;
  if (action === 'toggle') toggleUser(idx);
  if (action === 'delete') deleteUser(idx);
});

function addUser() {
  const id   = document.getElementById('newUserId').value.trim();
  const name = document.getElementById('newUserName').value.trim();
  const pw   = document.getElementById('newUserPw').value;

  if (!id || !name || !pw) { alert('ì•„ì´ë””, ì´ë¦„, ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.'); return; }

  const users = loadUsers();
  if (users.find(u => u.id === id)) { alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤.'); return; }

  users.push({ id, name, pw, role: 'user', active: true });
  persistUsers(users);
  document.getElementById('newUserId').value = '';
  document.getElementById('newUserName').value = '';
  document.getElementById('newUserPw').value = '';
  renderUserList();
}

function toggleUser(i) {
  const users = loadUsers();
  if (users[i].role === 'master') return;
  users[i].active = !users[i].active;
  persistUsers(users);
  renderUserList();
}

function deleteUser(i) {
  const users = loadUsers();
  if (users[i].role === 'master') return;
  if (!confirm(`'${users[i].name}(${users[i].id})' ê³„ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
  users.splice(i, 1);
  persistUsers(users);
  renderUserList();
}

// ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
document.getElementById('userMgmtModal').addEventListener('click', function(e) {
  if (e.target === this) closeMgmt();
});
document.getElementById('chgPwModal').addEventListener('click', function(e) {
  if (e.target === this) closeChgPw();
});

// â”€â”€ Change Password â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let chgPwTab = 'self'; // 'self' | 'other'

function openChgPw() {
  chgPwTab = 'self';
  const isMaster = currentUser.role === 'master';

  // ë§ˆìŠ¤í„° íƒ­ í‘œì‹œ
  document.getElementById('chgpwTabRow').style.display = isMaster ? 'flex' : 'none';
  document.getElementById('tabSelf').className  = 'chgpw-tab active-self';
  document.getElementById('tabOther').className = 'chgpw-tab';
  document.getElementById('chgpwTargetRow').style.display = 'none';

  // í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ í•„ë“œ í‘œì‹œ
  document.getElementById('chgpwCurRow').style.display = 'block';

  // ê³„ì • ì •ë³´ í‘œì‹œ
  document.getElementById('chgpwWho').textContent = `${currentUser.name}  (${currentUser.id})  Â·  ${currentUser.role === 'master' ? 'ë§ˆìŠ¤í„°' : 'ì‚¬ìš©ì'}`;

  // ì…ë ¥ ì´ˆê¸°í™”
  ['chgpwCur','chgpwNew','chgpwConfirm'].forEach(id => {
    const el = document.getElementById(id);
    el.value = ''; el.className = '';
  });
  document.getElementById('chgpwError').textContent = '';
  document.getElementById('chgpwSuccess').style.display = 'none';
  document.getElementById('pwStrBar').style.cssText = 'width:0';
  document.getElementById('pwStrLabel').textContent = '';
  document.getElementById('btnSavePw').disabled = false;

  document.getElementById('chgPwModal').classList.add('open');
  setTimeout(() => document.getElementById('chgpwCur').focus(), 80);
}

function closeChgPw() {
  document.getElementById('chgPwModal').classList.remove('open');
}

function switchChgPwTab(tab) {
  chgPwTab = tab;
  document.getElementById('tabSelf').className  = tab === 'self'  ? 'chgpw-tab active-self'  : 'chgpw-tab';
  document.getElementById('tabOther').className = tab === 'other' ? 'chgpw-tab active-other' : 'chgpw-tab';

  // ì…ë ¥ ì´ˆê¸°í™”
  ['chgpwCur','chgpwNew','chgpwConfirm'].forEach(id => {
    const el = document.getElementById(id); el.value = ''; el.className = '';
  });
  document.getElementById('chgpwError').textContent = '';
  document.getElementById('chgpwSuccess').style.display = 'none';
  document.getElementById('pwStrBar').style.cssText = 'width:0';
  document.getElementById('pwStrLabel').textContent = '';

  if (tab === 'self') {
    document.getElementById('chgpwTargetRow').style.display = 'none';
    document.getElementById('chgpwCurRow').style.display = 'block';
    document.getElementById('chgpwWho').textContent = `${currentUser.name}  (${currentUser.id})  Â·  ë§ˆìŠ¤í„°`;
  } else {
    // íƒ€ ì‚¬ìš©ì ëª©ë¡ ì±„ìš°ê¸°
    const users = loadUsers().filter(u => u.role !== 'master');
    const sel = document.getElementById('chgpwTargetSel');
    sel.innerHTML = users.length
      ? users.map(u => `<option value="${esc(u.id)}">${esc(u.name)} (${esc(u.id)})</option>`).join('')
      : '<option value="">â€” ì‚¬ìš©ì ì—†ìŒ â€”</option>';
    document.getElementById('chgpwTargetRow').style.display = 'flex';
    // ë§ˆìŠ¤í„°ê°€ íƒ€ ì‚¬ìš©ì ë³€ê²½ ì‹œ í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ ë¶ˆí•„ìš”
    document.getElementById('chgpwCurRow').style.display = 'none';
    onTargetChange();
  }
}

function onTargetChange() {
  const sel = document.getElementById('chgpwTargetSel');
  const uid = sel.value;
  const users = loadUsers();
  const u = users.find(x => x.id === uid);
  document.getElementById('chgpwWho').textContent = u
    ? `${u.name}  (${u.id})  Â·  ${u.active ? 'í™œì„±' : 'ë¹„í™œì„±'}`
    : 'â€”';
}

function pwStrength(pw) {
  if (!pw) return { score: 0, label: '', color: '' };
  let s = 0;
  if (pw.length >= 6)  s++;
  if (pw.length >= 10) s++;
  if (/[A-Z]/.test(pw)) s++;
  if (/[0-9]/.test(pw)) s++;
  if (/[^A-Za-z0-9]/.test(pw)) s++;
  if (s <= 1) return { score: 20,  label: 'ë§¤ìš° ì•½í•¨', color: 'var(--danger)' };
  if (s === 2) return { score: 40,  label: 'ì•½í•¨',     color: 'var(--warn)' };
  if (s === 3) return { score: 65,  label: 'ë³´í†µ',     color: '#eab308' };
  if (s === 4) return { score: 85,  label: 'ê°•í•¨',     color: 'var(--success)' };
  return                { score: 100, label: 'ë§¤ìš° ê°•í•¨', color: 'var(--accent2)' };
}

function onChgPwInput() {
  const newPw = document.getElementById('chgpwNew').value;
  const confirm = document.getElementById('chgpwConfirm');

  // ê°•ë„ í‘œì‹œ
  const str = pwStrength(newPw);
  const bar = document.getElementById('pwStrBar');
  bar.style.width = str.score + '%';
  bar.style.background = str.color || 'transparent';
  document.getElementById('pwStrLabel').textContent = str.label;
  document.getElementById('pwStrLabel').style.color = str.color;

  // í™•ì¸ í•„ë“œ ìƒ‰ìƒ
  if (confirm.value) {
    confirm.className = confirm.value === newPw ? 'input-ok' : 'input-err';
  } else {
    confirm.className = '';
  }

  document.getElementById('chgpwError').textContent = '';
  document.getElementById('chgpwSuccess').style.display = 'none';
}

function saveChgPw() {
  const errEl = document.getElementById('chgpwError');
  const sucEl = document.getElementById('chgpwSuccess');
  errEl.textContent = ''; sucEl.style.display = 'none';

  const newPw     = document.getElementById('chgpwNew').value;
  const confirmPw = document.getElementById('chgpwConfirm').value;

  if (newPw.length < 6) { errEl.textContent = 'ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.'; return; }
  if (newPw !== confirmPw) { errEl.textContent = 'ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'; return; }

  const users = loadUsers();

  if (chgPwTab === 'self' || currentUser.role !== 'master') {
    // ìì‹ ì˜ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ â†’ í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ í•„ìš”
    const curPw = document.getElementById('chgpwCur').value;
    if (!curPw) { errEl.textContent = 'í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'; return; }
    const idx = users.findIndex(u => u.id === currentUser.id);
    if (idx < 0 || users[idx].pw !== curPw) { errEl.textContent = 'í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'; return; }
    if (curPw === newPw) { errEl.textContent = 'ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ì™€ ë™ì¼í•©ë‹ˆë‹¤.'; return; }
    users[idx].pw = newPw;
    currentUser.pw = newPw;
  } else {
    // ë§ˆìŠ¤í„°ê°€ íƒ€ ì‚¬ìš©ì ë³€ê²½
    const targetId = document.getElementById('chgpwTargetSel').value;
    if (!targetId) { errEl.textContent = 'ëŒ€ìƒ ì‚¬ìš©ìë¥¼ ì„ íƒí•˜ì„¸ìš”.'; return; }
    const idx = users.findIndex(u => u.id === targetId);
    if (idx < 0) { errEl.textContent = 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'; return; }
    users[idx].pw = newPw;
  }

  persistUsers(users);

  // ì„±ê³µ UI
  sucEl.style.display = 'block';
  document.getElementById('btnSavePw').disabled = true;
  ['chgpwCur','chgpwNew','chgpwConfirm'].forEach(id => {
    document.getElementById(id).value = '';
    document.getElementById(id).className = '';
  });
  document.getElementById('pwStrBar').style.cssText = 'width:0';
  document.getElementById('pwStrLabel').textContent = '';

  setTimeout(closeChgPw, 1800);
}
</script>
<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const wbs = [null,null,null,null];
const dotCls = ['c-blue','c-green','c-warn','c-purple'];

let codeRes = [];
let stdRes  = [];
let curTab  = '';
let curFilter = 'all';
let curSearch = '';

// â”€â”€ File Drop Setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[0,1,2,3].forEach(i => {
  const inp  = document.getElementById('file'+i);
  const card = document.getElementById('drop'+i);
  const fnEl = document.getElementById('fn'+i);

  inp.addEventListener('change', e => { if(e.target.files[0]) loadWb(e.target.files[0],i,fnEl,card); });
  card.addEventListener('dragover', e => { e.preventDefault(); card.classList.add('drag-over'); });
  card.addEventListener('dragleave', () => card.classList.remove('drag-over'));
  card.addEventListener('drop', e => {
    e.preventDefault(); card.classList.remove('drag-over');
    if(e.dataTransfer.files[0]) loadWb(e.dataTransfer.files[0],i,fnEl,card);
  });
});

function loadWb(file, i, fnEl, card) {
  fnEl.textContent = 'ë¡œë”© ì¤‘...'; fnEl.className = 'uc-fn';
  const r = new FileReader();
  r.onload = e => {
    try {
      wbs[i] = XLSX.read(e.target.result, {type:'array'});
      fnEl.textContent = 'âœ“ '+file.name; fnEl.className = 'uc-fn ok';
      card.classList.add('loaded', dotCls[i]);
    } catch(err) { fnEl.textContent = 'âŒ '+err.message; }
    updateBtns();
  };
  r.readAsArrayBuffer(file);
}

function updateBtns() {
  document.getElementById('btnCode').disabled = !(wbs[0] && (wbs[1]||wbs[2]));
  document.getElementById('btnStd').disabled  = !(wbs[0] && wbs[3]);
}

// â”€â”€ Excel Utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function normH(s)    { return String(s||'').replace(/\s/g,''); }
function normSpec(s) { return String(s||'').replace(/\s/g,''); }

function sheetRows(wb, sn) {
  const sh = wb.Sheets[sn]; if(!sh) return null;
  return XLSX.utils.sheet_to_json(sh, {header:1, defval:''});
}

function findHdrRow(rows) {
  for(let i=0;i<Math.min(10,rows.length);i++)
    if(rows[i].some(c=>normH(c)==='ì½”ë“œ')) return i;
  return 2;
}

function colIdx(hdr) {
  return {
    ci: hdr.findIndex(c=>normH(c)==='ì½”ë“œ'),
    ni: hdr.findIndex(c=>normH(c)==='í’ˆëª…'),
    si: hdr.findIndex(c=>normH(c)==='ê·œê²©'),
    ui: hdr.findIndex(c=>normH(c)==='ë‹¨ìœ„'),
  };
}

// Build codeâ†’{name,spec,unit,src} map from a workbook
// preferSheets: try these first, then rest of SheetNames
function buildMap(wb, preferSheets) {
  const map = new Map();
  const tried = new Set();
  for(const sn of [...preferSheets, ...wb.SheetNames]) {
    if(tried.has(sn)) continue; tried.add(sn);
    const rows = sheetRows(wb, sn); if(!rows) continue;
    const hr = findHdrRow(rows);
    const {ci,ni,si,ui} = colIdx(rows[hr]);
    if(ci<0) continue;
    for(let r=hr+1; r<rows.length; r++) {
      const code = String(rows[r][ci]||'').trim();
      if(!code || /^[0-9]{1,2}$/.test(code)) continue;
      if(!map.has(code)) map.set(code, {
        name: ni>=0 ? String(rows[r][ni]||'').trim() : '',
        spec: si>=0 ? String(rows[r][si]||'').trim() : '',
        unit: ui>=0 ? String(rows[r][ui]||'').trim() : '',
        src:  sn,
      });
    }
  }
  return map;
}

// Parse ì›ë‚´ì—­ â†’ array of items
function parseSource(wb) {
  const snPri = ['ì›ë‚´ì—­','ë‚´ì—­','Sheet1'];
  const sn = snPri.find(s=>wb.SheetNames.includes(s)) || wb.SheetNames[0];
  const rows = sheetRows(wb, sn);
  if(!rows) throw new Error('ì›ë‚´ì—­ ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
  const hr = findHdrRow(rows);
  const {ci,ni,si,ui} = colIdx(rows[hr]);
  const out = [];
  for(let r=hr+1; r<rows.length; r++) {
    const code = String(rows[r][ci]||'').trim();
    if(!code) continue;
    if(/^[0-9]{1,2}$/.test(code)) {
      out.push({isSection:true, code, name:String(rows[r][ni]||'').trim()});
      continue;
    }
    out.push({
      isSection:false, row:r+1, code,
      name: ni>=0 ? String(rows[r][ni]||'').trim() : '',
      spec: si>=0 ? String(rows[r][si]||'').trim() : '',
      unit: ui>=0 ? String(rows[r][ui]||'').trim() : '',
    });
  }
  return out;
}

// â”€â”€ CODE CHECK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function runCodeCheck() {
  loading();
  setTimeout(()=>{
    try {
      // DB: ìì¬ë¦¬ìŠ¤íŠ¸(wbs[1]) + ì¼ìœ„ëŒ€ê°€ë¦¬ìŠ¤íŠ¸(wbs[2]) ë§Œ ì‚¬ìš©
      const dbMap = new Map();
      if(wbs[1]) buildMap(wbs[1],['ìì¬ë¦¬ìŠ¤íŠ¸']).forEach((v,k)=>{ if(!dbMap.has(k)) dbMap.set(k,v); });
      if(wbs[2]) buildMap(wbs[2],['ì¼ìœ„ëŒ€ê°€ë¦¬ìŠ¤íŠ¸']).forEach((v,k)=>{ if(!dbMap.has(k)) dbMap.set(k,v); });

      const items = parseSource(wbs[0]);
      codeRes = items.map(item=>{
        if(item.isSection) return item;
        const db = dbMap.get(item.code);
        if(!db) return {...item, status:'miss', db:null};

        const sS=normSpec(item.spec), dS=normSpec(db.spec);
        const sU=item.unit.trim(),    dU=(db.unit||'').trim();
        const sN=item.name.trim(),    dN=(db.name||'').trim();

        const sdiff = dS!==sS && (dS||sS);
        const udiff = dU!==sU && (dU||sU);
        const ndiff = dN!==sN && (dN||sN);

        return {...item, status:(sdiff||udiff||ndiff)?'diff':'ok', db, sdiff, udiff, ndiff};
      });

      curTab='code'; curFilter='all'; curSearch='';
      renderCode();
      showTabs();
      document.getElementById('btnExport').disabled=false;
    } catch(e){ errMsg(e.message); }
  },30);
}

function renderCode() {
  const f=curFilter, q=curSearch;
  const visible = codeRes.filter(r=>{
    if(r.isSection) return f==='all' && !q;
    if(q && !r.code.toLowerCase().includes(q) && !r.name.toLowerCase().includes(q)) return false;
    if(f==='all') return true;
    return r.status===f;
  });

  const items = codeRes.filter(r=>!r.isSection);
  const N  = items.length;
  const ok = items.filter(r=>r.status==='ok').length;
  const df = items.filter(r=>r.status==='diff').length;
  const ms = items.filter(r=>r.status==='miss').length;
  const nc = items.filter(r=>r.status==='nocode').length;

  setStats(`
    <div class="stats-bar">
      <div class="stat-card"><div class="stat-label">ì „ì²´</div><div class="stat-val v-blue">${N}</div></div>
      <div class="stat-card"><div class="stat-label">âœ… ì¼ì¹˜</div><div class="stat-val v-green">${ok}</div></div>
      <div class="stat-card"><div class="stat-label">âš  ì½”ë“œìƒì´</div><div class="stat-val v-yellow">${df}</div></div>
      <div class="stat-card"><div class="stat-label">âŒ DBì—†ìŒ</div><div class="stat-val v-red">${ms}</div></div>
      ${nc>0?`<div class="stat-card"><div class="stat-label">â€” ë¯¸í™•ì¸</div><div class="stat-val v-cyan">${nc}</div></div>`:''}
    </div>`);

  setFilter(`
    <button class="fbtn ${f==='all'?'fa-all':''}"    onclick="sf('all','code')">ì „ì²´ ${N}</button>
    <button class="fbtn ${f==='ok'?'fa-ok':''}"      onclick="sf('ok','code')">âœ… ì¼ì¹˜ ${ok}</button>
    <button class="fbtn ${f==='diff'?'fa-diff':''}"  onclick="sf('diff','code')">âš  ì½”ë“œìƒì´ ${df}</button>
    <button class="fbtn ${f==='miss'?'fa-miss':''}"  onclick="sf('miss','code')">âŒ DBì—†ìŒ ${ms}</button>
    ${nc>0?`<button class="fbtn ${f==='nocode'?'fa-nocode':''}" onclick="sf('nocode','code')">â€” ë¯¸í™•ì¸ ${nc}</button>`:''}
    <input class="search-input" id="si" placeholder="ì½”ë“œÂ·í’ˆëª… ê²€ìƒ‰..." value="${esc(q)}" oninput="ss(this.value,'code')">`);

  setHint('');

  if(!visible.length){ emptyMsg('ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ'); return; }

  let h=`<table><thead><tr>
    <th>í–‰</th><th>ì½”ë“œ</th><th>í’ˆëª… (ì›ë‚´ì—­)</th><th>ê·œê²© (ì›ë‚´ì—­)</th><th>ë‹¨ìœ„</th>
    <th>DB í’ˆëª…</th><th>DB ê·œê²©</th><th>DB ë‹¨ìœ„</th><th>ì¶œì²˜</th><th>ê²°ê³¼</th>
  </tr></thead><tbody>`;

  for(const r of visible){
    if(r.isSection){ h+=`<tr class="sec-row"><td colspan="10">â–¶ ${esc(r.name||r.code)}</td></tr>`; continue; }
    h+=`<tr>
      <td class="tr">${r.row}</td>
      <td class="tc">${esc(r.code)}</td>
      <td class="tn">${esc(r.name)}</td>
      <td class="ts">${esc(r.spec)}</td>
      <td class="tu">${esc(r.unit)}</td>
      <td class="ts ${r.ndiff?'hl':''}">${esc(r.db?.name||'')}</td>
      <td class="ts ${r.sdiff?'hl':''}">${esc(r.db?.spec||'')}</td>
      <td class="tu ${r.udiff?'hl':''}">${esc(r.db?.unit||'')}</td>
      <td class="ts" style="font-size:10px;color:var(--text-dim)">${esc(r.db?.src||'')}</td>
      <td>${codeBadge(r.status)}</td>
    </tr>`;
  }
  h+='</tbody></table>';
  document.getElementById('tableWrap').innerHTML=h;
}

function codeBadge(s){
  const m={ok:['bk','âœ“ ì¼ì¹˜'],diff:['bd','âš  ì½”ë“œìƒì´'],miss:['bm','âœ• DBì—†ìŒ'],nocode:['bn','â€” ë¯¸í™•ì¸']};
  const [c,l]=m[s]||['bn',s];
  return `<span class="badge ${c}">${l}</span>`;
}

// â”€â”€ STANDARD CHECK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function runStdCheck() {
  loading();
  setTimeout(()=>{
    try {
      // ì›ë‚´ì—­ ì „ì²´(ì„¹ì…˜ í¬í•¨) íŒŒì‹±
      const allSrc   = parseSource(wbs[0]);
      const wonItems = allSrc.filter(r=>!r.isSection);
      const wonCodes = new Set(wonItems.map(r=>r.code));

      // í‘œì¤€ë‚´ì—­ map
      const stdMap = buildMap(wbs[3], ['í‘œì¤€ë‚´ì—­']);

      // â”€â”€ ì›ë‚´ì—­ ê³µì¢… ì„¹ì…˜ êµ¬ì¡° íŒŒì•… â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const sections = [];
      let curSec = null;
      for(const item of allSrc){
        if(item.isSection){
          curSec = { secCode:item.code, secName:item.name, wonItems:[], stdOnlyItems:[] };
          sections.push(curSec);
        } else {
          if(!curSec){
            curSec = { secCode:'', secName:'ê³µì¢…ë¯¸ë¶„ë¥˜', wonItems:[], stdOnlyItems:[] };
            sections.push(curSec);
          }
          curSec.wonItems.push(item);
        }
      }

      // â”€â”€ í‘œì¤€ë‚´ì—­ ì½”ë“œì— ê³µì¢… ë°°ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // í‘œì¤€ë‚´ì—­ íŒŒì¼ ì„¹ì…˜ ë§µ ìƒì„± (ì½”ë“œ â†’ ì„¹ì…˜ì½”ë“œ)
      const stdSecMap = buildStdSectionMap(wbs[3]);

      // í‘œì¤€ë‚´ì—­ì—ë§Œ ìˆëŠ” í•­ëª© â†’ ì›ë‚´ì—­ ì„¹ì…˜ì— ë°°ì •
      stdMap.forEach((v, code)=>{
        if(wonCodes.has(code)) return;

        const stdSecCode = stdSecMap.get(code) || '';
        let targetSec = sections.find(s=>s.secCode === stdSecCode);

        if(!targetSec){
          if(!sections.find(s=>s.secCode==='__only2__')){
            sections.push({ secCode:'__only2__', secName:'í‘œì¤€ë‚´ì—­ì—ë§Œ ì¡´ì¬', wonItems:[], stdOnlyItems:[] });
          }
          targetSec = sections.find(s=>s.secCode==='__only2__');
        }
        targetSec.stdOnlyItems.push({
          isSection:false, code, name:v.name, spec:v.spec, unit:v.unit,
          status:'only2', si:v
        });
      });

      // â”€â”€ stdRes ì¡°ë¦½: ì›ë‚´ì—­ ê³µì¢… ìˆœì„œ ê·¸ëŒ€ë¡œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      stdRes = [];
      for(const sec of sections){
        const hasContent = sec.wonItems.length > 0 || sec.stdOnlyItems.length > 0;
        if(!hasContent) continue;

        // ì„¹ì…˜ í—¤ë”
        if(sec.secCode === '__only2__'){
          stdRes.push({ isSection:true, code:'', name:'ğŸ“ í‘œì¤€ë‚´ì—­ì—ë§Œ ì¡´ì¬í•˜ëŠ” í•­ëª©' });
        } else if(sec.secCode){
          stdRes.push({ isSection:true, code:sec.secCode, name:sec.secName });
        }

        // ì›ë‚´ì—­ í•­ëª© (ì›ë‚´ì—­ ìˆœì„œ ìœ ì§€)
        for(const item of sec.wonItems){
          if(stdMap.has(item.code)){
            stdRes.push({...item, status:'both', si:stdMap.get(item.code)});
          } else {
            stdRes.push({...item, status:'only1'});
          }
        }

        // í•´ë‹¹ ê³µì¢…ì˜ í‘œì¤€ë‚´ì—­ only í•­ëª©
        for(const item of sec.stdOnlyItems){
          stdRes.push(item);
        }
      }

      curTab='std'; curFilter='all'; curSearch='';
      renderStd();
      showTabs();
      document.getElementById('btnExport').disabled=false;
    } catch(e){ errMsg(e.message); }
  },30);
}

// í‘œì¤€ë‚´ì—­ íŒŒì¼ì—ì„œ ì½”ë“œâ†’ì„¹ì…˜ì½”ë“œ ë§¤í•‘ ìƒì„±
function buildStdSectionMap(wb){
  const map = new Map();
  const snList = ['í‘œì¤€ë‚´ì—­', ...wb.SheetNames];
  const tried = new Set();
  for(const sn of snList){
    if(tried.has(sn)) continue; tried.add(sn);
    const rows = sheetRows(wb, sn); if(!rows) continue;
    const hr = findHdrRow(rows);
    const {ci} = colIdx(rows[hr]);
    if(ci<0) continue;
    let curSec = '';
    for(let r=hr+1; r<rows.length; r++){
      const code = String(rows[r][ci]||'').trim();
      if(!code) continue;
      if(/^[0-9]{1,2}$/.test(code)){ curSec=code; continue; }
      map.set(code, curSec);
    }
    break;
  }
  return map;
}

function renderStd(){
  const f=curFilter, q=curSearch;
  const only1 = stdRes.filter(r=>!r.isSection && r.status==='only1');
  const only2 = stdRes.filter(r=>!r.isSection && r.status==='only2');
  const both  = stdRes.filter(r=>!r.isSection && r.status==='both');

  const visible = stdRes.filter(r=>{
    // ì„¹ì…˜ í—¤ë”: í•„í„°ê°€ allì´ê³  ê²€ìƒ‰ì–´ ì—†ì„ ë•Œ, ë˜ëŠ” í•´ë‹¹ ì„¹ì…˜ ì•„ë˜ visible í•­ëª©ì´ ìˆì„ ë•Œ í‘œì‹œ
    if(r.isSection){
      if(q) return false; // ê²€ìƒ‰ ì¤‘ì—” ì„¹ì…˜ ìˆ¨ê¹€
      if(f==='all') return true;
      // í•„í„° í™œì„± ì‹œ: í•´ë‹¹ ì„¹ì…˜ì½”ë“œ ì•„ë˜ì— visible í•­ëª©ì´ ìˆëŠ”ì§€ í™•ì¸
      const secIdx = stdRes.indexOf(r);
      for(let i=secIdx+1; i<stdRes.length; i++){
        if(stdRes[i].isSection) break;
        if(stdRes[i].status===f) return true;
      }
      return false;
    }
    if(q && !r.code.toLowerCase().includes(q) && !r.name.toLowerCase().includes(q)) return false;
    if(f==='all') return true;
    return r.status===f;
  });

  setStats(`
    <div class="stats-bar">
      <div class="stat-card"><div class="stat-label">ì›ë‚´ì—­ í•­ëª© ìˆ˜</div><div class="stat-val v-blue">${only1.length+both.length}</div></div>
      <div class="stat-card"><div class="stat-label">í‘œì¤€ë‚´ì—­ í•­ëª© ìˆ˜</div><div class="stat-val v-purple">${only2.length+both.length}</div></div>
      <div class="stat-card"><div class="stat-label">âš¡ ì›ë‚´ì—­ì—ë§Œ ì¡´ì¬</div><div class="stat-val v-blue">${only1.length}</div></div>
      <div class="stat-card"><div class="stat-label">ğŸ“ í‘œì¤€ë‚´ì—­ì—ë§Œ ì¡´ì¬</div><div class="stat-val v-purple">${only2.length}</div></div>
      <div class="stat-card"><div class="stat-label">âœ… ì–‘ìª½ ëª¨ë‘ ì¡´ì¬</div><div class="stat-val v-green">${both.length}</div></div>
    </div>`);

  setFilter(`
    <button class="fbtn ${f==='all'?'fa-all':''}"    onclick="sf('all','std')">ì „ì²´ ${stdRes.length}</button>
    <button class="fbtn ${f==='only1'?'fa-only1':''}" onclick="sf('only1','std')">âš¡ ì›ë‚´ì—­ë§Œ ${only1.length}</button>
    <button class="fbtn ${f==='only2'?'fa-only2':''}" onclick="sf('only2','std')">ğŸ“ í‘œì¤€ë‚´ì—­ë§Œ ${only2.length}</button>
    <button class="fbtn ${f==='both'?'fa-both':''}"   onclick="sf('both','std')">âœ… ì–‘ìª½ ëª¨ë‘ ${both.length}</button>
    <input class="search-input" id="si" placeholder="ì½”ë“œÂ·í’ˆëª… ê²€ìƒ‰..." value="${esc(q)}" oninput="ss(this.value,'std')">`);

  setHint(`
    <b>âš¡ ì›ë‚´ì—­ë§Œ ì¡´ì¬</b> (${only1.length}ê±´): ì›ë‚´ì—­ì—ëŠ” ìˆìœ¼ë‚˜ í‘œì¤€ë‚´ì—­ì— ì—†ëŠ” í•­ëª© &nbsp;|&nbsp;
    <b>ğŸ“ í‘œì¤€ë‚´ì—­ë§Œ ì¡´ì¬</b> (${only2.length}ê±´): í‘œì¤€ë‚´ì—­ì—ëŠ” ìˆìœ¼ë‚˜ ì›ë‚´ì—­ì— ì—†ëŠ” í•­ëª© &nbsp;|&nbsp;
    <b>âœ… ì–‘ìª½ ëª¨ë‘</b> (${both.length}ê±´): ë‘ ë‚´ì—­ ëª¨ë‘ì— ì½”ë“œ ì¡´ì¬`);

  if(!visible.length){ emptyMsg('ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ'); return; }

  let h=`<table><thead><tr>
    <th>êµ¬ë¶„</th>
    <th>ì½”ë“œ</th>
    <th>ì›ë‚´ì—­ í’ˆëª…</th><th>ì›ë‚´ì—­ ê·œê²©</th><th>ì›ë‚´ì—­ ë‹¨ìœ„</th>
    <th>í‘œì¤€ë‚´ì—­ í’ˆëª…</th><th>í‘œì¤€ë‚´ì—­ ê·œê²©</th><th>í‘œì¤€ë‚´ì—­ ë‹¨ìœ„</th>
  </tr></thead><tbody>`;

  for(const r of visible){
    // ì„¹ì…˜ í—¤ë” í–‰
    if(r.isSection){
      const secLabel = r.code ? `[${esc(r.code)}] ${esc(r.name||r.code)}` : esc(r.name||'');
      h+=`<tr class="sec-row"><td colspan="8">â–¶ ${secLabel}</td></tr>`;
      continue;
    }
    const si = r.si||{};
    const isOnly2 = r.status==='only2';

    const wName = isOnly2 ? `<span style="color:var(--text-dim)">â€”</span>` : esc(r.name);
    const wSpec = isOnly2 ? `<span style="color:var(--text-dim)">â€”</span>` : esc(r.spec);
    const wUnit = isOnly2 ? `<span style="color:var(--text-dim)">â€”</span>` : esc(r.unit);
    const sColor = isOnly2 ? 'color:var(--purple)' : 'color:var(--text-muted)';

    h+=`<tr>
      <td>${stdBadge(r.status)}</td>
      <td class="tc">${esc(r.code)}</td>
      <td class="tn">${wName}</td>
      <td class="ts">${wSpec}</td>
      <td class="tu">${wUnit}</td>
      <td class="ts" style="${sColor}">${esc(si.name||'')}</td>
      <td class="ts" style="${sColor}">${esc(si.spec||'')}</td>
      <td class="tu" style="${sColor}">${esc(si.unit||'')}</td>
    </tr>`;
  }
  h+='</tbody></table>';
  document.getElementById('tableWrap').innerHTML=h;
}

function stdBadge(s){
  const m={only1:['b1','âš¡ ì›ë‚´ì—­ë§Œ'],only2:['b2','ğŸ“ í‘œì¤€ë‚´ì—­ë§Œ'],both:['bb','âœ… ì–‘ìª½']};
  const [c,l]=m[s]||['bn',s];
  return `<span class="badge ${c}">${l}</span>`;
}

// â”€â”€ Tabs / Filter / Search â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showTabs(){
  document.getElementById('modeTabs').style.display='flex';
  document.getElementById('tabCode').className = 'mode-tab'+(curTab==='code'?' tab-blue':'');
  document.getElementById('tabStd').className  = 'mode-tab'+(curTab==='std'?' tab-purple':'');
}

function switchTab(tab){
  curTab=tab; curFilter='all'; curSearch='';
  showTabs();
  if(tab==='code' && codeRes.length) renderCode();
  else if(tab==='std' && stdRes.length) renderStd();
}

function sf(f, mode){ curFilter=f; mode==='code'?renderCode():renderStd(); }
function ss(v, mode){ curSearch=v.toLowerCase(); mode==='code'?renderCode():renderStd(); }

// â”€â”€ Export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportResult(){
  const wb = XLSX.utils.book_new();

  if(codeRes.length){
    const rows=[['í–‰','ì½”ë“œ','í’ˆëª…','ê·œê²©','ë‹¨ìœ„','DB í’ˆëª…','DB ê·œê²©','DB ë‹¨ìœ„','ì¶œì²˜','ê²°ê³¼']];
    const lbl={ok:'ì¼ì¹˜',diff:'ì½”ë“œìƒì´',miss:'í˜„ì¥ì½”ë“œ(DBì—†ìŒ)',nocode:'ë¯¸í™•ì¸'};
    for(const r of codeRes){
      if(r.isSection){ rows.push([`â–¶ ${r.name||r.code}`,'','','','','','','','','']); continue; }
      rows.push([r.row,r.code,r.name,r.spec,r.unit,r.db?.name||'',r.db?.spec||'',r.db?.unit||'',r.db?.src||'',lbl[r.status]||r.status]);
    }
    const ws=XLSX.utils.aoa_to_sheet(rows);
    ws['!cols']=[5,14,22,24,6,22,24,6,12,12].map(w=>({wch:w}));
    XLSX.utils.book_append_sheet(wb,ws,'ì½”ë“œê²€í† ê²°ê³¼');
  }

  if(stdRes.length){
    const rows=[['êµ¬ë¶„','ì½”ë“œ','ì›ë‚´ì—­ í’ˆëª…','ì›ë‚´ì—­ ê·œê²©','ì›ë‚´ì—­ ë‹¨ìœ„','í‘œì¤€ë‚´ì—­ í’ˆëª…','í‘œì¤€ë‚´ì—­ ê·œê²©','í‘œì¤€ë‚´ì—­ ë‹¨ìœ„']];
    const lbl={only1:'ì›ë‚´ì—­ë§Œ',only2:'í‘œì¤€ë‚´ì—­ë§Œ',both:'ì–‘ìª½ëª¨ë‘'};
    for(const r of stdRes){
      if(r.isSection){ rows.push([`â–¶ ${r.code?'['+r.code+'] ':''}${r.name||''}`,'','','','','','','']); continue; }
      const si=r.si||{};
      rows.push([lbl[r.status]||r.status,r.code,r.name||'',r.spec||'',r.unit||'',si.name||'',si.spec||'',si.unit||'']);
    }
    const ws=XLSX.utils.aoa_to_sheet(rows);
    ws['!cols']=[12,14,22,24,6,22,24,6].map(w=>({wch:w}));
    XLSX.utils.book_append_sheet(wb,ws,'í‘œì¤€ë‚´ì—­ë¹„êµê²°ê³¼');
  }

  if(!wb.SheetNames.length){ alert('ë‚´ë³´ë‚¼ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤'); return; }
  XLSX.writeFile(wb, `ì½”ë“œì²´í¬ê²°ê³¼_${new Date().toISOString().slice(0,10)}.xlsx`);
}

// â”€â”€ Reset â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resetAll(){
  [0,1,2,3].forEach(i=>{
    wbs[i]=null;
    document.getElementById('fn'+i).textContent='íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜ ë“œë¡­í•˜ì„¸ìš”';
    document.getElementById('fn'+i).className='uc-fn';
    const c=document.getElementById('drop'+i);
    c.classList.remove('loaded','c-blue','c-green','c-warn','c-purple');
    document.getElementById('file'+i).value='';
  });
  codeRes=[]; stdRes=[]; curTab=''; curFilter='all'; curSearch='';
  updateBtns();
  document.getElementById('btnExport').disabled=true;
  document.getElementById('modeTabs').style.display='none';
  setStats(''); setFilter(''); setHint('');
  document.getElementById('tableWrap').innerHTML=
    `<div class="empty"><div class="ico">ğŸ“‹</div><p>ì›ë‚´ì—­ + ìì¬ë¦¬ìŠ¤íŠ¸/ì¼ìœ„ëŒ€ê°€ë¦¬ìŠ¤íŠ¸ë¥¼ ì—…ë¡œë“œ í›„<br><b>ì½”ë“œ ê²€í†  ì‹¤í–‰</b> í´ë¦­<br><br>í‘œì¤€ë‚´ì—­ í•­ëª© ë¹„êµëŠ” í‘œì¤€ë‚´ì—­ë„ ì—…ë¡œë“œ í›„<br><b>í‘œì¤€ë‚´ì—­ ë¹„êµ</b> í´ë¦­</p></div>`;
}

// â”€â”€ DOM helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loading(){ document.getElementById('tableWrap').innerHTML='<div class="loading"><div class="spin"></div>ë¶„ì„ ì¤‘...</div>'; setStats(''); setFilter(''); setHint(''); }
function errMsg(m){ document.getElementById('tableWrap').innerHTML=`<div class="empty"><div class="ico">âŒ</div><p>ì˜¤ë¥˜: ${esc(m)}</p></div>`; }
function emptyMsg(m){ document.getElementById('tableWrap').innerHTML=`<div class="empty"><div class="ico">ğŸ”</div><p>${m}</p></div>`; }
function setStats(h){ document.getElementById('statsArea').innerHTML=h; }
function setFilter(h){ document.getElementById('filterArea').innerHTML=h; }
function setHint(h){
  const el=document.getElementById('hintArea');
  if(h){ el.className='hint-box'; el.innerHTML=h; }
  else { el.className=''; el.innerHTML=''; }
}
</script>
</body>
</html>
